<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Warsztatu • Warsztat+</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/panel-warsztatu.css"> <!-- Nowy plik CSS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="icon" href="data:,">
</head>
<body>

  <nav class="sidebar">
    <h2>Warsztat+</h2>
    <a data-target="dodaj" class="active"><i class="fas fa-plus-circle"></i> <span>Dodaj raport</span></a>
    <a data-target="moje"><i class="fas fa-list"></i> <span>Moje raporty</span></a>
    <a data-target="czesci"><i class="fas fa-tools"></i> <span>Zamów części</span></a>
    <a data-target="finanse"><i class="fas fa-file-invoice-dollar"></i> <span>Faktury</span></a>
    <a data-target="dane"><i class="fas fa-user-cog"></i> <span>Moje dane</span></a>
    <div style="margin-top: auto; padding: 1rem; width: 100%;">
      <div id="workshop-name" style="font-weight:600; font-size:0.9rem; margin-bottom:0.5rem;">Ładowanie...</div>
      <button id="logout-btn" class="btn-small" style="background:var(--d); width: 100%;"><i class="fas fa-sign-out-alt"></i> Wyloguj</button>
    </div>
  </nav>

  <main class="main">
    <div id="auth-error"><strong>Uwaga:</strong> Nie jesteś zalogowany. <a href="login.html">Kliknij tutaj</a>.</div>

    <!-- 1. DODAJ RAPORT -->
    <div id="dodaj" class="content active">
      <div class="card">
        <h1 id="form-title">Nowy raport serwisowy</h1>
        <div id="auto-fill-banner" class="auto-fill-banner">
            <i class="fas fa-magic"></i>
            <div><strong>Dane uzupełnione automatycznie.</strong><br>System rozpoznał VIN. Pola są zablokowane dla spójności.</div>
        </div>
        <form id="report-form">
            <input type="hidden" id="edit-report-id" value="">
            <div class="form-grid">
                <div class="form-group">
                    <label>Numer VIN *</label>
                    <div class="input-wrapper">
                        <input type="text" id="vin" placeholder="XXXXXXXXXXXXXXXXX" maxlength="17" required style="text-transform:uppercase; font-family: monospace; letter-spacing: 1px;">
                        <i class="fas fa-search input-icon"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Numer rejestracyjny *</label>
                    <div class="input-wrapper"><input type="text" id="plate" placeholder="WPR 12345" required style="text-transform:uppercase;"></div>
                </div>
                <div class="form-group">
                    <label>Marka *</label>
                    <div class="input-wrapper">
                        <input type="text" id="make" required>
                        <i class="fas fa-lock input-icon lock" style="display:none"></i>
                    </div>
                    <i class="fas fa-info-circle info-tooltip" data-tooltip="Pobrane z bazy VIN" style="display:none"></i>
                </div>
                <div class="form-group">
                    <label>Model *</label>
                    <div class="input-wrapper">
                        <input type="text" id="model" required>
                        <i class="fas fa-lock input-icon lock" style="display:none"></i>
                    </div>
                    <i class="fas fa-info-circle info-tooltip" data-tooltip="Pobrane z bazy VIN" style="display:none"></i>
                </div>
                <div class="form-group">
                    <label>Przebieg (km) *</label>
                    <div class="input-wrapper"><input type="number" id="mileage" min="0" required></div>
                </div>
                <div class="form-group">
                    <label>Data pierwszej rejestracji</label>
                    <div class="input-wrapper">
                        <input type="date" id="first-reg-date">
                        <i class="fas fa-lock input-icon lock" style="display:none"></i>
                    </div>
                    <i class="fas fa-info-circle info-tooltip" data-tooltip="Pobrane z bazy VIN" style="display:none"></i>
                </div>
                <div class="form-group full-width">
                    <label>Opis wykonanych prac *</label>
                    <textarea id="description" rows="5" required></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn-big"><i class="fas fa-paper-plane"></i> Zapisz raport</button>
                <button type="button" id="cancel-edit-btn" class="btn-big" style="background:#9ca3af; display:none;">Anuluj</button>
            </div>
        </form>
      </div>
    </div>

    <!-- 2. MOJE RAPORTY -->
    <div id="moje" class="content">
      <div class="card">
        <h1>Baza raportów</h1>
        <div class="filters">
            <div class="filter-tabs" id="report-tabs">
                <div class="filter-tab active" data-filter="all">Wszystkie</div>
                <div class="filter-tab" data-filter="approved">Zatwierdzone</div>
                <div class="filter-tab" data-filter="pending">Oczekujące</div>
                <div class="filter-tab" data-filter="rejected">Do poprawy</div>
            </div>
            <div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-reports" placeholder="Szukaj..."></div>
        </div>
        <div id="reports-container"><p style="text-align:center; padding: 2rem;">Ładowanie...</p></div>
      </div>
    </div>

    <!-- 3. CZĘŚCI -->
    <div id="czesci" class="content">
      <div class="card"><h1>Zamów Części</h1><div style="display:flex; gap:10px; margin-bottom: 20px;"><input type="text" id="parts-search-input" placeholder="Model..." class="full-input"><button id="btn-search-parts" class="btn-big">Szukaj</button></div><div id="parts-results-container"></div></div>
    </div>

    <!-- 4. FINANSE -->
    <div id="finanse" class="content">
        <div class="card mb-4">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>Finanse i Faktury</h1>
                <!-- Usunięto onclick z HTML, jest teraz w invoices.js -->
                <button class="btn-big">+ Nowa Faktura</button>
            </div>
            <div style="display:flex; gap:20px; margin: 20px 0;">
                <div style="flex:1; background:#eff6ff; padding:15px; border-radius:10px; border-left:5px solid var(--p);">
                    <small>Przychód Netto (Miesiąc)</small>
                    <div id="stats-netto" style="font-size:1.5rem; font-weight:bold;">0.00 PLN</div>
                </div>
                <div style="flex:1; background:#ecfdf5; padding:15px; border-radius:10px; border-left:5px solid var(--s);">
                    <small>Przychód Brutto (Miesiąc)</small>
                    <div id="stats-brutto" style="font-size:1.5rem; font-weight:bold;">0.00 PLN</div>
                </div>
            </div>
            <div id="invoices-list">Ładowanie faktur...</div>
        </div>
    </div>

    <div id="dane" class="content"><div class="card"><h1>Moje dane</h1><p><strong>Nazwa:</strong> <span id="w-name">-</span></p><p><strong>Email:</strong> <span id="w-email">-</span></p></div></div>
    <div id="kontakt" class="content"><div class="card"><h1>Kontakt</h1><p>Formularz kontaktowy.</p></div></div>
  </main>

  <!-- MODAL: PODGLĄD RAPORTU -->
  <div id="preview-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;padding:20px;">
    <div style="background:white;padding:2rem;border-radius:12px;width:100%;max-width:600px;">
        <h2 style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top:0;">Szczegóły raportu</h2>
        <div id="preview-content" style="line-height: 1.6;"></div>
        <div style="margin-top: 20px; text-align: right;"><button class="btn-big" style="background:#6b7280">Zamknij</button></div>
    </div>
  </div>

  <!-- MODAL: FAKTURA -->
  <div id="invoice-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;overflow-y:auto;padding:20px;">
    <div style="background:white;padding:2rem;border-radius:12px;width:100%;max-width:900px; max-height:95vh; overflow-y:auto;">
      <h2 style="border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">Wystaw Nową Fakturę</h2>
      <form id="invoice-form">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
            <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                <h3>Sprzedawca</h3>
                <input type="text" id="inv-seller-name" placeholder="Nazwa Warsztatu" class="full-input" required>
                <input type="text" id="inv-seller-nip" placeholder="NIP" class="full-input" required>
                <input type="text" id="inv-seller-address" placeholder="Adres" class="full-input" required>
            </div>
            <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                <h3>Nabywca</h3>
                <input type="text" id="inv-client-name" placeholder="Klient" class="full-input" required>
                <input type="text" id="inv-client-nip" placeholder="NIP (opcjonalnie)" class="full-input">
                <input type="text" id="inv-client-address" placeholder="Adres" class="full-input" required>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <div style="flex:1"><label>Numer Faktury</label><input type="text" id="inv-number" class="full-input" readonly style="background:#eee;"></div>
            <div style="flex:1"><label>Data wystawienia</label><input type="date" id="inv-date" class="full-input" required></div>
            <div style="flex:1"><label>Termin płatności</label><input type="date" id="inv-due" class="full-input" required></div>
        </div>
        <table style="width:100%; margin-bottom:20px;">
            <thead style="background:#eee;"><tr><th>Nazwa</th><th>Ilość</th><th>Netto</th><th>VAT%</th><th>Brutto</th><th></th></tr></thead>
            <tbody id="inv-items-body"></tbody>
        </table>
        <button type="button" id="add-inv-item-btn" class="btn-small" style="background:#6b7280;">+ Dodaj pozycję</button>
        <div style="text-align:right; margin-top:20px; font-size:1.2rem;">
            <p>Netto: <strong id="inv-sum-net">0.00</strong> PLN | VAT: <strong id="inv-sum-vat">0.00</strong> PLN</p>
            <p style="font-size:1.5rem; color:var(--p);">Do zapłaty: <strong id="inv-sum-gross">0.00</strong> PLN</p>
        </div>
        <div style="display:flex; gap:10px; margin-top:30px;">
            <button type="submit" class="btn-big" style="flex:1;">Zatwierdź i Generuj</button>
            <button type="button" class="btn-big" style="flex:1; background:#ddd; color:#333;">Anuluj</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SZABLON PDF -->
  <div id="invoice-template" style="display:none;"><div style="padding:40px; font-family:sans-serif;">
        <h1 style="color:#2563eb;">FAKTURA VAT <span id="pdf-number" style="color:#333; font-size:0.6em;"></span></h1>
        <div style="display:flex; justify-content:space-between; margin-top:40px;">
            <div><strong>Sprzedawca:</strong><br><span id="pdf-seller-name"></span><br><span id="pdf-seller-address"></span><br>NIP: <span id="pdf-seller-nip"></span></div>
            <div style="text-align:right;"><strong>Nabywca:</strong><br><span id="pdf-client-name"></span><br><span id="pdf-client-address"></span><br>NIP: <span id="pdf-client-nip"></span></div>
        </div>
        <table style="width:100%; border-collapse:collapse; margin-top:40px;">
            <thead style="background:#f3f4f6;"><tr><th style="padding:10px; text-align:left;">Nazwa</th><th style="padding:10px; text-align:right;">Ilość</th><th style="padding:10px; text-align:right;">Netto</th><th style="padding:10px; text-align:right;">VAT</th><th style="padding:10px; text-align:right;">Brutto</th></tr></thead>
            <tbody id="pdf-items"></tbody>
        </table>
        <h3 style="text-align:right; margin-top:30px; color:#2563eb;">DO ZAPŁATY: <span id="pdf-sum-gross"></span> PLN</h3>
  </div></div>

  <!-- GŁÓWNY SKRYPT -->
  <script type="module" src="js/panel-warsztatu/main.js"></script>
</body>
</html>