==========================================
PLIK: C:\Users\brons\Desktop\strona\.vscode\extensions.json
==========================================
{
    "recommendations": [
        "continue.continue"
    ]
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\css\auth\page.css
==========================================
.auth-body {
    background: radial-gradient(circle at top, #0b3d60, #050e17);
    min-height: 100vh;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.auth {
    width: min(480px, 100%);
    background: #ffffff;
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: 0 30px 60px rgba(3, 18, 37, 0.35);
}

.auth__home-link {
    display: inline-flex;
    margin-bottom: 1rem;
}

.auth__intro {
    margin-bottom: 2rem;
    text-align: center;
}

.auth__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.3em;
    font-size: 0.75rem;
    color: var(--color-secondary);
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.auth-form label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.auth-form input {
    border-radius: 12px;
    border: 1px solid #d0d7e2;
    padding: 0.75rem 1rem;
    font-size: 1rem;
}

.auth-card__feedback {
    min-height: 1.5rem;
    font-size: 0.9rem;
    color: var(--color-muted);
    margin-top: 0.75rem;
}

.auth-card__feedback.is-success {
    color: #1b9c58;
}

.auth-card__feedback.is-error {
    color: #c92a2a;
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\css\base\core.css
==========================================
:root {
    --color-primary: #0b3d60;
    --color-primary-dark: #06253a;
    --color-secondary: #1c7ed6;
    --color-bg: #f4f6f8;
    --color-card: #ffffff;
    --color-text: #1f2a37;
    --color-muted: #6b7785;
    --radius: 14px;
    --shadow-soft: 0 15px 35px rgba(15, 23, 42, 0.12);
    font-size: 16px;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--color-bg);
    color: var(--color-text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
}

a {
    color: inherit;
}

ul {
    margin: 0;
    padding: 0;
    list-style: none;
}

.btn {
    border: none;
    border-radius: 999px;
    padding: 0.85rem 1.7rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn--primary {
    background: var(--color-primary);
    color: #ffffff;
    box-shadow: var(--shadow-soft);
}

.btn--secondary {
    background: var(--color-secondary);
    color: #ffffff;
}

.btn--ghost {
    border: 1px solid var(--color-primary);
    color: var(--color-primary);
    background: transparent;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn:focus-visible,
.site-nav__link:focus-visible,
.site-nav__cta:focus-visible,
.ghost-link:focus-visible {
    outline: 2px solid var(--color-secondary);
    outline-offset: 3px;
}

.ghost-link {
    color: #90a4b7;
    text-decoration: none;
    font-size: 0.85rem;
    opacity: 0.65;
}

.ghost-link:focus,
.ghost-link:hover {
    opacity: 1;
}

.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

.is-hidden {
    display: none !important;
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\css\landing\page.css
==========================================
.site-body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.site-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 5vw;
    background: #ffffff;
    border-bottom: 1px solid #e4e7eb;
    position: sticky;
    top: 0;
    z-index: 5;
}

.site-header__brand {
    max-width: 420px;
}

.site-header__logo {
    font-weight: 700;
    font-size: 1.25rem;
    color: var(--color-primary);
    text-decoration: none;
}

.site-header__logo--accent {
    color: var(--color-secondary);
}

.site-header__tagline {
    margin: 0.1rem 0 0;
    color: var(--color-muted);
    font-size: 0.9rem;
}

.site-nav {
    display: flex;
    gap: 1rem;
    align-items: center;
    transition: max-height 0.3s ease;
}

.site-nav__link,
.site-nav__cta {
    text-decoration: none;
    font-weight: 600;
    color: var(--color-primary);
    padding: 0.5rem 0.75rem;
    border-radius: 999px;
}

.site-nav__cta {
    background: var(--color-primary);
    color: #ffffff;
}

.site-nav__toggle {
    display: none;
    flex-direction: column;
    gap: 0.25rem;
    background: transparent;
    border: none;
    cursor: pointer;
}

.site-nav__toggle span {
    width: 28px;
    height: 2px;
    background: var(--color-primary);
}

.hero {
    padding: 4rem 5vw 3rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    align-items: center;
    background: linear-gradient(135deg, #f5f8fb 0%, #e6eef7 50%, #ffffff 100%);
}

.hero__content {
    max-width: 540px;
}

.hero__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-size: 0.75rem;
    color: var(--color-secondary);
    margin-bottom: 0.5rem;
}

.hero__lead {
    font-size: 1.1rem;
    color: var(--color-muted);
}

.hero__note {
    margin-top: 1rem;
    font-size: 0.95rem;
    color: var(--color-muted);
}

.hero__actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.hero__stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    background: #ffffff;
    padding: 1.5rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow-soft);
}

.hero__stats strong {
    display: block;
    font-size: 1.8rem;
    color: var(--color-primary);
}

.hero__stats span {
    font-size: 0.9rem;
    color: var(--color-muted);
}

.section {
    padding: 3rem 5vw;
}

.section--highlight {
    background: #ffffff;
}

.section--alt {
    background: #0f172a;
    color: #f4f6f8;
}

.section__header {
    max-width: 640px;
    margin-bottom: 2rem;
}

.section__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.75rem;
    color: var(--color-secondary);
    margin-bottom: 0.4rem;
}

.card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
}

.card {
    background: var(--color-card);
    padding: 1.75rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow-soft);
}

.card h3 {
    margin-top: 0;
}

.vin-form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}

.vin-form input {
    flex: 1;
    min-width: 220px;
    padding: 0.9rem 1rem;
    border-radius: 999px;
    border: 1px solid #d0d7e2;
    font-size: 1rem;
}

.vin-result {
    min-height: 2rem;
    font-size: 0.95rem;
    color: var(--color-muted);
}

.vin__hint {
    font-size: 0.9rem;
    color: var(--color-muted);
    margin-top: 0.5rem;
}

.vin-card-list {
    display: grid;
    gap: 1rem;
    margin-top: 1rem;
}

.vin-card {
    background: #f8fafc;
    border: 1px solid #e4e7eb;
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
}

.vin-card header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 0.95rem;
}

.vin-card__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin: 0.5rem 0;
    font-size: 0.85rem;
    color: var(--color-muted);
}

.vin-card-media {
    list-style: none;
    margin: 0.5rem 0 0;
    padding: 0;
    font-size: 0.85rem;
}

.vin-card-media li + li {
    margin-top: 0.25rem;
}

.vin-card-media a {
    color: var(--color-primary);
    text-decoration: underline;
}

.vin-card footer {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--color-muted);
}

.steps {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
}

.steps li {
    background: rgba(255, 255, 255, 0.08);
    border-radius: var(--radius);
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.25rem;
}

.insight {
    background: #ffffff;
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-soft);
    min-height: 150px;
}

.insight__value {
    font-size: 2rem;
    color: var(--color-primary);
    font-weight: 700;
}

.insight__text {
    margin-top: 0.5rem;
    color: var(--color-muted);
    line-height: 1.4;
}

.cta {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1.5rem;
    align-items: center;
    border-radius: var(--radius);
    box-shadow: var(--shadow-soft);
}

.cta__actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    min-width: 220px;
}

.site-footer {
    margin-top: auto;
    padding: 1.5rem 5vw;
    background: #0b1624;
    color: #dbe2ef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .site-nav__toggle {
        display: flex;
    }

    .site-nav {
        width: 100%;
        flex-direction: column;
        max-height: 0;
        overflow: hidden;
    }

    .site-nav.is-open {
        max-height: 320px;
        padding-top: 1rem;
    }

    .site-footer {
        flex-direction: column;
        gap: 1rem;
    }

    .cta {
        flex-direction: column;
    }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\css\panel\page.css
==========================================
.panel-back-btn--absolute {
    position: absolute;
    top: 2.5rem;
    left: 2.5rem;
    z-index: 10;
}
.panel-section {
    position: relative;
}
.workshop-tab-content#tab-settings,
.workshop-tab-content#tab-settings * {
    color: #111 !important;
}
.workshop-tab-content#tab-settings .panel-form {
    margin-top: 1.5rem;
    max-width: 540px;
}
.workshop-tab-content#tab-settings fieldset {
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1.5rem;
    background: #f8fafc;
}
.workshop-tab-content#tab-settings legend {
    font-weight: 600;
    margin-bottom: 0.5rem;
}
.workshop-tab-content#tab-reports,
.workshop-tab-content#tab-reports * {
    color: #111 !important;
}
.workshop-tab-content#tab-reports .panel-filters {
    margin-bottom: 1.5rem;
}
.workshop-tab-content#tab-reports #workshop-reports-list {
    margin-top: 1.5rem;
    font-size: 1rem;
    color: #444;
}
.workshop-detail-shell__layout,
.workshop-detail-shell__layout * {
    color: #111 !important;
}
.workshop-tab-content#tab-contacts,
.workshop-tab-content#tab-contacts * {
    color: #111 !important;
}
.panel-body {
    min-height: 100vh;
    background: var(--color-bg);
    display: flex;
    flex-direction: column;
}

.panel-layout {
    flex: 1;
    display: grid;
    grid-template-columns: 260px minmax(0, 1fr);
    min-height: 100vh;
    width: 100%;
}

.panel-sidebar {
    background: linear-gradient(180deg, #0f172a 0%, #1d2845 100%);
    color: #ffffff;
    padding: 2.5rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    box-shadow: inset -1px 0 0 rgba(255, 255, 255, 0.08);
    position: sticky;
    top: 0;
    align-self: start;
    height: 100vh;
    overflow-y: auto;
}

.panel-sidebar__brand {
    font-size: 1.5rem;
    font-weight: 700;
}

.panel-body--workshop .panel-sidebar,
.panel-body--workshop .panel-nav,
.panel-body--workshop .panel-section:not(.panel-section--summary):not(.panel-section--narrow) {
    display: none;
}

.panel-body--workshop .panel-main {
    padding-top: 1.5rem;
}

.panel-body--workshop .panel-view--workshop {
    display: flex;
}

.panel-body--workshop .panel-layout {
    grid-template-columns: minmax(0, 1fr);
}

.panel-sidebar__brand span {
    color: var(--color-secondary);
}

.panel-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.panel-nav__link {
    background: transparent;
    border: none;
    text-align: left;
    padding: 0.65rem 1rem;
    border-radius: 10px;
    color: inherit;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
}

.panel-nav__link.is-active,
.panel-nav__link:hover {
    background: rgba(255, 255, 255, 0.1);
}

.panel-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.panel-back-btn-container {
    margin: 2rem 0 0 0;
    display: flex;
    align-items: flex-start;
}
.panel-back-btn {
    margin-left: 0;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    padding: 0.7rem 1.5rem;
    border-radius: 24px;
    border: 1px solid #d1d5db;
    background: #fff;
    color: #222;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}
.panel-back-btn:hover {
    background: #f3f4f6;
    color: var(--color-primary);
}

.panel-header {
    background: #ffffff;
    border-bottom: 1px solid #e4e7eb;
    padding: 1.25rem 2.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header__info {
    display: flex;
    flex-direction: column;
}

.panel-header__subtitle {
    color: var(--color-muted);
    font-size: 0.9rem;
}

.panel-main {
    flex: 1;
    padding: 2.5rem;
    overflow-y: auto;
    background: linear-gradient(180deg, #f6f8fb 0%, #f1f5f9 100%);
}

.panel-view {
    display: none;
}

.panel-view.is-active {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
}

.panel-section {
    width: 100%;
}

.panel-section--summary {
    max-width: 1100px;
}

.panel-section--narrow {
    max-width: 720px;
    margin: 0 auto;
}

.panel-section--split .panel-split {
    display: grid;
    grid-template-columns: minmax(0, 2.2fr) minmax(280px, 1fr);
    gap: 2rem;
    align-items: flex-start;
}

.panel-section__header,
.panel-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.panel-toolbar__actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.panel-section__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.75rem;
    color: var(--color-muted);
    margin: 0 0 0.35rem;
}

.panel-section__hint {
    max-width: 320px;
    font-size: 0.9rem;
    color: var(--color-muted);
    margin: 0;
}

.panel-card {
    background: #ffffff;
    border-radius: var(--radius);
    padding: 1.75rem;
    box-shadow: var(--shadow-soft);
    border: 1px solid #e4e7eb;
}

.panel-card h2,
.panel-card h3 {
    margin-top: 0;
}

.panel-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.panel-card--inactive {
    padding-top: 1.5rem;
}

.panel-card--surface {
    padding: 2rem;
}

.panel-card--aside {
    height: 100%;
    position: sticky;
    top: 2.5rem;
}

.panel-card--logs {
    padding-top: 1.5rem;
    height: 100%;
}

.panel-card--audit {
    padding-top: 1.5rem;
    height: 100%;
}

.panel-card--workshop {
    min-height: 200px;
}

/* Poprawa kontrastu tekstu placeholderĂłw w szczegĂłĹ‚ach warsztatu */
.workshop-detail__grid .placeholder,
.workshop-detail__section .placeholder,
.panel-card .placeholder,
.workshop-detail__grid [class*="empty"],
.workshop-detail__section [class*="empty"],
.panel-card [class*="empty"] {
    color: #374151 !important; /* ciemny szary dla lepszej widocznoĹ›ci */
    opacity: 1 !important;
    font-weight: 500;
}

/* Poprawa kontrastu tekstu placeholderĂłw */
.workshop-detail__grid .placeholder,
.workshop-detail__section .placeholder,
.panel-card .placeholder {
    color: #6b7280 !important; /* ciemniejszy szary */
    opacity: 1 !important;
}

/* --- Warsztat: zakĹ‚adki szczegĂłĹ‚Ăłw --- */
.workshop-tabs {
    margin-bottom: 2rem;
}
.workshop-tabs__nav {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}
.workshop-tab {
    background: #f4f6f8;
    border: none;
    border-radius: 8px 8px 0 0;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    color: #222;
    transition: background 0.2s, color 0.2s;
    font-weight: 500;
}
.workshop-tab.active {
    background: var(--color-primary);
    color: #fff;
    font-weight: bold;
}
.workshop-tabs__content {
    background: #fff;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 2rem 1.5rem;
    margin-bottom: 2rem;
}
.workshop-tab-content {
    display: block;
}
.workshop-notepad {
    width: 100%;
    min-height: 80px;
    margin-top: 1rem;
    padding: 0.7rem;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 1rem;
    resize: vertical;
}

.workshop-summary {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.workshop-summary strong {
    font-size: 1.25rem;
}

.workshop-summary small {
    color: var(--color-muted);
}

.workshop-summary__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.workshop-summary__meta span {
    font-size: 0.9rem;
    color: var(--color-muted);
}

.workshop-summary__contract {
    margin-top: 1.25rem;
    padding-top: 1rem;
    border-top: 1px solid #e4e7eb;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.panel-body--workshop .panel-section__hint {
    max-width: 540px;
}

.panel-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}


.panel-grid--summary {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
}

.panel-grid--overview-cards {
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    align-items: stretch;
}

.metric-card {
    background: #ffffff;
    border-radius: var(--radius);
    padding: 1.25rem;
    border: 1px solid #e4e7eb;
    min-height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    text-align: left;
    color: inherit;
    width: 100%;
    cursor: default;
}

.metric-card--action {
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.metric-card--action:hover,
.metric-card--action:focus-visible {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.15);
    outline: none;
}

.metric-card strong {
    display: block;
    font-size: 2rem;
    color: var(--color-primary);
}

.metric-card small {
    color: var(--color-muted);
}

.panel-form,
.panel-filters {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.panel-form--stacked {
    gap: 0.75rem;
    border: 1px solid #edf0f4;
    border-radius: 16px;
    padding: 1.25rem;
    background: #f8fafc;
}

.panel-form__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.panel-form__meta--two > label {
    flex: 1 1 200px;
}

.panel-form label,
.panel-filters label {
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.panel-form__hint {
    font-size: 0.8rem;
    color: var(--color-muted);
}

.panel-form input,
.panel-form select,
.panel-form textarea,
.panel-filters input,
.panel-filters select {
    border-radius: 12px;
    border: 1px solid #d0d7e2;
    padding: 0.75rem 1rem;
    font-size: 1rem;
}

.panel-form textarea,
.panel-filters textarea {
    resize: vertical;
}

.panel-form--grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1.5rem;
}

.panel-form--grid label:nth-child(2) {
    grid-column: span 2;
}

.panel-form__actions {
    margin-top: 0.5rem;
    display: flex;
    justify-content: flex-start;
}

.panel-form__actions--spread {
    justify-content: space-between;
    gap: 1rem;
}

.panel-form__actions--end {
    justify-content: flex-end;
}

.panel-filters--inline {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.25rem;
    align-items: end;
}

.panel-filters--surface {
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8fbff 0%, #ffffff 100%);
    border: 1px solid #dce7f5;
    border-radius: 18px;
    box-shadow: 0 15px 30px rgba(15, 23, 42, 0.08);
}

.panel-filters--surface label input,
.panel-filters--surface label select {
    background: #ffffff;
    border-color: #d0dff2;
    box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.04);
}

.panel-filters--surface label input:focus,
.panel-filters--surface label select:focus {
    border-color: var(--color-secondary);
    box-shadow: 0 0 0 2px rgba(28, 126, 214, 0.15);
    outline: none;
}

.panel-filters__actions {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 0.75rem;
}

.panel-list {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.panel-list--grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
}

.workshop-browser {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.workshop-browser--detail {
    border-radius: 28px;
    padding: 2rem;
    background: linear-gradient(120deg, #0f172a 0%, #172554 50%, #1e3a8a 100%);
    color: #f8fbff;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 30px 60px rgba(15, 23, 42, 0.35);
    position: relative;
    overflow: hidden;
}

.workshop-browser--detail::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.25), transparent 55%);
    pointer-events: none;
}

.workshop-browser--detail > * {
    position: relative;
    z-index: 1;
}

.workshop-browser[hidden] {
    display: none;
}

.panel-list__item {
    border: 1px solid #edf0f4;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    background: #f8fafc;
    display: flex;
    justify-content: space-between;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.panel-workshop-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 1.5rem;
    border: 1px solid #e4e7eb;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    min-height: 220px;
    height: 100%;
}

.panel-workshop-card[data-workshop-card] {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.panel-workshop-card[data-workshop-card]:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
}

.panel-workshop-card__header {
    display: flex;
    justify-content: space-between;
    gap: 0.85rem 1rem;
    align-items: flex-start;
    flex-wrap: wrap;
}

.panel-workshop-card__identity {
    display: flex;
    gap: 0.85rem;
    flex: 1;
    min-width: 0;
    align-items: center;
}

.panel-workshop-card__identity > div {
    min-width: 0;
}

.panel-workshop-card__identity strong {
    display: block;
    font-size: 1rem;
    line-height: 1.2;
    overflow-wrap: anywhere;
}

.panel-workshop-card__avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0ea5e9, #2563eb);
    color: #ffffff;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    line-height: 1;
}

.panel-workshop-card__location {
    margin: 0.2rem 0 0;
    color: var(--color-muted);
    font-size: 0.9rem;
}

.panel-workshop-card__contact {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem 1.25rem;
    background: #f8fafc;
    border: 1px solid #edf0f4;
    border-radius: 16px;
    min-height: 96px;
}

.panel-workshop-card__contact-item {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
}

.panel-workshop-card__contact-item small {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.7rem;
    color: var(--color-muted);
}

.panel-workshop-card__contact-item span {
    font-weight: 600;
    color: var(--color-text);
}

.panel-workshop-card__stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-top: auto;
}

.panel-workshop-card__stat {
    background: #f8fafc;
    border-radius: 14px;
    padding: 0.75rem 1rem;
    border: 1px solid #edf0f4;
    min-height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 0.25rem;
}

.panel-workshop-card__stat strong {
    display: block;
    font-size: 1.1rem;
    color: var(--color-primary);
}

.panel-workshop-card__stat small {
    color: var(--color-muted);
    font-size: 0.8rem;
}

.panel-workshop-card__actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

.panel-tag--notice {
    background: rgba(250, 176, 5, 0.15);
    color: #b35300;
    border-color: transparent;
}

.panel-list__item--stacked {
    flex-direction: column;
    align-items: flex-start;
}

.panel-billing-amount {
    margin-top: 0.5rem;
    font-weight: 600;
}

.panel-contract-info {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    color: var(--color-muted);
}

.panel-list__item-actions {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    align-items: stretch;
}

.panel-list__item-actions--compact {
    align-items: flex-end;
    gap: 0.35rem;
}

.panel-mini-list {
    list-style: none;
    margin: 1.5rem 0 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
}

.panel-mini-list li {
    border: 1px dashed #dfe4ec;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    background: #f8fafc;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.panel-mini-list strong {
    font-size: 0.95rem;
}

.panel-mini-list small {
    color: var(--color-muted);
}

.panel-list__item-actions .btn {
    width: 100%;
    border-radius: 10px;
    padding: 0.4rem 0.75rem;
    font-size: 0.85rem;
}

.panel-media-section {
    border: 1px solid #edf0f4;
    border-radius: 12px;
    padding: 1rem;
    background: #f8fafc;
}

.panel-media-section__title {
    margin: 0 0 0.5rem;
    font-weight: 600;
}

.panel-media-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
}

.panel-media-gallery--readonly {
    min-height: 60px;
}

.panel-media-gallery--inline {
    margin-top: 0.75rem;
}

.panel-media-card {
    border: 1px solid #d0d7e2;
    border-radius: 10px;
    padding: 0.5rem;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
}

.panel-media-card strong {
    font-size: 0.85rem;
}

.panel-media-card small {
    color: var(--color-muted);
    font-size: 0.75rem;
}

.panel-media-thumb {
    width: 100%;
    border-radius: 8px;
    object-fit: cover;
    max-height: 140px;
}

.panel-media-thumb--video {
    background: #0f172a;
}

.panel-report-meta {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-size: 0.85rem;
    color: var(--color-muted);
}

.panel-upload input[type="file"] {
    border: 1px dashed #94a3b8;
    background: #f8fafc;
}

.panel-upload small {
    color: var(--color-muted);
    font-weight: 400;
}

.panel-upload__list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.panel-upload__list li {
    font-size: 0.85rem;
    color: var(--color-muted);
    display: flex;
    justify-content: space-between;
    padding: 0.35rem 0.5rem;
    border-bottom: 1px solid #e4e7eb;
}

.panel-upload__list li:last-child {
    border-bottom: none;
}

.panel-upload__warning {
    color: #c92a2a;
    font-weight: 600;
}

.panel-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.65rem;
}

.panel-tag {
    display: inline-flex;
    align-items: center;
    padding: 0.15rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    background: #e4e7eb;
    color: #0b1624;
}

.panel-tag--success {
    background: #d3f9d8;
    color: #0b6534;
}

.panel-tag--warning {
    background: #ffe3e3;
    color: #c92a2a;
}

.panel-tag--danger {
    background: #ffd3d3;
    color: #a61b1b;
}

.panel-tag--muted {
    background: #e2e8f0;
    color: #475569;
}

.panel-list__item small {
    color: var(--color-muted);
}

.panel-list__contact {
    margin: 0.25rem 0 0;
    font-size: 0.9rem;
    color: var(--color-muted);
}

.panel-report-moderation {
    display: block;
    margin-top: 0.35rem;
    font-size: 0.85rem;
    color: var(--color-muted);
}

.panel-report-note {
    margin-top: 0.75rem;
    padding: 0.65rem 0.75rem;
    border-radius: 10px;
    background: #f1f5fb;
    font-size: 0.9rem;
    color: var(--color-text);
}

.panel-report-note--danger {
    background: #ffe3e3;
    color: #a61b1b;
}

.panel-alert {
    background: #e6f4ea;
    border: 1px solid #b7dfc1;
    border-radius: 12px;
    padding: 1rem;
    color: #0b6534;
}

.panel-feedback {
    min-height: 1.25rem;
    font-size: 0.9rem;
    color: var(--color-muted);
    margin-top: 0.75rem;
}

.panel-feedback.is-success {
    color: #1b9c58;
}

.panel-feedback.is-error {
    color: #c92a2a;
}

.panel-log {
    list-style: none;
    margin: 1rem 0 0;
    padding: 0;
    max-height: 260px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
}

.panel-log--tall {
    max-height: 460px;
    border: 1px solid #e4e7eb;
    border-radius: 12px;
    padding: 1rem;
    background: #f8fafc;
}

.panel-log--audit {
    max-height: none;
}

.panel-log li,
.panel-log div {
    font-size: 0.9rem;
    line-height: 1.4;
}

.panel-empty {
    color: var(--color-muted);
}

.panel-drawer {
    position: fixed;
    top: 0;
    right: 0;
    width: min(420px, 90vw);
    height: 100vh;
    background: #ffffff;
    box-shadow: -8px 0 24px rgba(15, 23, 42, 0.15);
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    transform: translateX(100%);
    transition: transform 0.25s ease;
    z-index: 1000;
}

.panel-drawer--form {
    width: min(480px, 95vw);
    gap: 1.5rem;
    padding-bottom: 2.5rem;
}

.panel-form--drawer {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.25rem;
    gap: 1.25rem;
}

.panel-drawer--detail {
    width: min(560px, 95vw);
    gap: 1.5rem;
}

.panel-drawer.is-open {
    transform: translateX(0);
}

.panel-drawer__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.panel-drawer__lead {
    margin: 0;
    color: var(--color-muted);
}

.panel-drawer__content {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.panel-drawer__item {
    border: 1px solid #e4e7eb;
    border-radius: 12px;
    padding: 0.85rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    background: #f8fafc;
}

.panel-drawer__item strong {
    font-size: 0.95rem;
}

.panel-drawer__item small {
    color: var(--color-muted);
}

.panel-drawer__backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.3);
    z-index: 999;
}

.panel-drawer__backdrop[hidden] {
    display: none;
}

.workshop-detail {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.workshop-detail-shell {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.workshop-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin: 1.5rem 0 0;
    padding: 1rem 1.5rem;
    border: 1px solid #d7e2f3;
    border-radius: 18px;
    background: linear-gradient(120deg, #f7fbff 0%, #ffffff 100%);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.workshop-toolbar--detail {
    margin-top: 0;
}

.workshop-toolbar__back {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
}

.workshop-toolbar__back::before {
    content: '\2190';
    font-size: 1rem;
}

.workshop-toolbar__hint {
    margin: 0;
    font-size: 0.95rem;
    color: var(--color-muted);
}

.workshop-toolbar[hidden] {
    display: none !important;
}

.workshop-detail-shell__toolbar {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    align-items: flex-start;
}

.workshop-detail-shell__actions {
    display: flex;
    gap: 0.75rem;
}

.workshop-detail-shell__layout {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(320px, 1fr);
    gap: 2rem;
    align-items: start;
}

.workshop-detail-shell__primary {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    background: rgba(15, 23, 42, 0.35);
    border-radius: 24px;
    padding: 1.75rem;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.workshop-detail-shell__primary,
.workshop-detail-shell__primary h4,
.workshop-detail-shell__primary p,
.workshop-detail-shell__primary strong,
.workshop-detail-shell__primary small {
    color: #f8fbff;
}

.workshop-detail-shell__primary .panel-section__eyebrow {
    color: rgba(248, 251, 255, 0.75);
}

.workshop-detail-shell__primary .workshop-detail__stat {
    background: rgba(15, 23, 42, 0.55);
    border-color: rgba(248, 251, 255, 0.25);
}

.workshop-detail-shell__primary .workshop-detail__stat small {
    color: rgba(248, 251, 255, 0.75);
}

.workshop-detail-shell__primary .workshop-detail__stat strong {
    color: #ffffff;
}

.workshop-detail-shell__aside {
    background: #ffffff;
    border-radius: 24px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    box-shadow: 0 25px 45px rgba(15, 23, 42, 0.25);
    color: var(--color-text);
}

.workshop-detail-shell__aside .panel-section__eyebrow,
.workshop-detail-shell__aside h4 {
    color: var(--color-text);
}

.workshop-detail__section--compact {
    border: none;
    padding: 0;
}

.workshop-billing-form {
    background: #f8fbff;
    border: 1px solid #dbe7fb;
    border-radius: 20px;
    padding: 1.25rem;
    box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.05);
}

.workshop-detail__header {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    align-items: flex-start;
}

.workshop-detail__address {
    margin: 0.15rem 0 0.35rem;
    color: var(--color-muted);
}

.workshop-detail__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    color: var(--color-muted);
    font-size: 0.9rem;
}

.workshop-detail__meta span:not(.panel-tag) {
    background: #f1f5fb;
    padding: 0.2rem 0.65rem;
    border-radius: 999px;
}

.workshop-detail__actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-end;
}

.workshop-detail__notes {
    margin: 0.5rem 0 0;
    padding: 0.75rem 1rem;
    border-left: 3px solid var(--color-secondary);
    background: #f8fbff;
    border-radius: 12px;
    font-size: 0.9rem;
}

.workshop-detail__section {
    border-top: 1px solid #e4e7eb;
    padding-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.workshop-detail__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.85rem;
}

.workshop-detail__stat {
    background: #f8fafc;
    border: 1px solid #edf0f4;
    border-radius: 16px;
    padding: 0.85rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.workshop-detail__stat small {
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.75rem;
    color: var(--color-muted);
}

.workshop-detail__stat strong {
    font-size: 1rem;
}

.workshop-detail__stat span {
    font-size: 0.85rem;
    color: var(--color-muted);
}

.workshop-detail__stat--accent {
    background: linear-gradient(135deg, #e0f2ff 0%, #f8fafc 100%);
    border-color: #b7d9fb;
}

.workshop-billing-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.9rem;
}

.workshop-billing-item {
    border: 1px solid #e4e7eb;
    border-radius: 16px;
    padding: 1rem 1.1rem;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
}

.workshop-billing-item__main strong {
    font-size: 1rem;
}

.workshop-billing-item__main small,
.workshop-billing-item__main span,
.workshop-billing-item__main p {
    display: block;
    margin: 0.2rem 0 0;
    color: var(--color-muted);
    font-size: 0.85rem;
}

.workshop-billing-item__meta {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.workshop-billing-item__status {
    align-self: flex-start;
    padding: 0.2rem 0.7rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
}

.workshop-billing-item__status--paid {
    background: #d3f9d8;
    color: #0b6534;
}

.workshop-billing-item__status--unpaid {
    background: #ffe3e3;
    color: #a61b1b;
}

.workshop-billing-item__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
}

.workshop-billing-item__actions .btn {
    padding: 0.35rem 0.75rem;
    font-size: 0.85rem;
    border-radius: 10px;
}

.workshop-billing-item__actions .btn.btn--ghost {
    border-color: #d0d7e2;
}

@media (max-width: 680px) {
    .workshop-detail__header {
        flex-direction: column;
    }

    .workshop-detail__actions {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: flex-start;
    }
}

@media (max-width: 1024px) {
    .workshop-detail-shell__layout {
        grid-template-columns: 1fr;
    }

    .workshop-detail-shell__primary,
    .workshop-detail-shell__aside {
        width: 100%;
    }
}

@media (max-width: 960px) {
    .panel-layout {
        flex-direction: column;
    }

    .panel-sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 1rem;
    }

    .panel-nav {
        flex-direction: row;
        flex-wrap: wrap;
    }

    .panel-section--split .panel-split,
    .panel-form--grid {
        grid-template-columns: 1fr;
    }

    .panel-card--aside {
        position: static;
    }

    .panel-grid--summary {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\css\panel-warsztatu.css
==========================================
:root { --p: #2563eb; --p-dark: #1e40af; --s: #10b981; --d: #ef4444; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --locked: #f3f4f6; }
* { box-sizing: border-box; }
body { margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); display:flex; min-height:100vh; color:var(--text); }

/* Layout */
.sidebar { width:280px; background:var(--card); box-shadow:2px 0 15px rgba(0,0,0,0.05); display:flex; flex-direction:column; position:fixed; height:100%; z-index:10; }
.sidebar h2 { margin: 2rem 1.5rem; color:var(--p); font-size:1.6rem; letter-spacing: -0.5px; }
.sidebar a { display:flex; align-items:center; gap:10px; padding:1rem 1.5rem; color:#4b5563; text-decoration:none; font-weight:500; border-left:4px solid transparent; transition:0.2s; cursor:pointer; }
.sidebar a:hover, .sidebar a.active { background:#eff6ff; color:var(--p); border-left-color:var(--p); font-weight:600; }
.sidebar a i { width: 20px; text-align: center; }
.main { margin-left:280px; flex:1; padding:2rem; max-width: 1400px; }
.content { display:none; animation: fadeIn 0.3s ease; }
.content.active { display:block; }
@keyframes fadeIn { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }

/* UI Components */
.card { background:var(--card); padding:2rem; border-radius:16px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; }
h1 { margin-top:0; font-size: 1.8rem; color: #111827; }
.btn-big { background:var(--p); color:white; border:none; padding:0.8rem 2rem; border-radius:8px; font-size:1rem; cursor:pointer; font-weight:600; transition:0.2s; display: inline-flex; align-items: center; gap: 8px; }
.btn-big:hover { background: var(--p-dark); }
.btn-small { padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer; font-size:0.85rem; border:none; color:white; transition: 0.2s; }
.full-input { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }

/* Forms */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.full-width { grid-column: 1 / -1; }
.form-group { margin-bottom: 1rem; position: relative; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: #374151; }
.input-wrapper { position: relative; }
.input-wrapper input, .input-wrapper textarea { width: 100%; padding: 0.75rem; padding-right: 40px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s; }
.input-wrapper input.locked { background-color: var(--locked); color: #6b7280; border-color: #e5e7eb; cursor: not-allowed; }
.input-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
.info-tooltip { position: absolute; right: -25px; top: 38px; color: var(--p); cursor: help; }
.info-tooltip:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; right: 0; width: 200px; background: #1f2937; color: white; padding: 8px; border-radius: 6px; font-size: 0.75rem; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
.auto-fill-banner { display: none; align-items: center; gap: 10px; background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; animation: slideDown 0.3s ease; }
@keyframes slideDown { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }
@keyframes flashGreen { 0% { background-color: #dcfce7; } 100% { background-color: var(--locked); } }
.animate-fill { animation: flashGreen 1.5s ease; }

/* Tables */
.filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
.filter-tabs { display: flex; background: #f3f4f6; padding: 4px; border-radius: 8px; gap: 4px; }
.filter-tab { padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: #4b5563; }
.filter-tab.active { background: white; color: var(--p); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.search-box { flex: 1; position: relative; }
.search-box input { width: 100%; padding: 10px 10px 10px 40px; border-radius: 8px; border: 1px solid #d1d5db; }
.search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
table { width:100%; border-collapse:collapse; }
th { text-align: left; padding: 1rem; color: #6b7280; font-size: 0.85rem; text-transform: uppercase; border-bottom: 2px solid #f3f4f6; }
td { padding: 1rem; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
.badge.approved { background: #d1fae5; color: #065f46; }
.badge.pending { background: #fef3c7; color: #92400e; }
.badge.rejected { background: #fee2e2; color: #991b1b; }

/* Responsive */
@media (max-width: 768px) {
    .sidebar { width: 100%; height: auto; position: relative; flex-direction: row; overflow-x: auto; padding: 0.5rem; }
    .sidebar h2 { display:none; } .sidebar a span { display:none; }
    .main { margin-left: 0; padding: 1rem; }
    .form-grid { grid-template-columns: 1fr; }
    .info-tooltip { display: none; }
    table, thead, tbody, th, td, tr { display: block; } thead { display: none; }
    tr { margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: white; }
    td { padding: 0.5rem 0; border: none; display: flex; justify-content: space-between; align-items: center; }
    td:before { content: attr(data-label); font-weight: 600; color: #6b7280; margin-right: 1rem; }
}
#auth-error { display:none; background:#fee2e2; color:#b91c1c; padding:1rem; margin-bottom:2rem; border-radius:8px; border:1px solid #fca5a5; }

==========================================
PLIK: C:\Users\brons\Desktop\strona\css\styles.css
==========================================
:root {
    --color-primary: #0b3d60;
    --color-primary-dark: #06253a;
    --color-secondary: #1c7ed6;
    --color-bg: #f4f6f8;
    --color-card: #ffffff;
    --color-text: #1f2a37;
    --color-muted: #6b7785;
    --radius: 14px;
    --shadow-soft: 0 15px 35px rgba(15, 23, 42, 0.12);
    font-size: 16px;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--color-bg);
    color: var(--color-text);
}

.site-body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.site-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 5vw;
    background: #ffffff;
    border-bottom: 1px solid #e4e7eb;
    position: sticky;
    top: 0;
    z-index: 5;
}

.site-header__brand {
    max-width: 420px;
}

.site-header__logo {
    font-weight: 700;
    font-size: 1.25rem;
    color: var(--color-primary);
    text-decoration: none;
}

.site-header__logo--accent {
    color: var(--color-secondary);
}

.site-header__tagline {
    margin: 0.1rem 0 0;
    color: var(--color-muted);
    font-size: 0.9rem;
}

.site-nav {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.site-nav__link,
.site-nav__cta {
    text-decoration: none;
    font-weight: 600;
    color: var(--color-primary);
    padding: 0.5rem 0.75rem;
    border-radius: 999px;
}

.site-nav__cta {
    background: var(--color-primary);
    color: #ffffff;
}

.hero {
    padding: 4rem 5vw 3rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    align-items: center;
}

.hero__content {
    max-width: 540px;
}

.hero__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-size: 0.75rem;
    color: var(--color-secondary);
    margin-bottom: 0.5rem;
}

.hero__lead {
    font-size: 1.1rem;
    color: var(--color-muted);
}

.hero__actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.hero__stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    background: #ffffff;
    padding: 1.5rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow-soft);
}

.hero__stats strong {
    display: block;
    font-size: 1.8rem;
    color: var(--color-primary);
}

.hero__stats span {
    font-size: 0.9rem;
    color: var(--color-muted);
}

.section {
    padding: 3rem 5vw;
}

.section--highlight {
    background: #ffffff;
}

.section--alt {
    background: #0f172a;
    color: #f4f6f8;
}

.section__header {
    max-width: 640px;
    margin-bottom: 2rem;
}

.section__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.75rem;
    color: var(--color-secondary);
    margin-bottom: 0.4rem;
}

/* --- Warsztat Panel Tabs --- */
.tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}
.tab {
    background: #f4f6f8;
    border: none;
    border-radius: 6px 6px 0 0;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    color: #222;
    transition: background 0.2s, color 0.2s;
}
.tab.active {
    background: var(--color-primary);
    color: #fff;
    font-weight: bold;
}
.tab-content {
    background: #fff;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 2rem 1.5rem;
    margin-bottom: 2rem;
}
.notepad {
    width: 100%;
    min-height: 80px;
    margin-top: 1rem;
    padding: 0.7rem;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 1rem;
    resize: vertical;
}
.reports-placeholder, .logs-placeholder, .contacts-placeholder {
    color: #888;
    font-style: italic;
    margin: 1rem 0;
}

.card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
}

.card {
    background: var(--color-card);
    padding: 1.75rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow-soft);
}

.card h3 {
    margin-top: 0;
}

.vin-form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}

.vin-form input {
    flex: 1;
    min-width: 220px;
    padding: 0.9rem 1rem;
    border-radius: 999px;
    border: 1px solid #d0d7e2;
    font-size: 1rem;
}

.vin-result {
    min-height: 2rem;
    font-size: 0.95rem;
    color: var(--color-muted);
}

.vin-card-list {
    display: grid;
    gap: 1rem;
    margin-top: 1rem;
}

.vin-card {
    background: #f8fafc;
    border: 1px solid #e4e7eb;
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
}

.vin-card header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 0.95rem;
}

.vin-card footer {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--color-muted);
}

.steps {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
}

.steps li {
    background: rgba(255, 255, 255, 0.08);
    border-radius: var(--radius);
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.site-footer {
    margin-top: auto;
    padding: 1.5rem 5vw;
    background: #0b1624;
    color: #dbe2ef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}

.btn {
    border: none;
    border-radius: 999px;
    padding: 0.85rem 1.7rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn--primary {
    background: var(--color-primary);
    color: #ffffff;
    box-shadow: var(--shadow-soft);
}

.btn--secondary {
    background: var(--color-secondary);
    color: #ffffff;
}

.btn--ghost {
    border: 1px solid var(--color-primary);
    color: var(--color-primary);
    background: transparent;
}

.btn:hover {
    transform: translateY(-2px);
}

.ghost-link {
    color: #90a4b7;
    text-decoration: none;
    font-size: 0.85rem;
    opacity: 0.65;
}

.ghost-link:focus,
.ghost-link:hover {
    opacity: 1;
}

.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

.auth-body {
    background: radial-gradient(circle at top, #0b3d60, #050e17);
    min-height: 100vh;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.auth {
    width: min(1100px, 100%);
    background: #ffffff;
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: 0 30px 60px rgba(3, 18, 37, 0.35);
}

.auth__home-link {
    display: inline-flex;
    margin-bottom: 1rem;
}

.auth__intro {
    margin-bottom: 2rem;
}

.auth__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.3em;
    font-size: 0.75rem;
    color: var(--color-secondary);
}

.auth__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
}

.auth-card {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: var(--radius);
    border: 1px solid #e4e7eb;
}

.auth-card__hint {
    color: var(--color-muted);
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 1rem 0;
}

.auth-form label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.auth-form input {
    border-radius: 12px;
    border: 1px solid #d0d7e2;
    padding: 0.75rem 1rem;
    font-size: 1rem;
}

.auth-card__feedback {
    min-height: 1.5rem;
    font-size: 0.9rem;
    color: var(--color-muted);
}

.auth-card__feedback.is-success {
    color: #1b9c58;
}

.auth-card__feedback.is-error {
    color: #c92a2a;
}

.admin-tools {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #d0d7e2;
}

.auth-form--compact label input {
    background: #ffffff;
}

.workshop-list {
    margin-top: 1rem;
}

.workshop-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.workshop-list li {
    background: #ffffff;
    border-radius: 12px;
    padding: 0.9rem 1rem;
    border: 1px solid #e4e7eb;
    font-size: 0.9rem;
}

.auth-success {
    margin-top: 1rem;
    padding: 1rem;
    background: #e6f4ea;
    border-radius: 12px;
    border: 1px solid #b7dfc1;
}

.is-hidden {
    display: none !important;
}

@media (max-width: 768px) {
    .site-nav {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .site-footer {
        flex-direction: column;
        gap: 1rem;
    }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\auth\login.js
==========================================
(function () {
    const setFeedback = (element, message, type) => {
        if (!element) return;
        element.textContent = message;
        element.classList.remove('is-error', 'is-success');
        if (type) {
            element.classList.add(type === 'error' ? 'is-error' : 'is-success');
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Sprawdzamy czy API jest dostÄ™pne, ale nie blokujemy jeĹ›li brakuje Session (naprawimy to rÄ™cznie)
        if (!window.WarsztatApi) {
            console.error('Brakuje moduĹ‚u API');
            return;
        }

        const form = document.getElementById('unified-login-form');
        const feedback = document.querySelector('[data-feedback="login"]');
        const submitBtn = form?.querySelector('button[type="submit"]');

        form?.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            const identifier = String(formData.get('identifier') || '').trim();
            const password = String(formData.get('password') || '').trim();

            if (!identifier || !password) {
                setFeedback(feedback, 'UzupeĹ‚nij oba pola logowania.', 'error');
                return;
            }

            submitBtn?.setAttribute('disabled', 'true');
            setFeedback(feedback, 'Logowanie...', null);

            try {
                const payload = { email: identifier.toLowerCase(), password };
                const response = await window.WarsztatApi.post('/auth/login', payload, { auth: false });

                // --- POPRAWKA: BEZPOĹšREDNI ZAPIS TOKENA DLA PANELU ---
                // To gwarantuje, ĹĽe panel-warsztatu.html znajdzie token
                console.log("Logowanie udane, zapisujÄ™ token:", response.token);
                localStorage.setItem('token', response.token);
                sessionStorage.setItem('token', response.token);
                // -----------------------------------------------------

                // Opcjonalnie: stary sposĂłb zapisu (dla kompatybilnoĹ›ci wstecznej)
                if (window.WarsztatSession) {
                    window.WarsztatSession.save({
                        token: response.token,
                        role: response.role || 'workshop',
                        user: {
                            email: response.email || identifier,
                            workshopId: response.workshopId || null
                        }
                    });
                }

                setFeedback(feedback, 'Zalogowano pomyĹ›lnie. Przekierowuje...', 'success');

                // INTELIGENTNE PRZEKIEROWANIE
                // Czekamy chwilÄ™, ĹĽeby token na pewno siÄ™ zapisaĹ‚ w storage
                setTimeout(() => {
                    if (response.role === "admin" || response.isAdmin === true || (response.email && response.email.includes("admin"))) {
                        window.location.href = "panel.html";
                    } else {
                        window.location.href = "panel-warsztatu.html";
                    }
                }, 500);

            } catch (error) {
                console.error(error);
                const message = error.details?.message || error.message || 'Niepoprawny e-mail lub hasĹ‚o.';
                setFeedback(feedback, message, 'error');
            } finally {
                submitBtn?.removeAttribute('disabled');
            }
        });
    });
})();

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\landing\navToggle.js
==========================================
(function () {
    const nav = document.querySelector('.site-nav');
    const toggle = document.querySelector('.site-nav__toggle');
    if (!nav || !toggle) {
        return;
    }

    toggle.addEventListener('click', () => {
        const isOpen = nav.classList.toggle('is-open');
        toggle.setAttribute('aria-expanded', String(isOpen));
    });

    nav.addEventListener('click', (event) => {
        if (event.target.matches('a') && nav.classList.contains('is-open')) {
            nav.classList.remove('is-open');
            toggle.setAttribute('aria-expanded', 'false');
        }
    });
})();

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\landing\vinForm.js
==========================================
(function () {
    const VIN_FORM_ID = 'vin-form';
    const VIN_INPUT_ID = 'vin-input';
    const VIN_RESULT_ID = 'vin-result';
    const VIN_PATTERN = /^[A-HJ-NPR-Z0-9]{11,17}$/;

    const formatDate = (value) => {
        if (!value) {
            return 'Brak danych';
        }
        try {
            return new Date(value).toLocaleDateString('pl-PL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            return value;
        }
    };

    const formatMileage = (value) => {
        const mileage = Number(value);
        if (!Number.isFinite(mileage) || mileage < 0) {
            return 'Brak danych';
        }
        return `${mileage.toLocaleString('pl-PL')} km`;
    };

    const renderMediaList = (media = []) => {
        if (!media.length) {
            return '';
        }
        const items = media
            .map((item, index) => {
                const label = item.name || `Zalacznik ${index + 1}`;
                if (item.url) {
                    return `<li><a href="${item.url}" target="_blank" rel="noopener">${label}</a></li>`;
                }
                return `<li>${label}</li>`;
            })
            .join('');
        return `<ul class="vin-card-media">${items}</ul>`;
    };

    const renderResult = (container, vin, reports) => {
        if (!reports.length) {
            container.textContent = 'Brak zaakceptowanych raportow dla podanego VIN.';
            return;
        }

        const items = reports
            .map((report) => `
                <article class="vin-card">
                    <header>
                        <strong>${report.workshopName || 'Warsztat'}</strong>
                        <span>Status: ${report.status || 'â€”'}</span>
                    </header>
                    <div class="vin-card__meta">
                        <span>Rejestracja: ${report.registrationNumber || 'Brak danych'}</span>
                        <span>Przebieg: ${formatMileage(report.mileageKm)}</span>
                        <span>Pierwsza rejestracja: ${formatDate(report.firstRegistrationDate)}</span>
                    </div>
                    <p>${report.summary || 'Brak opisu naprawy.'}</p>
                    ${renderMediaList(report.media)}
                    <footer>Aktualizacja: ${formatDate(report.updatedAt)}</footer>
                </article>
            `)
            .join('');

        container.innerHTML = `
            <p>Znaleziono ${reports.length} raport(y) dla VIN <strong>${vin}</strong>:</p>
            <div class="vin-card-list">${items}</div>
        `;
    };

    document.addEventListener('DOMContentLoaded', () => {
        if (!window.WarsztatApi) {
            console.error('Brak klienta API');
            return;
        }

        const form = document.getElementById(VIN_FORM_ID);
        const input = document.getElementById(VIN_INPUT_ID);
        const result = document.getElementById(VIN_RESULT_ID);

        if (!form || !input || !result) {
            return;
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const vin = input.value.trim().toUpperCase();

            if (!VIN_PATTERN.test(vin)) {
                result.textContent = 'Podaj poprawny numer VIN (11-17 znakow, bez liter O oraz I).';
                return;
            }

            result.textContent = 'Trwa wyszukiwanie w bazie...';

            try {
                const reports = await window.WarsztatApi.get(`/reports/public/${vin}`, { auth: false });
                renderResult(result, vin, Array.isArray(reports) ? reports : []);
            } catch (error) {
                console.error('Nie udalo sie pobrac raportow', error);
                result.textContent = 'Nie udalo sie polaczyc z API. Sprobuj ponownie pozniej.';
            }
        });
    });
})();

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel\dashboard.js
==========================================
(function () {
    const LOGIN_URL = 'login.html';
    const APPROVAL_META = {
        pending: { label: 'Oczekuje na akceptacje', className: 'panel-tag--warning' },
        approved: { label: 'Zatwierdzony', className: 'panel-tag--success' },
        rejected: { label: 'Odrzucony', className: 'panel-tag--danger' }
    };
    const WORKSHOP_STATUS_META = {
        active: { label: 'Aktywny', className: 'panel-tag--success' },
        inactive: { label: 'Nieaktywny', className: 'panel-tag--muted' },
        notice: { label: 'W okresie wypowiedzenia', className: 'panel-tag--notice' },
        deactivated: { label: 'Dezaktywowany', className: 'panel-tag--danger' }
    };

    const formatDateTime = (value) => {
        if (!value) {
            return 'â€”';
        }
        try {
            return new Date(value).toLocaleString('pl-PL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return value;
        }
    };

    const formatShortDate = (value) => {
        if (!value) {
            return 'â€”';
        }
        try {
            return new Date(value).toLocaleDateString('pl-PL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            return value;
        }
    };

    const formatBillingMonth = (value) => {
        if (!value) {
            return 'Brak miesiaca';
        }
        const [year, month] = String(value)
            .split('-')
            .map((chunk) => Number(chunk));
        if (!year || !month) {
            return value;
        }
        try {
            const date = new Date(Date.UTC(year, month - 1, 1));
            return date.toLocaleDateString('pl-PL', { year: 'numeric', month: 'long' });
        } catch (error) {
            return value;
        }
    };

    const formatMileage = (value) => {
        if (value === null || typeof value === 'undefined') {
            return 'Brak danych';
        }
        const mileage = Number(value);
        if (!Number.isFinite(mileage) || mileage < 0) {
            return 'Brak danych';
        }
        return `${mileage.toLocaleString('pl-PL')} km`;
    };

    const formatCurrency = (value, currency = 'PLN') => {
        const amount = Number(value);
        if (!Number.isFinite(amount)) {
            return 'Brak danych';
        }
        try {
            return new Intl.NumberFormat('pl-PL', {
                style: 'currency',
                currency,
                minimumFractionDigits: 2
            }).format(amount);
        } catch (error) {
            return `${amount.toFixed(2)} ${currency}`;
        }
    };

    const getWorkshopInitials = (name) => {
        if (!name) {
            return 'W+';
        }
        const parts = String(name)
            .trim()
            .split(/\s+/)
            .filter((chunk) => chunk && /^[a-zA-ZÄ…Ä‡Ä™Ĺ‚Ĺ„ĂłĹ›ĹşĹĽÄ„Ä†ÄĹĹĂ“ĹšĹąĹ»]/.test(chunk))
            .slice(0, 2)
            .map((chunk) => chunk[0]?.toUpperCase())
            .filter(Boolean);
        return parts.length ? parts.join('') : 'W+';
    };

    const addMonths = (value, months) => {
        if (!value || !Number.isFinite(months)) {
            return null;
        }
        const date = new Date(value.getTime());
        date.setMonth(date.getMonth() + months);
        return date;
    };

    const monthsBetweenDates = (futureDate, baseDate = new Date()) => {
        if (!futureDate || !baseDate) {
            return null;
        }
        const years = futureDate.getFullYear() - baseDate.getFullYear();
        const months = futureDate.getMonth() - baseDate.getMonth();
        const totalMonths = years * 12 + months;
        const adjust = futureDate.getDate() >= baseDate.getDate() ? 0 : -1;
        return Math.max(0, totalMonths + adjust);
    };

    const getWorkshopLicenseSummary = (workshop) => {
        const licenseSetting = Number(state.settings?.licenseMonths);
        const startedAt = toDate(workshop.licenseStartedAt);
        const expiresAt = toDate(workshop.licenseExpiresAt) || (startedAt && addMonths(startedAt, licenseSetting));
        const noticeEndsAt = toDate(workshop.noticeEndsAt);
        const remainingMonths = expiresAt ? monthsBetweenDates(expiresAt) : null;
        return {
            expiresLabel: expiresAt ? formatShortDate(expiresAt) : null,
            remainingMonths,
            noticeEndsLabel: noticeEndsAt ? formatShortDate(noticeEndsAt) : null
        };
    };

    const toDate = (value) => {
        if (!value) {
            return null;
        }
        try {
            return new Date(value);
        } catch (error) {
            return null;
        }
    };

    const isSameDay = (value, reference = new Date()) => {
        const date = toDate(value);
        if (!date) {
            return false;
        }
        return (
            date.getFullYear() === reference.getFullYear() &&
            date.getMonth() === reference.getMonth() &&
            date.getDate() === reference.getDate()
        );
    };

    const daysBetween = (newer, older) => {
        if (!newer || !older) {
            return Infinity;
        }
        const ms = newer.getTime() - older.getTime();
        return Math.floor(ms / (1000 * 60 * 60 * 24));
    };

    const sortByDateDesc = (items, selector) =>
        [...items].sort((a, b) => {
            const left = toDate(selector(a))?.getTime() || 0;
            const right = toDate(selector(b))?.getTime() || 0;
            return right - left;
        });

    const setFeedback = (element, message, type) => {
        if (!element) {
            return;
        }
        element.textContent = message;
        element.classList.remove('is-error', 'is-success');
        if (type) {
            element.classList.add(type === 'error' ? 'is-error' : 'is-success');
        }
    };

    const handleAuthError = (error) => {
        if (error?.status === 401 || error?.status === 403) {
            window.WarsztatSession?.clear();
            window.location.href = LOGIN_URL;
            return true;
        }
        return false;
    };

    const normalizeString = (value) => String(value ?? '').trim();
    const toNullable = (value) => {
        const normalized = normalizeString(value);
        return normalized.length ? normalized : null;
    };
    const toOptional = (value) => {
        const normalized = normalizeString(value);
        return normalized.length ? normalized : undefined;
    };
    const toEmail = (value) => {
        const normalized = normalizeString(value).toLowerCase();
        return normalized.length ? normalized : null;
    };
    const toDateOnly = (value) => {
        const normalized = normalizeString(value);
        return normalized.length ? normalized : null;
    };
    const toMoneyValue = (value) => {
        if (value === null || typeof value === 'undefined') {
            return null;
        }
        const normalized = normalizeString(String(value).replace(',', '.'));
        if (!normalized) {
            return null;
        }
        const amount = Number(normalized);
        return Number.isFinite(amount) ? Number(amount.toFixed(2)) : null;
    };
    const toDateInputValue = (value) => {
        const date = toDate(value);
        if (!date) {
            return '';
        }
        return date.toISOString().slice(0, 10);
    };

    const state = {
        reports: [],
        media: [],
        news: [],
        workshops: [],
        settings: null,
        logs: [],
        filters: {
            vin: '',
            registration: '',
            approval: 'all'
        },
        workshopFilters: {
            query: '',
            status: 'all'
        },
        selectedReportId: null,
        editingWorkshopId: null,
        focusedWorkshopId: null,
        workshopDetailRecord: null,
        workshopDetails: null,
        workshopReports: [],
        workshopUploads: [],
        workshopUploadWarning: false,
        workshopDetailViewActive: false,
        workshopDetailLoading: false,
        workshopDetailError: null,
        workshopBillingEditId: null,
        metricDetails: {},
        metricDrawerKey: null,
        workshopDrawerOpen: false,
        session: null,
        isAdmin: true
    };

    const WORKSHOP_TOOLBAR_HINT_DEFAULT = 'Wybierz warsztat, aby zobaczyc szczegoly.';
    const elements = {};
    let workshopEventsBound = false;

    const setWorkshopToolbarHint = (message = WORKSHOP_TOOLBAR_HINT_DEFAULT) => {
        if (elements.workshopToolbarHint) {
            elements.workshopToolbarHint.textContent = message;
        }
    };

    const bindDom = () => {
        elements.username = document.getElementById('panel-username');
        elements.role = document.getElementById('panel-role');
        elements.logoutBtn = document.getElementById('logout-btn');
        elements.navButtons = document.querySelectorAll('.panel-nav__link');
        elements.views = document.querySelectorAll('.panel-view');
        elements.metrics = document.getElementById('overview-metrics');
        elements.overviewLogs = document.getElementById('overview-logs');
        elements.adminActions = document.getElementById('admin-actions');
        elements.reportList = document.getElementById('report-list');
        elements.reportFilterForm = document.getElementById('report-filter-form');
        elements.reportEditForm = document.getElementById('report-edit-form');
        elements.reportFeedback = document.getElementById('report-feedback');
        elements.reportMediaGallery = document.getElementById('report-media-gallery');
        elements.workshopList = document.getElementById('workshop-list');
        elements.workshopFilterForm = document.getElementById('workshop-filter-form');
        elements.workshopFilterReset = document.getElementById('workshop-filter-reset');
        elements.workshopAddBtn = document.getElementById('workshop-add-btn');
        elements.workshopToolbarList = document.getElementById('workshop-toolbar-list');
        elements.workshopToolbarDetail = document.getElementById('workshop-toolbar-detail');
        elements.workshopToolbarHint = document.getElementById('workshop-toolbar-hint');
        elements.workshopForm = document.getElementById('create-workshop-form');
        elements.workshopFeedback = document.getElementById('workshop-feedback');
        elements.workshopFormEyebrow = document.getElementById('workshop-drawer-eyebrow');
        elements.workshopFormTitle = document.getElementById('workshop-drawer-title');
        elements.workshopFormSubmit = document.querySelector('[data-workshop-form-submit]');
        elements.workshopCancelBtn = document.getElementById('workshop-cancel-edit');
        elements.workshopDrawer = document.getElementById('workshop-drawer');
        elements.workshopDrawerClose = document.getElementById('workshop-drawer-close');
        elements.workshopDrawerBackdrop = document.getElementById('workshop-drawer-backdrop');
        elements.settingsForm = document.getElementById('settings-form');
        elements.settingsFeedback = document.getElementById('settings-feedback');
        elements.logsContainer = document.getElementById('logs-full');
        elements.logsRefreshBtn = document.getElementById('logs-refresh-btn');
        elements.inactiveWorkshopsList = document.getElementById('inactive-workshops-list');
        elements.workshopDetails = document.getElementById('workshop-details');
        elements.workshopListView = document.getElementById('workshop-browser-list');
        elements.workshopDetailView = document.getElementById('workshop-browser-detail');
        elements.workshopReportList = document.getElementById('workshop-report-list');
        elements.workshopReportForm = document.getElementById('workshop-report-form');
        elements.workshopReportFeedback = document.getElementById('workshop-report-feedback');
        elements.workshopMediaPreview = document.getElementById('workshop-media-preview');
        elements.metricDrawer = document.getElementById('metric-drawer');
        elements.metricDrawerTitle = document.getElementById('metric-drawer-title');
        elements.metricDrawerEyebrow = document.getElementById('metric-drawer-eyebrow');
        elements.metricDrawerDescription = document.getElementById('metric-drawer-description');
        elements.metricDrawerContent = document.getElementById('metric-drawer-content');
        elements.metricDrawerClose = document.getElementById('metric-drawer-close');
        elements.metricDrawerBackdrop = document.getElementById('metric-drawer-backdrop');
        elements.workshopDetailTitle = document.getElementById('workshop-detail-title');
        elements.workshopDetailEyebrow = document.getElementById('workshop-detail-eyebrow');
        elements.workshopDetailBack = document.getElementById('workshop-detail-back');
        elements.workshopDetailOverview = document.getElementById('workshop-detail-overview');
        elements.workshopDetailSubscription = document.getElementById('workshop-detail-subscription');
        elements.workshopDetailFeedback = document.getElementById('workshop-detail-feedback');
        elements.workshopBillingList = document.getElementById('workshop-billing-list');
        elements.workshopBillingForm = document.getElementById('workshop-billing-form');
        elements.workshopBillingFeedback = document.getElementById('workshop-billing-feedback');
    };

    const disableLegacyViews = () => {
        const placeholders = [];
        placeholders.forEach((name) => {
            const view = document.querySelector(`[data-panel="${name}"]`);
            if (view) {
                view.innerHTML = `
                    <div class="panel-card">
                        <p class="panel-empty">Sekcja w przebudowie. Wkrotce dodamy nowe funkcjonalnosci.</p>
                    </div>
                `;
            }
        });
    };

    const renderWorkshopSummary = () => {
        if (!elements.workshopDetails) {
            return;
        }
        if (!state.workshopDetails) {
            elements.workshopDetails.innerHTML = '<p class="panel-empty">Trwa ladowanie profilu warsztatu...</p>';
            return;
        }
        const workshop = state.workshopDetails;
        const meta = WORKSHOP_STATUS_META[workshop.status] || WORKSHOP_STATUS_META.inactive;
        const address = [workshop.city, workshop.address].filter(Boolean).join(' â€˘ ');
        const contact = [workshop.email, workshop.phone].filter(Boolean).join(' â€˘ ');
        const loginEmail = state.session?.user?.email || workshop.loginEmail || workshop.email || 'Brak e-maila logowania';
        const licenseInfo = state.settings?.licenseMonths
            ? `Standardowa licencja: ${state.settings.licenseMonths} miesiecy.`
            : 'Licencja aktywna â€“ brak dodatkowych wymagan.';

        elements.workshopDetails.innerHTML = `
            <div>
                <strong>${workshop.name}</strong>
                <p>${address || 'Brak przypisanego adresu'}</p>
                <div class="workshop-summary__meta">
                    <span class="panel-tag ${meta.className}">${meta.label}</span>
                    <span>${loginEmail}</span>
                    ${contact ? `<span>${contact}</span>` : ''}
                </div>
            </div>
            <div class="workshop-summary__contract">
                <strong>Status licencji</strong>
                <p>${licenseInfo}</p>
                ${workshop.notes ? `<p class="panel-contract-info">${workshop.notes}</p>` : ''}
            </div>
        `;
    };

    const renderWorkshopReportList = () => {
        if (!elements.workshopReportList) {
            return;
        }
        if (!state.workshopReports.length) {
            elements.workshopReportList.innerHTML = '<p class="panel-empty">Nie dodales jeszcze zadnych raportow.</p>';
            return;
        }

        elements.workshopReportList.innerHTML = state.workshopReports
            .map((report) => {
                const approval = APPROVAL_META[report.approvalStatus] || APPROVAL_META.pending;
                const workshopStatus = report.status || 'W trakcie';
                const summary = report.summary || 'Brak opisu naprawy.';
                const note = report.moderationNote
                    ? `<div class="panel-report-note panel-report-note--danger">${report.moderationNote}</div>`
                    : '';
                return `
                <article class="panel-list__item panel-list__item--stacked">
                    <div>
                        <strong>${report.vin || 'Brak VIN'}</strong>
                        <ul class="panel-report-meta">
                            <li>Status warsztatu: ${workshopStatus}</li>
                            <li>Ostatnia aktualizacja: ${formatShortDate(report.updatedAt)}</li>
                            <li>Rejestracja: ${report.registrationNumber || 'Brak danych'}</li>
                        </ul>
                        <p>${summary}</p>
                        ${note}
                    </div>
                    <div class="panel-list__item-actions panel-list__item-actions--compact">
                        <span class="panel-tag ${approval.className}">${approval.label}</span>
                        <small>${report.approvalStatus === 'approved' ? 'Zatwierdzono' : 'Oczekuje na akceptacje'}</small>
                    </div>
                </article>
            `;
            })
            .join('');
    };

    const renderWorkshopUploads = () => {
        if (!elements.workshopMediaPreview) {
            return;
        }
        if (!state.workshopUploads.length) {
            const message = state.workshopUploadWarning
                ? 'Wybrano za duzo plikow. Maksymalnie 5 zalacznikow zostanie zachowanych.'
                : 'Nie wybrano plikow. Zalaczniki beda wysylane w kolejnej iteracji.';
            elements.workshopMediaPreview.innerHTML = `<li class="panel-upload__warning">${message}</li>`;
            return;
        }
        let items = state.workshopUploads
            .map((file) => {
                const sizeMb = Math.max(file.size / (1024 * 1024), 0.01).toFixed(2);
                return `<li><span>${file.name}</span><small>${sizeMb} MB</small></li>`;
            })
            .join('');
        if (state.workshopUploadWarning) {
            items += '<li class="panel-upload__warning">Tylko pierwszych 5 plikow zostalo dodanych.</li>';
        }
        elements.workshopMediaPreview.innerHTML = items;
    };

    const renderMetricDrawer = (detail) => {
        if (!elements.metricDrawer) {
            return;
        }
        elements.metricDrawerTitle.textContent = detail?.title || 'Szczegoly';
        elements.metricDrawerEyebrow.textContent = detail?.eyebrow || '';
        elements.metricDrawerDescription.textContent = detail?.description || '';
        if (!detail?.items?.length) {
            elements.metricDrawerContent.innerHTML = '<p class="panel-empty">Brak danych do wyswietlenia.</p>';
            return;
        }
        elements.metricDrawerContent.innerHTML = detail.items
            .map((item) => {
                const subtitle = item.subtitle ? `<small>${item.subtitle}</small>` : '';
                const meta = item.meta ? `<small>${item.meta}</small>` : '';
                return `
                <div class="panel-drawer__item">
                    <strong>${item.title}</strong>
                    ${subtitle}
                    ${meta}
                </div>
            `;
            })
            .join('');
    };

    const openMetricDrawer = (key) => {
        const detail = state.metricDetails[key];
        if (!detail || !detail.items?.length) {
            return;
        }
        state.metricDrawerKey = key;
        renderMetricDrawer(detail);
        elements.metricDrawer?.classList.add('is-open');
        elements.metricDrawer?.setAttribute('aria-hidden', 'false');
        if (elements.metricDrawerBackdrop) {
            elements.metricDrawerBackdrop.hidden = false;
        }
    };

    const closeMetricDrawer = () => {
        state.metricDrawerKey = null;
        elements.metricDrawer?.classList.remove('is-open');
        elements.metricDrawer?.setAttribute('aria-hidden', 'true');
        if (elements.metricDrawerBackdrop) {
            elements.metricDrawerBackdrop.hidden = true;
        }
    };

    const focusWorkshopFormFirstField = () => {
        const firstField = elements.workshopForm?.querySelector('input, select, textarea');
        if (firstField) {
            window.requestAnimationFrame(() => firstField.focus());
        }
    };

    const openWorkshopDrawer = () => {
        if (!elements.workshopDrawer) {
            return;
        }
        elements.workshopDrawer.classList.add('is-open');
        elements.workshopDrawer.setAttribute('aria-hidden', 'false');
        if (elements.workshopDrawerBackdrop) {
            elements.workshopDrawerBackdrop.hidden = false;
        }
        state.workshopDrawerOpen = true;
        focusWorkshopFormFirstField();
    };

    const closeWorkshopDrawer = () => {
        if (!elements.workshopDrawer) {
            return;
        }
        elements.workshopDrawer.classList.remove('is-open');
        elements.workshopDrawer.setAttribute('aria-hidden', 'true');
        if (elements.workshopDrawerBackdrop) {
            elements.workshopDrawerBackdrop.hidden = true;
        }
        state.workshopDrawerOpen = false;
    };

    const loadWorkshopDashboard = async () => {
        try {
            setFeedback(elements.workshopReportFeedback, 'Ladowanie danych warsztatu...', null);
            const [workshop, reports, settings] = await Promise.all([
                window.WarsztatApi.get('/workshops/me'),
                window.WarsztatApi.get('/reports/mine'),
                window.WarsztatApi.get('/settings')
            ]);
            state.workshopDetails = workshop || null;
            state.workshopReports = Array.isArray(reports) ? reports : [];
            state.settings = settings || state.settings;
            renderWorkshopSummary();
            renderWorkshopReportList();
            setFeedback(elements.workshopReportFeedback, 'Dane zaladowane. Mozesz dodawac raporty.', 'success');
        } catch (error) {
            if (handleAuthError(error)) {
                return;
            }
            const message = error.details?.message || 'Nie udalo sie pobrac danych warsztatu.';
            setFeedback(elements.workshopReportFeedback, message, 'error');
        }
    };

    const bindWorkshopEvents = () => {
        if (workshopEventsBound) {
            return;
        }
        workshopEventsBound = true;

        const mediaInput = elements.workshopReportForm?.querySelector('input[name="mediaFiles"]');
        mediaInput?.addEventListener('change', (event) => {
            const files = Array.from(event.target.files || []);
            const limited = files.slice(0, 5);
            state.workshopUploadWarning = files.length > limited.length;
            state.workshopUploads = limited;
            renderWorkshopUploads();
        });

        elements.workshopReportForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            const data = new FormData(elements.workshopReportForm);
            const vin = normalizeString(data.get('vin')).toUpperCase();
            const registrationNumber = normalizeString(data.get('registrationNumber')).toUpperCase();
            const summary = String(data.get('summary') || '').trim();
            const firstRegistrationDate = normalizeString(data.get('firstRegistrationDate')) || null;
            const mileageValue = Number(data.get('mileageKm'));
            const mileageKm = Number.isFinite(mileageValue) && mileageValue >= 0 ? mileageValue : null;

            if (!vin) {
                setFeedback(elements.workshopReportFeedback, 'Podaj numer VIN.', 'error');
                return;
            }
            if (!registrationNumber) {
                setFeedback(elements.workshopReportFeedback, 'Podaj numer rejestracyjny.', 'error');
                return;
            }
            if (!firstRegistrationDate) {
                setFeedback(elements.workshopReportFeedback, 'Podaj date pierwszej rejestracji.', 'error');
                return;
            }
            if (summary.length < 10) {
                setFeedback(elements.workshopReportFeedback, 'Opis powinien miec co najmniej 10 znakow.', 'error');
                return;
            }

            const payload = {
                vin,
                registrationNumber,
                mileageKm,
                firstRegistrationDate,
                summary,
                status: 'W trakcie'
            };

            try {
                setFeedback(elements.workshopReportFeedback, 'Wysylanie raportu...', null);
                const report = await window.WarsztatApi.post('/reports/mine', payload);
                state.workshopReports = [report, ...state.workshopReports];
                elements.workshopReportForm?.reset();
                state.workshopUploads = [];
                state.workshopUploadWarning = false;
                renderWorkshopUploads();
                renderWorkshopReportList();
                setFeedback(elements.workshopReportFeedback, 'Raport przekazany do administratora.', 'success');
            } catch (error) {
                if (handleAuthError(error)) {
                    return;
                }
                const message = error.details?.message || 'Nie udalo sie zapisac raportu.';
                setFeedback(elements.workshopReportFeedback, message, 'error');
            }
        });
    };

    const handleMetricClick = (event) => {
        const trigger = event.target.closest('[data-metric-key]');
        if (!trigger) {
            return;
        }
        if (!trigger.classList.contains('metric-card--action')) {
            return;
        }
        const key = trigger.dataset.metricKey;
        if (!key) {
            return;
        }
        openMetricDrawer(key);
    };

    const handleDrawerKeydown = (event) => {
        if (event.key !== 'Escape') {
            return;
        }
        if (state.metricDrawerKey) {
            closeMetricDrawer();
            return;
        }
        if (state.workshopDetailViewActive) {
            hideWorkshopDetailView();
            return;
        }
        if (state.workshopDrawerOpen) {
            closeWorkshopDrawer();
            resetWorkshopForm();
            setFeedback(elements.workshopFeedback, '', null);
        }
    };

    const activateWorkshopMode = (session) => {
        document.body.classList.add('panel-body--workshop');
        elements.navButtons?.forEach((btn) => {
            btn.style.display = 'none';
        });
        elements.views?.forEach((view) => {
            const isWorkshopView = view.dataset.panel === 'workshop-home';
            view.classList.toggle('is-active', isWorkshopView);
            if (!isWorkshopView) {
                view.remove();
            }
        });

        if (elements.username) {
            elements.username.textContent = session.user?.email || 'Warsztat';
        }
        if (elements.role) {
            elements.role.textContent = 'Warsztat';
        }

        bindWorkshopEvents();
        renderWorkshopSummary();
        renderWorkshopReportList();
        renderWorkshopUploads();
        loadWorkshopDashboard();
    };

    const activateView = (target) => {
        const alreadyActive = elements.navButtons
            ? Array.from(elements.navButtons).some(
                  (btn) => btn.dataset.panelTarget === target && btn.classList.contains('is-active')
              )
            : false;
        if (!alreadyActive) {
            elements.navButtons?.forEach((btn) => {
                btn.classList.toggle('is-active', btn.dataset.panelTarget === target);
            });
            elements.views?.forEach((view) => {
                view.classList.toggle('is-active', view.dataset.panel === target);
            });
        }

        if (target !== 'workshops' && state.workshopDrawerOpen) {
            closeWorkshopDrawer();
            resetWorkshopForm();
            setFeedback(elements.workshopFeedback, '', null);
        }
        if (target !== 'workshops' && state.workshopDetailViewActive) {
            hideWorkshopDetailView();
        }
    };

    const applyFilters = () => {
        const vinFilter = state.filters.vin.trim().toUpperCase();
        const regFilter = state.filters.registration.trim().toUpperCase();
        const approvalFilter = state.filters.approval;
        return state.reports.filter((report) => {
            const matchesVin = vinFilter ? report.vin?.includes(vinFilter) : true;
            const matchesReg = regFilter ? report.registrationNumber?.includes(regFilter) : true;
            const matchesApproval = approvalFilter === 'all' ? true : report.approvalStatus === approvalFilter;
            return matchesVin && matchesReg && matchesApproval;
        });
    };

    const renderOverview = () => {
        if (!elements.metrics) {
            return;
        }
        const metrics = buildOverviewMetrics();
        elements.metrics.innerHTML = metrics
            .map((metric) => {
                const tag = metric.clickable ? 'button' : 'article';
                const attrs = metric.clickable
                    ? `type="button" class="metric-card metric-card--action" data-metric-key="${metric.key}"`
                    : `class="metric-card" data-metric-key="${metric.key}"`;
                return `
                <${tag} ${attrs}>
                    <strong>${metric.value}</strong>
                    <p>${metric.label}</p>
                    <small>${metric.detail}</small>
                </${tag}>
            `;
            })
            .join('');

        if (elements.overviewLogs) {
            elements.overviewLogs.innerHTML = '<li class="panel-empty">Logi pojawia sie po wdrozeniu modulu audytu.</li>';
        }
        if (elements.adminActions) {
            elements.adminActions.innerHTML = '<li class="panel-empty">Lista akcji administratorow wkrotce bedzie dostepna.</li>';
        }

        renderInactiveWorkshops();
    };

    const renderReportList = () => {
        if (!elements.reportList) {
            return;
        }
        const filtered = applyFilters();
        if (!filtered.length) {
            elements.reportList.innerHTML = '<p class="panel-empty">Brak raportow spelniajacych kryteria.</p>';
            return;
        }
        elements.reportList.innerHTML = filtered
            .map((report) => {
                const approval = APPROVAL_META[report.approvalStatus] || APPROVAL_META.pending;
                return `
                <button class="panel-list__item" data-report-id="${report.id}" type="button">
                    <div>
                        <strong>${report.vin || 'Nieznany VIN'}</strong>
                        <p>${report.workshopName || 'Warsztat bez nazwy'}</p>
                    </div>
                    <div class="panel-list__meta">
                        <span class="panel-tag ${approval.className}">${approval.label}</span>
                        <small>Aktualizacja: ${formatShortDate(report.updatedAt)}</small>
                    </div>
                </button>
            `;
            })
            .join('');
    };

    const applyWorkshopFilters = () => {
        const query = state.workshopFilters.query.toLowerCase();
        const status = state.workshopFilters.status;
        return state.workshops.filter((workshop) => {
            const matchesQuery = query
                ? ['name', 'email', 'city', 'address'].some((field) =>
                      String(workshop[field] || '').toLowerCase().includes(query)
                  )
                : true;
            const matchesStatus = status === 'all' ? true : workshop.status === status;
            return matchesQuery && matchesStatus;
        });
    };

    const buildWorkshopActivityIndex = () => {
        const stats = new Map();
        state.reports.forEach((report) => {
            if (!report.workshopId) {
                return;
            }
            const current = stats.get(report.workshopId) || { count: 0, lastReportAt: null };
            current.count += 1;
            const updatedAt = toDate(report.updatedAt) || toDate(report.createdAt);
            if (updatedAt && (!current.lastReportAt || updatedAt > current.lastReportAt)) {
                current.lastReportAt = updatedAt;
            }
            stats.set(report.workshopId, current);
        });
        return stats;
    };

    const renderWorkshopList = () => {
        if (!elements.workshopList) {
            return;
        }
        const workshops = applyWorkshopFilters();
        const activityIndex = buildWorkshopActivityIndex();
        if (!workshops.length) {
            elements.workshopList.innerHTML = '<p class="panel-empty">Brak warsztatow spelniajacych kryteria.</p>';
            return;
        }
        elements.workshopList.innerHTML = workshops
            .map((workshop) => {
                const meta = WORKSHOP_STATUS_META[workshop.status] || WORKSHOP_STATUS_META.inactive;
                const workshopName = (workshop.name || '').trim();
                const displayName = workshopName || 'Brak nazwy';
                const location = [workshop.city, workshop.address].filter(Boolean).join(' â€˘ ');
                const stats = activityIndex.get(workshop.id) || { count: 0, lastReportAt: null };
                const lastActivity = stats.lastReportAt ? formatShortDate(stats.lastReportAt) : 'Brak danych';
                const emailValue = workshop.email || 'Brak adresu e-mail';
                const phoneValue = workshop.phone || 'Brak numeru telefonu';
                return `
                <article class="panel-workshop-card" data-workshop-id="${workshop.id}" data-workshop-card>
                    <div class="panel-workshop-card__header">
                        <div class="panel-workshop-card__identity">
                            <span class="panel-workshop-card__avatar" aria-hidden="true">${getWorkshopInitials(displayName)}</span>
                            <div>
                                <strong title="${displayName}">${displayName}</strong>
                                <p class="panel-workshop-card__location">${location || 'Brak lokalizacji'}</p>
                            </div>
                        </div>
                        <span class="panel-tag ${meta.className}">${meta.label}</span>
                    </div>
                    <div class="panel-workshop-card__contact" aria-label="Dane kontaktowe">
                        <div class="panel-workshop-card__contact-item">
                            <small>Email</small>
                            <span>${emailValue}</span>
                        </div>
                        <div class="panel-workshop-card__contact-item">
                            <small>Telefon</small>
                            <span>${phoneValue}</span>
                        </div>
                    </div>
                    <div class="panel-workshop-card__stats" aria-label="Aktywnosc warsztatu">
                        <div class="panel-workshop-card__stat">
                            <small>Raporty</small>
                            <strong>${stats.count}</strong>
                        </div>
                        <div class="panel-workshop-card__stat">
                            <small>Ostatnia aktywnosc</small>
                            <strong>${lastActivity}</strong>
                        </div>
                    </div>
                    <div class="panel-workshop-card__actions">
                        <!-- UsuniÄ™to przycisk Edytuj -->
                    </div>
                </article>
            `;
            })
            .join('');
    };

    const getWorkshopSubscriptionSnapshot = (workshop) => {
        if (!workshop) {
            return null;
        }
        const startDate = toDate(workshop.subscriptionStartDate);
        const periodEnd = startDate ? addMonths(startDate, 12) : null;
        const now = new Date();
        let phaseLabel = 'Brak danych';
        if (workshop.status === 'deactivated') {
            phaseLabel = 'Konto dezaktywowane';
        } else if (workshop.status === 'inactive') {
            phaseLabel = 'Nieaktywne';
        } else if (workshop.status === 'notice') {
            phaseLabel = 'W okresie wypowiedzenia';
        } else if (periodEnd) {
            phaseLabel = now < periodEnd ? 'Okres podstawowy' : 'Czas nieokreslony';
        }

        return {
            phaseLabel,
            startLabel: startDate ? formatShortDate(startDate) : 'Brak danych',
            endLabel: periodEnd ? formatShortDate(periodEnd) : 'Brak danych',
            amountLabel: typeof workshop.subscriptionAmount !== 'undefined' && workshop.subscriptionAmount !== null
                ? formatCurrency(workshop.subscriptionAmount)
                : 'Brak danych',
            initialAmountLabel:
                typeof workshop.subscriptionInitialAmount !== 'undefined' && workshop.subscriptionInitialAmount !== null
                    ? formatCurrency(workshop.subscriptionInitialAmount)
                    : null,
            initialNote: workshop.subscriptionInitialNote || null,
            billingEmail: workshop.billingEmail || null
        };
    };

    const renderWorkshopDetailOverview = () => {
        if (!elements.workshopDetailOverview) {
            return;
        }
        if (state.workshopDetailLoading) {
            setWorkshopToolbarHint('Ladowanie profilu warsztatu...');
            elements.workshopDetailOverview.innerHTML = '<p class="panel-empty">Ladowanie danych warsztatu...</p>';
            return;
        }
        if (state.workshopDetailError) {
            setWorkshopToolbarHint('Nie udalo sie pobrac danych warsztatu.');
            elements.workshopDetailOverview.innerHTML = `<p class="panel-empty">${state.workshopDetailError}</p>`;
            return;
        }
        if (!state.workshopDetailRecord) {
            setWorkshopToolbarHint(WORKSHOP_TOOLBAR_HINT_DEFAULT);
            elements.workshopDetailOverview.innerHTML = '<p class="panel-empty">Wybierz warsztat z listy, aby zobaczyc szczegoly.</p>';
            return;
        }

        const workshop = state.workshopDetailRecord;
        const meta = WORKSHOP_STATUS_META[workshop.status] || WORKSHOP_STATUS_META.inactive;
        const location = [workshop.city, workshop.address].filter(Boolean).join(' â€˘ ') || 'Brak lokalizacji';
        const contacts = [workshop.email, workshop.phone].filter(Boolean);
        const billingLine = workshop.billingEmail ? `<span>Faktury: ${workshop.billingEmail}</span>` : '';
        const isActive = workshop.status === 'active' || workshop.status === 'notice';
        const nextStatus = isActive ? 'deactivated' : 'active';
        const toggleLabel = isActive ? 'Dezaktywuj konto' : 'Aktywuj konto';

        if (elements.workshopDetailTitle) {
            elements.workshopDetailTitle.textContent = workshop.name || 'Warsztat';
        }
        if (elements.workshopDetailEyebrow) {
            elements.workshopDetailEyebrow.textContent = workshop.city || 'Profil warsztatu';
        }
        setWorkshopToolbarHint(`Profil: ${workshop.name || 'Warsztat'}`);

        elements.workshopDetailOverview.innerHTML = `
            <div class="workshop-detail__header">
                <div>
                    <h4>${workshop.name || 'Warsztat bez nazwy'}</h4>
                    <p class="workshop-detail__address">${location}</p>
                    <div class="workshop-detail__meta">
                        <span class="panel-tag ${meta.className}">${meta.label}</span>
                        ${contacts.map((item) => `<span>${item}</span>`).join('')}
                        ${billingLine}
                    </div>
                </div>
                <div class="workshop-detail__actions">
                    <button class="btn btn--ghost" type="button" data-workshop-detail-action="toggle-status" data-next-status="${nextStatus}">${toggleLabel}</button>
                    <!-- UsuniÄ™to przycisk Edytuj dane -->
                </div>
            </div>
            ${workshop.notes ? `<p class="workshop-detail__notes">${workshop.notes}</p>` : ''}
        `;
    };

    const renderWorkshopDetailSubscription = () => {
        if (!elements.workshopDetailSubscription) {
            return;
        }
        if (state.workshopDetailLoading) {
            elements.workshopDetailSubscription.innerHTML = '<p class="panel-empty">Trwa pobieranie informacji o abonamencie...</p>';
            return;
        }
        if (!state.workshopDetailRecord) {
            elements.workshopDetailSubscription.innerHTML = '<p class="panel-empty">Brak danych abonamentu.</p>';
            return;
        }
        const snapshot = getWorkshopSubscriptionSnapshot(state.workshopDetailRecord);
        if (!snapshot) {
            elements.workshopDetailSubscription.innerHTML = '<p class="panel-empty">Brak danych abonamentu.</p>';
            return;
        }

        const items = [
            { label: 'Status abonamentu', value: snapshot.phaseLabel },
            { label: 'Kwota miesieczna', value: snapshot.amountLabel },
            { label: 'Start umowy', value: snapshot.startLabel },
            { label: 'Koniec okresu 12 mies.', value: snapshot.endLabel },
            { label: 'E-mail do faktur', value: snapshot.billingEmail || 'Brak danych' }
        ];

        let html = items
            .map(
                (item) => `
                    <article class="workshop-detail__stat">
                        <small>${item.label}</small>
                        <strong>${item.value}</strong>
                    </article>
                `
            )
            .join('');

        if (snapshot.initialAmountLabel || snapshot.initialNote) {
            html += `
                <article class="workshop-detail__stat workshop-detail__stat--accent">
                    <small>Kwota startowa</small>
                    <strong>${snapshot.initialAmountLabel || 'Brak danych'}</strong>
                    ${snapshot.initialNote ? `<span>${snapshot.initialNote}</span>` : ''}
                </article>
            `;
        }

        elements.workshopDetailSubscription.innerHTML = html;
    };

    const getBillingMonthValue = (value) => {
        if (!value) {
            return 0;
        }
        const [year, month] = String(value)
            .split('-')
            .map((chunk) => Number(chunk));
        if (!year || !month) {
            return 0;
        }
        return new Date(year, month - 1, 1).getTime();
    };

    const sortBillingHistory = (history) =>
        [...history].sort((a, b) => getBillingMonthValue(b.month) - getBillingMonthValue(a.month));

    const renderWorkshopBillingList = () => {
        if (!elements.workshopBillingList) {
            return;
        }
        if (state.workshopDetailLoading) {
            elements.workshopBillingList.innerHTML = '<li class="panel-empty">Ladowanie historii platnosci...</li>';
            return;
        }
        const history = Array.isArray(state.workshopDetailRecord?.billingHistory)
            ? sortBillingHistory(state.workshopDetailRecord.billingHistory)
            : null;
        if (!Array.isArray(history) || !history.length) {
            elements.workshopBillingList.innerHTML = '<li class="panel-empty">Brak zapisanych rozliczen.</li>';
            return;
        }
        elements.workshopBillingList.innerHTML = history
            .map((entry) => {
                const statusLabel = entry.status === 'paid' ? 'Oplacona' : 'Nieoplacona';
                const monthLabel = formatBillingMonth(entry.month);
                const amountLabel = typeof entry.amount !== 'undefined' ? formatCurrency(entry.amount) : 'Brak kwoty';
                const noteBlock = entry.note ? `<p>${entry.note}</p>` : '';
                const invoice = entry.invoiceNumber ? `<span>Faktura: ${entry.invoiceNumber}</span>` : '';
                const hasActions = Boolean(entry.id);
                const statusClass = entry.status === 'paid' ? 'paid' : 'unpaid';
                const actions = hasActions
                    ? `
                        <div class="workshop-billing-item__actions">
                            <button type="button" class="btn btn--ghost" data-billing-action="toggle-status" data-billing-id="${entry.id}" data-billing-next-status="${entry.status === 'paid' ? 'unpaid' : 'paid'}">
                                ${entry.status === 'paid' ? 'Oznacz jako nieoplacona' : 'Oznacz jako oplacona'}
                            </button>
                            <button type="button" class="btn btn--ghost" data-billing-action="edit" data-billing-id="${entry.id}">Edytuj</button>
                        </div>
                    `
                    : '';
                return `
                <li class="workshop-billing-item" data-billing-id="${entry.id || ''}">
                    <div class="workshop-billing-item__main">
                        <strong>${monthLabel}</strong>
                        <small>${amountLabel}</small>
                        ${invoice}
                        ${noteBlock}
                    </div>
                    <div class="workshop-billing-item__meta">
                        <span class="workshop-billing-item__status workshop-billing-item__status--${statusClass}">${statusLabel}</span>
                        ${actions}
                    </div>
                </li>
            `;
            })
            .join('');
    };

    const renderWorkshopDetail = () => {
        renderWorkshopDetailOverview();
        renderWorkshopDetailSubscription();
        renderWorkshopBillingList();
    };

    const upsertBillingEntry = (entry) => {
        if (!entry) {
            return;
        }
        if (!state.workshopDetailRecord) {
            state.workshopDetailRecord = { id: state.focusedWorkshopId, billingHistory: [] };
        }
        if (!Array.isArray(state.workshopDetailRecord.billingHistory)) {
            state.workshopDetailRecord.billingHistory = [];
        }
        const history = [...state.workshopDetailRecord.billingHistory];
        if (entry.id) {
            const existingIndex = history.findIndex((item) => item.id === entry.id);
            if (existingIndex >= 0) {
                history[existingIndex] = entry;
            } else {
                history.push(entry);
            }
        } else {
            history.push(entry);
        }
        state.workshopDetailRecord.billingHistory = sortBillingHistory(history);
        renderWorkshopBillingList();
    };

    const populateBillingFormEntry = (entry) => {
        if (!elements.workshopBillingForm || !entry) {
            return;
        }
        const setFieldValue = (name, value) => {
            const field = elements.workshopBillingForm.querySelector(`[name="${name}"]`);
            if (field) {
                field.value = value ?? '';
            }
        };
        setFieldValue('billingMonth', entry.month || '');
        setFieldValue('billingAmount', entry.amount ?? '');
        setFieldValue('billingInvoiceNumber', entry.invoiceNumber || '');
        setFieldValue('billingStatus', entry.status || 'unpaid');
        const noteField = elements.workshopBillingForm.querySelector('[name="billingNote"]');
        if (noteField) {
            noteField.value = entry.note || '';
        }
        const submitBtn = elements.workshopBillingForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Aktualizuj platnosc';
        }
        state.workshopBillingEditId = entry.id || null;
        setFeedback(
            elements.workshopBillingFeedback,
            `Edytujesz rozliczenie za ${formatBillingMonth(entry.month)}.`,
            null
        );
    };

    const handleBillingEdit = (billingId) => {
        if (!billingId || !state.workshopDetailRecord || !Array.isArray(state.workshopDetailRecord.billingHistory)) {
            return;
        }
        const entry = state.workshopDetailRecord.billingHistory.find((item) => String(item.id) === String(billingId));
        if (entry) {
            populateBillingFormEntry(entry);
        }
    };

    const handleBillingToggleStatus = async (entryId, nextStatus) => {
        if (!state.focusedWorkshopId || !entryId || !nextStatus) {
            return;
        }
        try {
            setFeedback(elements.workshopBillingFeedback, 'Aktualizowanie statusu platnosci...', null);
            const entry = await window.WarsztatApi.patch(
                `/workshops/${state.focusedWorkshopId}/billing/${entryId}`,
                { status: nextStatus }
            );
            upsertBillingEntry(entry);
            setFeedback(elements.workshopBillingFeedback, 'Status platnosci zaktualizowany.', 'success');
        } catch (error) {
            if (handleAuthError(error)) {
                return;
            }
            const message = error.details?.message || 'Nie udalo sie zaktualizowac statusu platnosci.';
            setFeedback(elements.workshopBillingFeedback, message, 'error');
        }
    };

    const handleBillingListClick = (event) => {
        const actionBtn = event.target.closest('[data-billing-action]');
        if (!actionBtn) {
            return;
        }
        const billingId = actionBtn.dataset.billingId;
        const action = actionBtn.dataset.billingAction;
        if (action === 'edit') {
            handleBillingEdit(billingId);
            return;
        }
        if (action === 'toggle-status') {
            const nextStatus = actionBtn.dataset.billingNextStatus;
            handleBillingToggleStatus(billingId, nextStatus);
        }
    };

    const handleBillingFormSubmit = async (event) => {
        event.preventDefault();
        if (!state.focusedWorkshopId) {
            setFeedback(elements.workshopBillingFeedback, 'Najpierw wybierz warsztat.', 'error');
            return;
        }
        if (!elements.workshopBillingForm) {
            return;
        }
        const data = new FormData(elements.workshopBillingForm);
        const monthValue = normalizeString(data.get('billingMonth'));
        const amountValue = toMoneyValue(data.get('billingAmount'));
        if (!monthValue) {
            setFeedback(elements.workshopBillingFeedback, 'Wybierz miesiac rozliczenia.', 'error');
            return;
        }
        if (amountValue === null) {
            setFeedback(elements.workshopBillingFeedback, 'Podaj kwote faktury.', 'error');
            return;
        }
        const statusRaw = String(data.get('billingStatus') || 'unpaid');
        const normalizedStatus = statusRaw === 'paid' ? 'paid' : 'unpaid';
        const payload = {
            month: monthValue,
            amount: amountValue,
            invoiceNumber: toOptional(data.get('billingInvoiceNumber')),
            status: normalizedStatus,
            note: toOptional(data.get('billingNote'))
        };

        try {
            setFeedback(elements.workshopBillingFeedback, 'Zapisywanie platnosci...', null);
            let entry;
            if (state.workshopBillingEditId) {
                entry = await window.WarsztatApi.patch(
                    `/workshops/${state.focusedWorkshopId}/billing/${state.workshopBillingEditId}`,
                    payload
                );
            } else {
                entry = await window.WarsztatApi.post(`/workshops/${state.focusedWorkshopId}/billing`, payload);
            }
            upsertBillingEntry(entry);
            resetWorkshopBillingForm();
            setFeedback(elements.workshopBillingFeedback, 'Platnosc zostala zapisana.', 'success');
        } catch (error) {
            if (handleAuthError(error)) {
                return;
            }
            const message = error.details?.message || 'Nie udalo sie zapisac platnosci.';
            setFeedback(elements.workshopBillingFeedback, message, 'error');
        }
    };

    const handleWorkshopStatusToggle = async (nextStatus) => {
        if (!nextStatus || !state.focusedWorkshopId) {
            return;
        }
        try {
            setFeedback(elements.workshopDetailFeedback, 'Aktualizowanie statusu...', null);
            const updated = await window.WarsztatApi.patch(`/workshops/${state.focusedWorkshopId}`, {
                status: nextStatus
            });
            state.workshops = state.workshops.map((item) => (item.id === updated.id ? updated : item));
            state.workshopDetailRecord = updated;
            setFeedback(elements.workshopDetailFeedback, 'Status zostal zaktualizowany.', 'success');
            renderWorkshopList();
            renderOverview();
            renderWorkshopDetail();
        } catch (error) {
            if (handleAuthError(error)) {
                return;
            }
            const message = error.details?.message || 'Nie udalo sie zmienic statusu warsztatu.';
            setFeedback(elements.workshopDetailFeedback, message, 'error');
        }
    };

    const handleWorkshopDetailClick = (event) => {
        const editBtn = event.target.closest('[data-workshop-action="edit"]');
        if (editBtn) {
            const workshopId = editBtn.dataset.workshopId;
            hideWorkshopDetailView();
            handleWorkshopEditSelect(workshopId);
            return;
        }
        const toggleBtn = event.target.closest('[data-workshop-detail-action="toggle-status"]');
        if (toggleBtn) {
            const nextStatus = toggleBtn.dataset.nextStatus;
            handleWorkshopStatusToggle(nextStatus);
        }
    };

    const resetWorkshopBillingForm = () => {
        elements.workshopBillingForm?.reset();
        state.workshopBillingEditId = null;
        setFeedback(elements.workshopBillingFeedback, '', null);
        const submitBtn = elements.workshopBillingForm?.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Zapisz platnosc';
        }
    };

    const showWorkshopDetailView = () => {
        if (!elements.workshopDetailView) {
            return;
        }
        if (elements.workshopListView) {
            elements.workshopListView.hidden = true;
        }
        elements.workshopDetailView.hidden = false;
        if (elements.workshopToolbarList) {
            elements.workshopToolbarList.hidden = true;
        }
        if (elements.workshopToolbarDetail) {
            elements.workshopToolbarDetail.hidden = false;
        }
        setWorkshopToolbarHint('Ladowanie profilu warsztatu...');
        state.workshopDetailViewActive = true;
    };

    const hideWorkshopDetailView = () => {
        if (!elements.workshopDetailView) {
            return;
        }
        elements.workshopDetailView.hidden = true;
        if (elements.workshopListView) {
            elements.workshopListView.hidden = false;
        }
        if (elements.workshopToolbarList) {
            elements.workshopToolbarList.hidden = false;
        }
        if (elements.workshopToolbarDetail) {
            elements.workshopToolbarDetail.hidden = true;
        }
        setWorkshopToolbarHint(WORKSHOP_TOOLBAR_HINT_DEFAULT);
        state.workshopDetailViewActive = false;
        state.focusedWorkshopId = null;
        state.workshopDetailRecord = null;
        state.workshopDetailError = null;
        state.workshopDetailLoading = false;
        setFeedback(elements.workshopDetailFeedback, '', null);
        renderWorkshopDetail();
        resetWorkshopBillingForm();
        if (elements.workshopDetailTitle) {
            elements.workshopDetailTitle.textContent = 'Szczegoly warsztatu';
        }
        if (elements.workshopDetailEyebrow) {
            elements.workshopDetailEyebrow.textContent = 'Profil warsztatu';
        }
    };

    const loadWorkshopDetail = async (workshopId) => {
        const numericId = Number(workshopId);
        state.workshopDetailLoading = true;
        state.workshopDetailError = null;
        state.workshopDetailRecord = null;
        renderWorkshopDetail();
        try {
            const detail = await window.WarsztatApi.get(`/workshops/${workshopId}`);
            if (!state.workshopDetailViewActive || numericId !== state.focusedWorkshopId) {
                return;
            }
            state.workshopDetailRecord = detail;
            state.workshopDetailLoading = false;
            renderWorkshopDetail();
        } catch (error) {
            if (handleAuthError(error)) {
                return;
            }
            if (!state.workshopDetailViewActive || numericId !== state.focusedWorkshopId) {
                return;
            }
            state.workshopDetailError = error.details?.message || 'Nie udalo sie pobrac danych warsztatu.';
            state.workshopDetailLoading = false;
            renderWorkshopDetail();
        }
    };

    const openWorkshopDetail = (workshopId) => {
        state.focusedWorkshopId = Number(workshopId);
        resetWorkshopBillingForm();
        setFeedback(elements.workshopDetailFeedback, '', null);
        showWorkshopDetailView();
        loadWorkshopDetail(workshopId);
    };

    const setWorkshopFormMode = () => {
        if (!elements.workshopForm) {
            return;
        }
        const isEdit = Boolean(state.editingWorkshopId);
        if (elements.workshopFormEyebrow) {
            elements.workshopFormEyebrow.textContent = isEdit ? 'Edycja warsztatu' : 'Nowy warsztat';
        }
        if (elements.workshopFormTitle) {
            elements.workshopFormTitle.textContent = isEdit ? 'Edytuj warsztat' : 'Dodaj warsztat';
        }
        if (elements.workshopFormSubmit) {
            elements.workshopFormSubmit.textContent = isEdit ? 'Zapisz zmiany' : 'Dodaj warsztat';
        }
        if (elements.workshopCancelBtn) {
            elements.workshopCancelBtn.hidden = !isEdit;
        }
    };

    const renderSettings = () => {
        if (!elements.settingsForm || !state.settings) {
            return;
        }
        const { licenseMonths, statusOptions } = state.settings;
        const monthsField = elements.settingsForm.querySelector('input[name="licenseMonths"]');
        const statusesField = elements.settingsForm.querySelector('textarea[name="statusOptions"]');
        if (monthsField) {
            monthsField.value = licenseMonths ?? '';
        }
        if (statusesField) {
            statusesField.value = (statusOptions || []).join(', ');
        }
    };

    const renderLogs = () => {
        if (!elements.logsContainer) {
            return;
        }
        if (!state.logs.length) {
            elements.logsContainer.innerHTML = '<li class="panel-empty">Brak wpisĂłw w dzienniku.</li>';
            return;
        }
        elements.logsContainer.innerHTML = state.logs
            .map((log) => {
                const actor = log.actorEmail || 'System';
                return `
                <li>
                    <strong>${log.message}</strong><br>
                    <small>${formatDateTime(log.createdAt)} Â· ${actor} Â· ${log.type}</small>
                </li>
            `;
            })
            .join('');
    };

    const buildOverviewMetrics = () => {
        const now = new Date();
        const monthAgo = new Date(now);
        monthAgo.setMonth(now.getMonth() - 1);
        const weekAgo = new Date(now);
        weekAgo.setDate(now.getDate() - 7);

        const workshopIndex = new Map(state.workshops.map((workshop) => [workshop.id, workshop]));
        const workshopStats = new Map();
        const isActiveWorkshop = (status) => status === 'active' || status === 'notice';
        const isInactiveWorkshop = (status) => status === 'inactive' || status === 'deactivated';

        state.reports.forEach((report) => {
            if (!report.workshopId) {
                return;
            }
            const stats = workshopStats.get(report.workshopId) || {
                workshopId: report.workshopId,
                count: 0,
                lastReportAt: null,
                name: null,
                city: null
            };
            stats.count += 1;
            const updatedAt = toDate(report.updatedAt) || toDate(report.createdAt);
            if (updatedAt && (!stats.lastReportAt || updatedAt > stats.lastReportAt)) {
                stats.lastReportAt = updatedAt;
            }
            const workshop = workshopIndex.get(report.workshopId);
            stats.name = workshop?.name || report.workshopName || 'Warsztat';
            stats.city = workshop?.city || null;
            workshopStats.set(report.workshopId, stats);
        });

        const describeWorkshopEntry = (workshop, metaLabel = 'Aktualizacja') => {
            const location = [workshop.city, workshop.address].filter(Boolean).join(' â€˘ ') || 'Brak lokalizacji';
            const lastTouched = toDate(workshop.updatedAt) || toDate(workshop.createdAt);
            const meta = lastTouched ? `${metaLabel} ${formatShortDate(lastTouched)}` : 'Brak daty aktualizacji';
            return {
                title: workshop.name || 'Warsztat',
                subtitle: location,
                meta
            };
        };

        const newWorkshopsList = sortByDateDesc(
            state.workshops.filter((workshop) => {
                const createdAt = toDate(workshop.createdAt);
                return createdAt && createdAt >= monthAgo;
            }),
            (workshop) => workshop.createdAt
        );

        const activeWorkshopItems = state.workshops
            .filter((workshop) => isActiveWorkshop(workshop.status))
            .sort((a, b) => (a.name || '').localeCompare(b.name || '', 'pl'))
            .slice(0, 100)
            .map((workshop) => describeWorkshopEntry(workshop, 'Aktualizacja'));

        const inactiveWorkshopItems = state.workshops
            .filter((workshop) => isInactiveWorkshop(workshop.status))
            .sort((a, b) => (a.name || '').localeCompare(b.name || '', 'pl'))
            .slice(0, 100)
            .map((workshop) => describeWorkshopEntry(workshop, 'Ostatnia zmiana'));

        const inactive30List = state.workshops
            .map((workshop) => {
                const updatedAt = toDate(workshop.updatedAt) || toDate(workshop.createdAt);
                const reportActivity = workshopStats.get(workshop.id)?.lastReportAt;
                const lastActivity = [updatedAt, reportActivity].filter(Boolean).sort((a, b) => b - a)[0];
                return { workshop, lastActivity };
            })
            .filter(({ lastActivity }) => !lastActivity || daysBetween(now, lastActivity) >= 30)
            .map(({ workshop, lastActivity }) => ({
                ...workshop,
                lastActivity: lastActivity ? lastActivity.toISOString() : null
            }));

        const workshopLoginsTodayList = [];
        const seenLoginKeys = new Set();

        state.logs
            .filter((log) => log.type === 'auth:login:workshop' && isSameDay(log.createdAt, now))
            .forEach((log) => {
                const key = String(log.payload?.workshopId ?? log.actorEmail ?? log.id ?? log.createdAt);
                if (seenLoginKeys.has(key)) {
                    return;
                }
                seenLoginKeys.add(key);
                workshopLoginsTodayList.push({
                    title: log.actorEmail || 'Warsztat',
                    subtitle: formatDateTime(log.createdAt),
                    meta: log.payload?.workshopId ? `Warsztat ID ${log.payload.workshopId}` : ''
                });
            });

        const topWorkshopList = [...workshopStats.values()]
            .sort((a, b) => {
                if (b.count === a.count) {
                    return (a.name || '').localeCompare(b.name || '', 'pl');
                }
                return b.count - a.count;
            })
            .slice(0, 100)
            .map((entry, index) => ({
                title: `${index + 1}. ${entry.name || 'Warsztat'}`,
                subtitle: entry.city || 'Brak lokalizacji',
                meta: `${entry.count} raportĂłw${entry.lastReportAt ? ` Â· ostatni ${formatShortDate(entry.lastReportAt)}` : ''}`
            }));

        const reportChronoList = sortByDateDesc(state.reports, (report) => report.updatedAt || report.createdAt)
            .slice(0, 100)
            .map((report) => ({
                title: report.vin || 'Brak VIN',
                subtitle: report.workshopName || 'Warsztat',
                meta: `${report.status || 'Brak statusu'} Â· ${formatShortDate(report.updatedAt || report.createdAt)}`
            }));

        const pendingReportEntries = sortByDateDesc(
            state.reports.filter((report) => report.approvalStatus === 'pending'),
            (report) => report.updatedAt || report.createdAt
        )
            .slice(0, 100)
            .map((report) => ({
                title: report.vin || 'Brak VIN',
                subtitle: report.workshopName || 'Warsztat',
                meta: `Oczekuje od ${formatShortDate(report.updatedAt || report.createdAt)}`
            }));

        const approvedThisWeekEntries = sortByDateDesc(
            state.reports.filter((report) => {
                if (report.approvalStatus !== 'approved') {
                    return false;
                }
                const updatedAt = toDate(report.updatedAt) || toDate(report.createdAt);
                return updatedAt && updatedAt >= weekAgo;
            }),
            (report) => report.updatedAt || report.createdAt
        )
            .slice(0, 100)
            .map((report) => ({
                title: report.vin || 'Brak VIN',
                subtitle: report.workshopName || 'Warsztat',
                meta: `Zatwierdzono ${formatShortDate(report.updatedAt || report.createdAt)}`
            }));

        const approvedThisWeek = approvedThisWeekEntries.length;

        const totalReports = state.reports.length;
        const pendingReports = pendingReportEntries.length;
        const approvedReports = state.reports.filter((item) => item.approvalStatus === 'approved').length;
        const activeWorkshops = activeWorkshopItems.length;
        const inactiveWorkshops = inactiveWorkshopItems.length;

        state.metricDetails = {
            activeWorkshops: {
                title: 'Aktywne warsztaty',
                eyebrow: 'Status kont',
                description: 'Partnerzy z aktywnÄ… licencjÄ… i dostÄ™pem do panelu.',
                items: activeWorkshopItems
            },
            inactiveWorkshops: {
                title: 'Warsztaty nieaktywne',
                eyebrow: 'Do reaktywacji',
                description: 'Punkty partnerskie, ktĂłre zostaĹ‚y wstrzymane lub oczekujÄ… na reaktywacjÄ™.',
                items: inactiveWorkshopItems
            },
            newWorkshops: {
                title: 'Nowe warsztaty',
                eyebrow: 'Ostatnie 30 dni',
                description: 'Partnerzy, ktĂłrzy dolaczyli w ciagu minionego miesiaca.',
                items: newWorkshopsList.map((workshop) => ({
                    title: workshop.name,
                    subtitle: [workshop.city, workshop.address].filter(Boolean).join(' â€˘ ') || 'Brak lokalizacji',
                    meta: `Dodano ${formatShortDate(workshop.createdAt)}`
                }))
            },
            inactive30Workshops: {
                title: 'Warsztaty do reaktywacji',
                eyebrow: 'Brak aktywnosci 30 dni',
                description: 'Lista partnerow, ktorzy od 30 dni nie wykonywali zadnej akcji ani nie zlozyli raportu.',
                items: sortByDateDesc(inactive30List, (workshop) => workshop.lastActivity)
                    .map((workshop) => ({
                        title: workshop.name,
                        subtitle: [workshop.city, workshop.address].filter(Boolean).join(' â€˘ ') || 'Brak lokalizacji',
                        meta: workshop.lastActivity
                            ? `Ostatnia aktywnosc ${formatShortDate(workshop.lastActivity)}`
                            : 'Brak zarejestrowanej aktywnosci'
                    }))
            },
            totalReports: {
                title: 'Raporty Ĺ‚Ä…cznie',
                eyebrow: 'CaĹ‚a baza',
                description: 'Chronologiczna lista najnowszych raportĂłw.',
                items: reportChronoList
            },
            pendingReports: {
                title: 'Raporty oczekujace',
                eyebrow: 'WymagajÄ… moderacji',
                description: 'Raporty, ktĂłre czekajÄ… na decyzjÄ™ administratora.',
                items: pendingReportEntries
            },
            approvedThisWeek: {
                title: 'Zatwierdzone raporty (7 dni)',
                eyebrow: 'Tempo pracy',
                description: 'Lista raportĂłw zaakceptowanych w ciÄ…gu ostatnich 7 dni.',
                items: approvedThisWeekEntries
            },
            workshopLoginsToday: {
                title: 'Logowania warsztatow dzisiaj',
                eyebrow: 'Aktywnosc dzienna',
                description: 'Historia dzisiejszych logowan warsztatow.',
                items: workshopLoginsTodayList
            },
            topWorkshopReporters: {
                title: 'Top warsztatow wg raportow',
                eyebrow: 'Ranking do 100 pozycji',
                description: 'Najbardziej aktywni partnerzy pod wzgledem dodawanych raportow.',
                items: topWorkshopList
            }
        };

        const metricsConfig = [
            { key: 'activeWorkshops', label: 'Warsztaty aktywne', value: activeWorkshops, detail: `${state.workshops.length} Ĺ‚Ä…cznie` },
            { key: 'inactiveWorkshops', label: 'Warsztaty nieaktywne', value: inactiveWorkshops, detail: 'Do reaktywacji' },
            { key: 'newWorkshops', label: 'Nowe warsztaty', value: newWorkshopsList.length, detail: 'Ostatnie 30 dni' },
            { key: 'inactive30Workshops', label: 'Brak aktywnoĹ›ci 30d', value: state.metricDetails.inactive30Workshops.items.length, detail: 'WymagajÄ… kontaktu' },
            { key: 'totalReports', label: 'Raporty Ĺ‚Ä…cznie', value: totalReports, detail: `${approvedReports} zatwierdzonych` },
            { key: 'pendingReports', label: 'Raporty oczekujÄ…ce', value: pendingReports, detail: 'WymagajÄ… moderacji' },
            { key: 'approvedThisWeek', label: 'Zatwierdzone (7 dni)', value: approvedThisWeek, detail: 'Tempo pracy' },
            { key: 'workshopLoginsToday', label: 'Logowania dzisiaj', value: workshopLoginsTodayList.length, detail: 'Warsztaty aktywne' },
            { key: 'topWorkshopReporters', label: 'Top warsztatĂłw', value: state.metricDetails.topWorkshopReporters.items.length, detail: 'Najaktywniejsi' }
        ];

        return metricsConfig.map((metric) => ({
            ...metric,
            clickable: Boolean(state.metricDetails[metric.key]?.items?.length)
        }));
    };

    const renderInactiveWorkshops = () => {
        if (!elements.inactiveWorkshopsList) {
            return;
        }
        const inactive = state.workshops.filter((workshop) => ['inactive', 'deactivated'].includes(workshop.status));
        if (!inactive.length) {
            elements.inactiveWorkshopsList.innerHTML = '<li class="panel-empty">Wszyscy partnerzy sa aktywni.</li>';
            return;
        }

        const limited = [...inactive].sort((a, b) => {
            const left = a.updatedAt || a.createdAt;
            const right = b.updatedAt || b.createdAt;
            if (left === right) {
                return a.name.localeCompare(b.name, 'pl');
            }
            return right.localeCompare(left);
        }).slice(0, 6);

        elements.inactiveWorkshopsList.innerHTML = limited
            .map((workshop) => {
                const location = [workshop.city, workshop.address].filter(Boolean).join(' â€˘ ');
                const contact = workshop.email || workshop.phone || 'Brak danych kontaktowych';
                return `
                <li>
                    <div>
                        <strong>${workshop.name}</strong>
                        <small>${location || 'Brak lokalizacji'}</small>
                    </div>
                    <small>${contact}</small>
                </li>
            `;
            })
            .join('');

        if (inactive.length > limited.length) {
            const remaining = inactive.length - limited.length;
            elements.inactiveWorkshopsList.innerHTML += `<li class="panel-empty">+${remaining} kolejnych wpisĂłw</li>`;
        }
    };

    const populateWorkshopForm = (workshop) => {
        if (!elements.workshopForm || !workshop) {
            return;
        }
        const setValue = (name, value) => {
            const field = elements.workshopForm.querySelector(`[name="${name}"]`);
            if (field) {
                field.value = value ?? '';
            }
        };

        setValue('name', workshop.name);
        setValue('city', workshop.city);
        setValue('address', workshop.address);
        setValue('phone', workshop.phone);
        setValue('email', workshop.email);
        setValue('billingEmail', workshop.billingEmail);
        setValue('loginEmail', workshop.loginEmail || workshop.email);
        setValue('status', workshop.status || 'active');
        setValue('subscriptionAmount', workshop.subscriptionAmount ?? '');
        setValue('subscriptionStartDate', toDateInputValue(workshop.subscriptionStartDate));
        setValue('subscriptionInitialAmount', workshop.subscriptionInitialAmount ?? '');
        setValue('subscriptionInitialNote', workshop.subscriptionInitialNote);
        const notesField = elements.workshopForm.querySelector('[name="notes"]');
        if (notesField) {
            notesField.value = workshop.notes || '';
        }
        const passwordField = elements.workshopForm.querySelector('[name="loginPassword"]');
        if (passwordField) {
            passwordField.value = '';
        }
    };

    function resetWorkshopForm() {
        elements.workshopForm?.reset();
        state.editingWorkshopId = null;
        setWorkshopFormMode();
    }

    const handleWorkshopEditSelect = (workshopId) => {
        const workshop = state.workshops.find((item) => item.id === Number(workshopId));
        if (!workshop) {
            return;
        }
        state.editingWorkshopId = workshop.id;
        populateWorkshopForm(workshop);
        setWorkshopFormMode();
        setFeedback(elements.workshopFeedback, `Edycja warsztatu ${workshop.name}.`, null);
        openWorkshopDrawer();
    };

    const refreshLogs = async (showLoading = false) => {
        if (showLoading && elements.logsContainer) {
            elements.logsContainer.innerHTML = '<li class="panel-empty">Ĺadowanie dziennika...</li>';
        }
        try {
            const logs = await window.WarsztatApi.get('/logs');
            state.logs = Array.isArray(logs) ? logs : [];
            renderLogs();
        } catch (error) {
            if (handleAuthError(error)) {
                return;
            }
            if (elements.logsContainer) {
                elements.logsContainer.innerHTML = '<li class="panel-empty">Nie udaĹ‚o siÄ™ pobraÄ‡ logĂłw.</li>';
            }
        }
    };

    const renderSelectedReport = () => {
        if (!elements.reportEditForm) {
            return;
        }
        const fields = {
            id: elements.reportEditForm.querySelector('input[name="reportId"]'),
            vin: elements.reportEditForm.querySelector('input[name="vin"]'),
            registrationNumber: elements.reportEditForm.querySelector('input[name="registrationNumber"]'),
            mileageKm: elements.reportEditForm.querySelector('input[name="mileageKm"]'),
            firstRegistrationDate: elements.reportEditForm.querySelector('input[name="firstRegistrationDate"]'),
            approvalStatus: elements.reportEditForm.querySelector('select[name="approvalStatus"]'),
            summary: elements.reportEditForm.querySelector('textarea[name="summary"]'),
            moderationNote: elements.reportEditForm.querySelector('textarea[name="moderationNote"]')
        };

        const report = state.reports.find((item) => item.id === state.selectedReportId);
        if (!report) {
            elements.reportEditForm.reset();
            state.selectedReportId = null;
            setFeedback(elements.reportFeedback, 'Wybierz raport z listy, aby rozpoczac edycje.', null);
            if (elements.reportMediaGallery) {
                elements.reportMediaGallery.innerHTML = '<p class="panel-empty">Brak zalacznikow.</p>';
            }
            return;
        }

        fields.id.value = report.id;
        fields.vin.value = report.vin || '';
        fields.registrationNumber.value = report.registrationNumber || '';
        fields.mileageKm.value = report.mileageKm ?? '';
        fields.firstRegistrationDate.value = report.firstRegistrationDate || '';
        fields.approvalStatus.value = report.approvalStatus || 'pending';
        fields.summary.value = report.summary || '';
        fields.moderationNote.value = report.moderationNote || '';

        if (elements.reportMediaGallery) {
            elements.reportMediaGallery.innerHTML = '<p class="panel-empty">Integracja zalacznikow pojawi sie wkrotce.</p>';
        }

        setFeedback(elements.reportFeedback, `Edytujesz raport ${report.vin}.`, null);
    };

    const selectReport = (reportId) => {
        state.selectedReportId = Number(reportId);
        renderSelectedReport();
    };

    const bindEvents = () => {
        elements.metrics?.addEventListener('click', handleMetricClick);
        elements.navButtons?.forEach((btn) => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.panelTarget;
                if (target) {
                    activateView(target);
                    if (target === 'logs') {
                        refreshLogs(true);
                    }
                }
            });
        });

        elements.logoutBtn?.addEventListener('click', () => {
            window.WarsztatSession?.clear();
            window.location.href = LOGIN_URL;
        });

        elements.reportList?.addEventListener('click', (event) => {
            const target = event.target.closest('[data-report-id]');
            if (target) {
                selectReport(target.dataset.reportId);
            }
        });

        elements.reportFilterForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            const data = new FormData(elements.reportFilterForm);
            state.filters.vin = String(data.get('vin') || '').trim();
            state.filters.registration = String(data.get('registration') || '').trim();
            state.filters.approval = String(data.get('approval') || 'all');
            renderReportList();
        });

        elements.reportEditForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!state.selectedReportId) {
                setFeedback(elements.reportFeedback, 'Najpierw wybierz raport z listy.', 'error');
                return;
            }
            const data = new FormData(elements.reportEditForm);
            const payload = {
                vin: String(data.get('vin') || '').trim().toUpperCase(),
                registrationNumber: String(data.get('registrationNumber') || '').trim().toUpperCase(),
                mileageKm: data.get('mileageKm') ? Number(data.get('mileageKm')) : null,
                firstRegistrationDate: String(data.get('firstRegistrationDate') || '').trim() || null,
                summary: String(data.get('summary') || '').trim(),
                approvalStatus: String(data.get('approvalStatus') || 'pending'),
                moderationNote: String(data.get('moderationNote') || '').trim()
            };

            try {
                setFeedback(elements.reportFeedback, 'Zapisywanie zmian...', null);
                const updated = await window.WarsztatApi.patch(`/reports/${state.selectedReportId}`, payload);
                state.reports = state.reports.map((report) => (report.id === updated.id ? updated : report));
                setFeedback(elements.reportFeedback, 'Raport zaktualizowany poprawnie.', 'success');
                renderReportList();
                selectReport(updated.id);
            } catch (error) {
                if (handleAuthError(error)) {
                    return;
                }
                const message = error.details?.message || 'Nie udalo sie zapisac raportu.';
                setFeedback(elements.reportFeedback, message, 'error');
            }
        });

        elements.workshopList?.addEventListener('click', (event) => {
            const editBtn = event.target.closest('[data-workshop-action="edit"]');
            if (editBtn) {
                handleWorkshopEditSelect(editBtn.dataset.workshopId);
                event.stopPropagation();
                return;
            }
            if (event.target.closest('.panel-workshop-card__actions')) {
                return;
            }
            const card = event.target.closest('[data-workshop-card]');
            if (card?.dataset.workshopId) {
                openWorkshopDetail(card.dataset.workshopId);
            }
        });

        elements.workshopAddBtn?.addEventListener('click', () => {
            resetWorkshopForm();
            setFeedback(elements.workshopFeedback, 'Uzupelnij formularz, aby dodac nowy warsztat.', null);
            openWorkshopDrawer();
        });

        elements.workshopFilterForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            const data = new FormData(elements.workshopFilterForm);
            state.workshopFilters.query = normalizeString(data.get('query')).toLowerCase();
            state.workshopFilters.status = String(data.get('status') || 'all');
            renderWorkshopList();
        });

        elements.workshopFilterReset?.addEventListener('click', () => {
            elements.workshopFilterForm?.reset();
            state.workshopFilters = { query: '', status: 'all' };
            renderWorkshopList();
        });

        elements.workshopForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            const data = new FormData(elements.workshopForm);
            const payload = {
                name: normalizeString(data.get('name')),
                city: toOptional(data.get('city')),
                address: toOptional(data.get('address')),
                phone: toOptional(data.get('phone')),
                email: toOptional(data.get('email')),
                billingEmail: toEmail(data.get('billingEmail')),
                status: String(data.get('status') || 'active'),
                subscriptionAmount: toMoneyValue(data.get('subscriptionAmount')),
                subscriptionStartDate: toDateOnly(data.get('subscriptionStartDate')),
                subscriptionInitialAmount: toMoneyValue(data.get('subscriptionInitialAmount')),
                subscriptionInitialNote: toOptional(data.get('subscriptionInitialNote')),
                notes: toOptional(data.get('notes')),
                loginEmail: toEmail(data.get('loginEmail')),
                loginPassword: normalizeString(data.get('loginPassword'))
            };

            if (!payload.name) {
                setFeedback(elements.workshopFeedback, 'Podaj nazwe warsztatu.', 'error');
                return;
            }

            if (!payload.loginEmail) {
                setFeedback(elements.workshopFeedback, 'Podaj e-mail do logowania warsztatu.', 'error');
                return;
            }

            const isEdit = Boolean(state.editingWorkshopId);
            if (!isEdit && payload.loginPassword.length < 8) {
                setFeedback(elements.workshopFeedback, 'Haslo musi miec co najmniej 8 znakow.', 'error');
                return;
            }
            if (isEdit && payload.loginPassword && payload.loginPassword.length < 8) {
                setFeedback(elements.workshopFeedback, 'Nowe haslo musi miec co najmniej 8 znakow.', 'error');
                return;
            }

            if (!payload.loginPassword) {
                delete payload.loginPassword;
            }

            try {
                setFeedback(elements.workshopFeedback, 'Zapisywanie danych warsztatu...', null);
                let workshop;
                if (state.editingWorkshopId) {
                    workshop = await window.WarsztatApi.patch(`/workshops/${state.editingWorkshopId}`, payload);
                    state.workshops = state.workshops.map((item) => (item.id === workshop.id ? workshop : item));
                    setFeedback(elements.workshopFeedback, 'Zmieniono dane warsztatu.', 'success');
                } else {
                    workshop = await window.WarsztatApi.post('/workshops', payload);
                    state.workshops = [workshop, ...state.workshops];
                    setFeedback(elements.workshopFeedback, 'Dodano nowy warsztat.', 'success');
                }
                renderWorkshopList();
                renderOverview();
                resetWorkshopForm();
            } catch (error) {
                if (handleAuthError(error)) {
                    return;
                }
                const message = error.details?.message || 'Nie udalo sie zapisac warsztatu.';
                setFeedback(elements.workshopFeedback, message, 'error');
            }
        });

        elements.workshopCancelBtn?.addEventListener('click', () => {
            resetWorkshopForm();
            setFeedback(elements.workshopFeedback, 'Anulowano edycje warsztatu.', null);
        });

        elements.settingsForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!elements.settingsForm) {
                return;
            }
            const data = new FormData(elements.settingsForm);
            const licenseMonths = Number(data.get('licenseMonths'));
            const rawStatuses = String(data.get('statusOptions') || '')
                .split(',')
                .map((item) => item.trim())
                .filter(Boolean);

            if (!Number.isFinite(licenseMonths) || licenseMonths < 1) {
                setFeedback(elements.settingsFeedback, 'Podaj poprawna liczbe miesiecy.', 'error');
                return;
            }
            if (!rawStatuses.length) {
                setFeedback(elements.settingsFeedback, 'Wpisz przynajmniej jeden status.', 'error');
                return;
            }

            try {
                setFeedback(elements.settingsFeedback, 'Zapisywanie ustawien...', null);
                const updated = await window.WarsztatApi.patch('/settings', {
                    licenseMonths,
                    statusOptions: rawStatuses
                });
                state.settings = updated;
                renderSettings();
                setFeedback(elements.settingsFeedback, 'Ustawienia zostaly zapisane.', 'success');
            } catch (error) {
                if (handleAuthError(error)) {
                    return;
                }
                const message = error.details?.message || 'Nie udalo sie zapisac ustawien.';
                setFeedback(elements.settingsFeedback, message, 'error');
            }
        });

        elements.logsRefreshBtn?.addEventListener('click', () => {
            refreshLogs(true);
        });

        const handleWorkshopDrawerClose = () => {
            closeWorkshopDrawer();
            resetWorkshopForm();
            setFeedback(elements.workshopFeedback, '', null);
        };

        elements.workshopDrawerClose?.addEventListener('click', handleWorkshopDrawerClose);
        elements.workshopDrawerBackdrop?.addEventListener('click', handleWorkshopDrawerClose);
        elements.metricDrawerClose?.addEventListener('click', closeMetricDrawer);
        elements.metricDrawerBackdrop?.addEventListener('click', closeMetricDrawer);
        elements.workshopDetailBack?.addEventListener('click', hideWorkshopDetailView);
        elements.workshopDetailView?.addEventListener('click', handleWorkshopDetailClick);
        elements.workshopBillingForm?.addEventListener('submit', handleBillingFormSubmit);
        elements.workshopBillingList?.addEventListener('click', handleBillingListClick);
        document.addEventListener('keydown', handleDrawerKeydown);
    };

    const loadInitialData = async () => {
        try {
            setFeedback(elements.reportFeedback, 'Wczytywanie danych z API...', null);
            const [reports, media, news, workshops, settings, logs] = await Promise.all([
                window.WarsztatApi.get('/reports'),
                window.WarsztatApi.get('/media', { auth: false }),
                window.WarsztatApi.get('/news', { auth: false }),
                window.WarsztatApi.get('/workshops'),
                window.WarsztatApi.get('/settings'),
                window.WarsztatApi.get('/logs')
            ]);
            state.reports = Array.isArray(reports) ? reports : [];
            state.media = Array.isArray(media) ? media : [];
            state.news = Array.isArray(news) ? news : [];
            state.workshops = Array.isArray(workshops) ? workshops : [];
            state.settings = settings || null;
            state.logs = Array.isArray(logs) ? logs : [];
            renderOverview();
            renderReportList();
            renderSelectedReport();
            renderWorkshopList();
            renderSettings();
            renderLogs();
            setFeedback(elements.reportFeedback, 'Dane zostaly pobrane.', 'success');
        } catch (error) {
            if (handleAuthError(error)) {
                return;
            }
            console.error('Nie udalo sie pobrac danych poczatkowych', error);
            setFeedback(elements.reportFeedback, 'Nie udalo sie pobrac danych z API.', 'error');
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
            // --- Warsztat: zakĹ‚adka Ustawienia ---
            const settingsTab = document.getElementById('tab-settings');
            const settingsForm = document.getElementById('workshop-settings-form');
            function fillWorkshopSettingsForm(data) {
                if (!settingsForm || !data) return;
                settingsForm.name.value = data.name || '';
                settingsForm.city.value = data.city || '';
                settingsForm.address.value = data.address || '';
                settingsForm.phone.value = data.phone || '';
                settingsForm.email.value = data.email || '';
                settingsForm.billingEmail.value = data.billingEmail || '';
                settingsForm.subscriptionAmount.value = data.subscriptionAmount || '';
                settingsForm.subscriptionMonths.value = data.subscriptionMonths || '';
                settingsForm.subscriptionStartDate.value = data.subscriptionStartDate || '';
                settingsForm.integrationSms.checked = !!data.integrationSms;
                settingsForm.integrationHurtownia.checked = !!data.integrationHurtownia;
                settingsForm.integrationAutodoc.checked = !!data.integrationAutodoc;
            }

            async function loadWorkshopSettings(workshopId) {
                if (!workshopId) return;
                try {
                    const detail = await window.WarsztatApi.get(`/workshops/${workshopId}`);
                    fillWorkshopSettingsForm(detail);
                } catch (err) {}
            }

            if (settingsForm) {
                settingsForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    if (!state.focusedWorkshopId) return;
                    const data = new FormData(settingsForm);
                    const payload = {
                        name: data.get('name'),
                        city: data.get('city'),
                        address: data.get('address'),
                        phone: data.get('phone'),
                        email: data.get('email'),
                        billingEmail: data.get('billingEmail'),
                        subscriptionAmount: Number(data.get('subscriptionAmount')),
                        subscriptionMonths: Number(data.get('subscriptionMonths')),
                        subscriptionStartDate: data.get('subscriptionStartDate'),
                        integrationSms: !!data.get('integrationSms'),
                        integrationHurtownia: !!data.get('integrationHurtownia'),
                        integrationAutodoc: !!data.get('integrationAutodoc')
                    };
                    try {
                        await window.WarsztatApi.patch(`/workshops/${state.focusedWorkshopId}`, payload);
                        alert('Zmiany zapisane!');
                    } catch (err) {
                        alert('Nie udaĹ‚o siÄ™ zapisaÄ‡ zmian.');
                    }
                });
            }

            document.body.addEventListener('click', function(e) {
                const tabBtn = e.target.closest('.workshop-tab[data-tab="settings"]');
                if (tabBtn && state.focusedWorkshopId) {
                    loadWorkshopSettings(state.focusedWorkshopId);
                }
            });
            // --- Warsztat: zakĹ‚adka Raporty ---
            const reportsTab = document.getElementById('tab-reports');
            const reportsList = document.getElementById('workshop-reports-list');
            const reportsFilterForm = document.getElementById('workshop-reports-filter-form');
            let reportsFilter = { status: 'all', date: '', type: '' };

            async function loadWorkshopReports(workshopId) {
                if (!workshopId) return;
                try {
                    const allReports = await window.WarsztatApi.get(`/workshops/${workshopId}/reports`);
                    state.workshopReports = Array.isArray(allReports) ? allReports : [];
                    renderWorkshopReports();
                } catch (err) {
                    reportsList.innerHTML = '<p class="panel-empty">Nie udaĹ‚o siÄ™ pobraÄ‡ raportĂłw.</p>';
                }
            }

            function renderWorkshopReports() {
                if (!reportsList) return;
                let filtered = state.workshopReports;
                if (reportsFilter.status && reportsFilter.status !== 'all') {
                    filtered = filtered.filter(r => r.approvalStatus === reportsFilter.status);
                }
                if (reportsFilter.date) {
                    filtered = filtered.filter(r => r.updatedAt && r.updatedAt.startsWith(reportsFilter.date));
                }
                if (reportsFilter.type) {
                    filtered = filtered.filter(r => (r.type || '').toLowerCase().includes(reportsFilter.type.toLowerCase()));
                }
                if (!filtered.length) {
                    reportsList.innerHTML = '<p class="panel-empty">Brak raportĂłw dla wybranych filtrĂłw.</p>';
                    return;
                }
                reportsList.innerHTML = filtered.map(report => `
                    <article class="workshop-report-card">
                        <header>
                            <strong>${report.vin || 'Brak VIN'}</strong>
                            <span class="panel-tag ${report.approvalStatus}">${report.approvalStatus}</span>
                            <span>${report.type || 'Brak typu'}</span>
                            <span>${report.updatedAt ? new Date(report.updatedAt).toLocaleDateString('pl-PL') : ''}</span>
                        </header>
                        <p>${report.summary || 'Brak opisu naprawy.'}</p>
                        <div class="workshop-report-attachments">
                            ${(report.attachments && report.attachments.length)
                                ? report.attachments.map(att => `<a href="${att.url}" target="_blank">${att.name}</a>`).join(', ')
                                : '<span class="panel-empty">Brak zaĹ‚Ä…cznikĂłw.</span>'}
                        </div>
                    </article>
                `).join('');
            }

            if (reportsFilterForm) {
                reportsFilterForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const data = new FormData(reportsFilterForm);
                    reportsFilter.status = data.get('status') || 'all';
                    reportsFilter.date = data.get('date') || '';
                    reportsFilter.type = data.get('type') || '';
                    renderWorkshopReports();
                });
            }

            // ZaĹ‚aduj raporty po otwarciu panelu warsztatu
            document.body.addEventListener('click', function(e) {
                const tabBtn = e.target.closest('.workshop-tab[data-tab="reports"]');
                if (tabBtn && state.focusedWorkshopId) {
                    loadWorkshopReports(state.focusedWorkshopId);
                }
            });
            // --- Warsztat: zakĹ‚adki szczegĂłĹ‚Ăłw ---
            document.body.addEventListener('click', function (e) {
                const tabBtn = e.target.closest('.workshop-tab');
                if (tabBtn) {
                    const nav = tabBtn.parentElement;
                    const allTabs = nav.querySelectorAll('.workshop-tab');
                    allTabs.forEach(btn => btn.classList.remove('active'));
                    tabBtn.classList.add('active');
                    const tab = tabBtn.getAttribute('data-tab');
                    const contentRoot = nav.parentElement.querySelector('.workshop-tabs__content');
                    if (contentRoot) {
                        contentRoot.querySelectorAll('.workshop-tab-content').forEach(sec => {
                            sec.style.display = sec.id === 'tab-' + tab ? '' : 'none';
                        });
                    }
                }
            });
        if (!window.WarsztatApi || !window.WarsztatSession) {
            console.error('Brakuje klienta API lub modulu sesji.');
            return;
        }
        const session = window.WarsztatSession.get();
        if (!session?.token) {
            window.location.href = LOGIN_URL;
            return;
        }

        bindDom();
        state.session = session;
        state.isAdmin = session.role !== 'workshop';

        if (!state.isAdmin) {
            activateWorkshopMode(session);
            return;
        }

        setWorkshopFormMode();
        disableLegacyViews();
        bindEvents();
        activateView('overview');

        if (elements.username) {
            elements.username.textContent = session.user?.email || 'Administrator';
        }
        if (elements.role) {
            elements.role.textContent = 'Administrator';
        }

        loadInitialData();
    });

    document.addEventListener('DOMContentLoaded', () => {
    // === INTEGRACJA GUS ===
    const nipInput = document.getElementById('workshop-nip');
    const loadingEl = document.getElementById('gus-loading');
    const feedbackEl = document.getElementById('nip-feedback');

    // Pola do wypeĹ‚nienia
    const nameInput = document.getElementById('workshop-name');
    const cityInput = document.getElementById('workshop-city');
    const zipInput = document.getElementById('workshop-zip');
    const addressInput = document.getElementById('workshop-address');

    if (nipInput) {
        nipInput.addEventListener('blur', async () => {
            const nip = nipInput.value.replace(/[^0-9]/g, ''); // UsuĹ„ myĹ›lniki i spacje

            if (nip.length !== 10) {
                if(nip.length > 0) showError('NIP musi mieÄ‡ 10 cyfr');
                return;
            }

            // Reset UI
            feedbackEl.style.display = 'none';
            loadingEl.style.display = 'inline-block';
            nipInput.disabled = true;

            try {
                // WywoĹ‚anie Twojego backendu (zakĹ‚adam, ĹĽe api.js obsĹ‚uguje metodÄ™ get)
                // JeĹ›li nie uĹĽywasz window.WarsztatApi, uĹĽyj zwykĹ‚ego fetch()
                const data = await window.WarsztatApi.get(`/gus/${nip}`);
                if (data) {
                    // Automatyczne wypeĹ‚nianie
                    if(nameInput) nameInput.value = data.name || '';
                    if(cityInput) cityInput.value = data.city || '';
                    if(zipInput) zipInput.value = data.zip || '';
                    if(addressInput) addressInput.value = data.address || ''; // Ulica i nr

                    // Efekt wizualny sukcesu
                    nameInput.style.backgroundColor = '#dcfce7'; // Jasny zielony
                    setTimeout(() => nameInput.style.backgroundColor = '', 1500);
                }

            } catch (error) {
                console.error("BĹ‚Ä…d GUS:", error);
                if (error.status === 404) {
                    showError('Nie znaleziono firmy w bazie GUS.');
                } else {
                    showError('BĹ‚Ä…d pobierania danych. Wpisz rÄ™cznie.');
                }
            } finally {
                loadingEl.style.display = 'none';
                nipInput.disabled = false;
            }
        });
    }

    function showError(msg) {
        feedbackEl.textContent = msg;
        feedbackEl.style.display = 'block';
    }
});
})();

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel\parts.js
==========================================
// đź“ js/panel/dashboard.js (na koĹ„cu pliku)

const btnSearch = document.getElementById('btn-search-parts');
const partsContainer = document.getElementById('parts-results-container');

if (btnSearch) {
    btnSearch.addEventListener('click', async () => {
        const model = document.getElementById('parts-search-input').value;
        
        partsContainer.innerHTML = '<p>Szukam...</p>';

        try {
            // Pobieramy token z sessionStorage (zakĹ‚adam, ĹĽe tak go przechowujesz w auth/login.js)
            const token = sessionStorage.getItem('token'); 

            const response = await fetch(`/api/parts/search?model=${model}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const parts = await response.json();

            if (parts.length === 0) {
                partsContainer.innerHTML = '<p>Brak czÄ™Ĺ›ci.</p>';
                return;
            }

            let html = '<table class="w-full text-left mt-2"><thead><tr class="bg-gray-100"><th>Nazwa</th><th>Cena</th><th>Akcja</th></tr></thead><tbody>';
            
            parts.forEach(part => {
                html += `
                    <tr class="border-b">
                        <td class="p-2">${part.name} <br><span class="text-xs text-gray-500">${part.id}</span></td>
                        <td class="p-2 font-bold text-green-600">${part.price} PLN</td>
                        <td class="p-2">
                            <button onclick="orderPart('${part.id}')" class="bg-yellow-400 px-3 py-1 rounded text-sm hover:bg-yellow-500">ZamĂłw</button>
                        </td>
                    </tr>`;
            });
            
            html += '</tbody></table>';
            partsContainer.innerHTML = html;

        } catch (error) {
            console.error(error);
            partsContainer.innerHTML = '<p class="text-red-500">BĹ‚Ä…d poĹ‚Ä…czenia.</p>';
        }
    });
}

// Funkcja globalna do zamawiania
window.orderPart = async (partId) => {
    if(!confirm('ZamĂłwiÄ‡ czÄ™Ĺ›Ä‡?')) return;
    
    const token = sessionStorage.getItem('token');
    await fetch('/api/parts/order', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ partId })
    });
    alert('ZamĂłwienie wysĹ‚ane!');
};

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel-warsztatu\api.js
==========================================
const API_URL = 'http://localhost:4000/api';

export function getToken() {
    return localStorage.getItem('token') || sessionStorage.getItem('token');
}

export const api = {
    get: async (end) => { 
        const r = await fetch(`${API_URL}${end}`, { headers: {'Authorization': `Bearer ${getToken()}`} }); 
        if(!r.ok) throw await r.json(); return r.json(); 
    },
    post: async (end, d) => { 
        const r = await fetch(`${API_URL}${end}`, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization': `Bearer ${getToken()}`}, body:JSON.stringify(d)}); 
        if(!r.ok) throw await r.json(); return r.json(); 
    },
    patch: async (end, d) => { 
        const r = await fetch(`${API_URL}${end}`, { method:'PATCH', headers:{'Content-Type':'application/json', 'Authorization': `Bearer ${getToken()}`}, body:JSON.stringify(d)}); 
        if(!r.ok) throw await r.json(); return r.json(); 
    }
};

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel-warsztatu\auth.js
==========================================
import { getToken } from './api.js';

export function checkAuth() {
    const token = getToken();
    if (!token) {
        document.getElementById('auth-error').style.display = 'block';
        return false;
    }
    return true;
}

export function setupLogout() {
    // PoniewaĹĽ w HTML usuniemy onclick="logout()", dodajemy listener tutaj
    const btn = document.getElementById('logout-btn');
    if(btn) {
        btn.addEventListener('click', () => {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = "login.html";
        });
    }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel-warsztatu\invoices.js
==========================================
import { api } from './api.js';

let invoiceItems = [];

export async function initInvoices() {
    await loadInvoices();
    setupInvoiceForm();
    setupInvoiceButton();
}

async function loadInvoices() {
    try {
        const list = await api.get('/invoices');
        const c = document.getElementById('invoices-list');
        if(!list.length) { c.innerHTML='<p>Brak faktur.</p>'; return; }
        
        let h = '<table><thead><tr><th>Nr</th><th>Klient</th><th>Kwota</th><th>Opcje</th></tr></thead><tbody>';
        let net=0, gross=0; const m = new Date().getMonth();
        list.forEach(i => {
            if(new Date(i.created_at).getMonth()===m) { net+=i.total_net; gross+=i.total_gross; }
            h += `<tr><td>${i.number}</td><td>${i.client_name}</td><td>${i.total_gross.toFixed(2)}</td><td><button class="btn-small print-inv-btn" style="background:#6b7280"><i class="fas fa-print"></i></button></td></tr>`;
        });
        c.innerHTML = h+'</tbody></table>';
        document.getElementById('stats-netto').textContent = net.toFixed(2)+' PLN';
        document.getElementById('stats-brutto').textContent = gross.toFixed(2)+' PLN';
    } catch(e){}
}

function setupInvoiceButton() {
    // PodpiÄ™cie przycisku "Nowa Faktura"
    const btn = document.querySelector('#finanse .btn-big'); // Znajdujemy przycisk w sekcji finanse
    if(btn) btn.onclick = openInvoiceModal;
    
    // PodpiÄ™cie przyciskĂłw w modalu
    document.getElementById('add-inv-item-btn').onclick = addInvoiceItem;
    document.querySelector('#invoice-modal button[onclick*="none"]').onclick = () => document.getElementById('invoice-modal').style.display='none'; // Zamknij
}

async function openInvoiceModal() {
    document.getElementById('invoice-modal').style.display = 'flex';
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('inv-date').value = today;
    const due = new Date(); due.setDate(due.getDate() + 7);
    document.getElementById('inv-due').value = due.toISOString().split('T')[0];

    try {
        const res = await api.get('/invoices/next-number');
        document.getElementById('inv-number').value = res.number;
        const me = await api.get('/workshops/me');
        document.getElementById('inv-seller-name').value = me.name || '';
        document.getElementById('inv-seller-address').value = me.address || '';
    } catch(e) {}
    
    invoiceItems = [{name: 'UsĹ‚uga serwisowa', qty: 1, net: 100, vat: 23}];
    renderInvoiceItems();
}

function renderInvoiceItems() {
    const tbody = document.getElementById('inv-items-body');
    tbody.innerHTML = '';
    let sumNet = 0, sumVat = 0, sumGross = 0;
    invoiceItems.forEach((item, index) => {
        const gross = item.net * item.qty * (1 + item.vat/100);
        sumNet += item.net * item.qty; sumVat += (item.net * item.qty * item.vat/100); sumGross += gross;
        
        // Tworzymy wiersz
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="full-input name-input" value="${item.name}"></td>
            <td><input type="number" class="full-input qty-input" value="${item.qty}"></td>
            <td><input type="number" class="full-input net-input" value="${item.net}"></td>
            <td><input type="number" class="full-input vat-input" value="${item.vat}"></td>
            <td style="text-align:right;padding-top:15px;">${gross.toFixed(2)}</td>
            <td><button type="button" class="del-btn" style="color:red;border:none;">&times;</button></td>
        `;
        
        // Event listenery dla inputĂłw
        tr.querySelector('.name-input').onchange = (e) => updateInvItem(index, 'name', e.target.value);
        tr.querySelector('.qty-input').onchange = (e) => updateInvItem(index, 'qty', e.target.value);
        tr.querySelector('.net-input').onchange = (e) => updateInvItem(index, 'net', e.target.value);
        tr.querySelector('.vat-input').onchange = (e) => updateInvItem(index, 'vat', e.target.value);
        tr.querySelector('.del-btn').onclick = () => removeInvItem(index);
        
        tbody.appendChild(tr);
    });
    document.getElementById('inv-sum-net').textContent = sumNet.toFixed(2);
    document.getElementById('inv-sum-vat').textContent = sumVat.toFixed(2);
    document.getElementById('inv-sum-gross').textContent = sumGross.toFixed(2);
}

function updateInvItem(i, f, v) { if(f!=='name') v=parseFloat(v); invoiceItems[i][f]=v; renderInvoiceItems(); }
function addInvoiceItem() { invoiceItems.push({name:'', qty:1, net:0, vat:23}); renderInvoiceItems(); }
function removeInvItem(i) { invoiceItems.splice(i, 1); renderInvoiceItems(); }

function setupInvoiceForm() {
    document.getElementById('invoice-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            number: document.getElementById('inv-number').value,
            dateIssued: document.getElementById('inv-date').value,
            dateDue: document.getElementById('inv-due').value,
            clientName: document.getElementById('inv-client-name').value,
            clientNip: document.getElementById('inv-client-nip').value,
            clientAddress: document.getElementById('inv-client-address').value,
            items: invoiceItems,
            totalNet: parseFloat(document.getElementById('inv-sum-net').textContent),
            totalVat: parseFloat(document.getElementById('inv-sum-vat').textContent),
            totalGross: parseFloat(document.getElementById('inv-sum-gross').textContent),
        };
        try {
            await api.post('/invoices', data);
            alert("Faktura zapisana!");
            document.getElementById('invoice-modal').style.display='none';
            loadInvoices();
            generatePDF(data, {
                name: document.getElementById('inv-seller-name').value,
                nip: document.getElementById('inv-seller-nip').value,
                address: document.getElementById('inv-seller-address').value
            });
        } catch(err) { alert("BĹ‚Ä…d: " + err.message); }
    });
}

function generatePDF(inv, seller) {
    document.getElementById('pdf-number').textContent = inv.number;
    document.getElementById('pdf-seller-name').textContent = seller.name;
    document.getElementById('pdf-client-name').textContent = inv.clientName;
    document.getElementById('pdf-sum-gross').textContent = inv.totalGross.toFixed(2);
    const b = document.getElementById('pdf-items'); b.innerHTML='';
    inv.items.forEach((x,i)=> b.innerHTML+=`<tr><td>${x.name}</td><td style="text-align:right">${x.qty}</td><td style="text-align:right">${x.net}</td><td style="text-align:right">${x.vat}%</td><td style="text-align:right">${(x.net*x.qty*(1+x.vat/100)).toFixed(2)}</td></tr>`);
    const el = document.getElementById('invoice-template'); el.style.display='block';
    html2pdf().from(el).save(`Faktura_${inv.number.replace(/\//g,'-')}.pdf`).then(()=>el.style.display='none');
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel-warsztatu\main.js
==========================================
// js/panel-warsztatu/main.js

// Importujemy z tego samego folderu, wiÄ™c uĹĽywamy "./"
import { checkAuth, setupLogout } from './auth.js';
import { initNavigation } from './navigation.js';
import { initProfile } from './profile.js';
import { initReports } from './reports.js';
import { initInvoices } from './invoices.js';
import { initParts } from './parts.js';

document.addEventListener('DOMContentLoaded', () => {
    // Najpierw sprawdzamy czy user jest zalogowany
    if (!checkAuth()) return;

    // Uruchamiamy moduĹ‚y
    setupLogout();
    initNavigation();
    initProfile();
    initReports();
    initInvoices();
    initParts();
});

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel-warsztatu\navigation.js
==========================================
export function initNavigation() {
    document.querySelectorAll('.sidebar a[data-target]').forEach(link => {
        link.addEventListener('click', () => {
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            link.classList.add('active');
            
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(link.dataset.target).classList.add('active');
        });
    });
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel-warsztatu\parts.js
==========================================
import { api } from './api.js';

export function initParts() {
    const btn = document.getElementById('btn-search-parts');
    if(btn) {
        btn.onclick = async () => {
            const query = document.getElementById('parts-search-input').value;
            const container = document.getElementById('parts-results-container');
            if (!query) return;
            
            container.innerHTML = "<p>Szukam...</p>";
            try {
                const parts = await api.get(`/parts/search?q=${encodeURIComponent(query)}`);
                if (!parts || !parts.length) { container.innerHTML = "<p>Brak wynikĂłw.</p>"; return; }

                let html = "<table><thead><tr><th>Nazwa</th><th>Cena</th><th>Akcja</th></tr></thead><tbody>";
                parts.forEach(p => {
                    html += `<tr><td><strong>${p.name}</strong><br><small>${p.index}</small></td><td style="color:green;font-weight:bold">${p.price} PLN</td><td><button class="btn-small order-part-btn" data-id="${p.id}" data-name="${p.name}">ZAMĂ“W</button></td></tr>`;
                });
                container.innerHTML = html + "</tbody></table>";
                
                // Eventy dla przyciskĂłw zamĂłw
                document.querySelectorAll('.order-part-btn').forEach(b => {
                    b.onclick = () => orderPart(b.dataset.id, b.dataset.name);
                });
            } catch (e) {
                container.innerHTML = "<p style='color:red'>BĹ‚Ä…d serwera czÄ™Ĺ›ci.</p>";
            }
        };
    }
}

async function orderPart(id, name) {
    if(confirm(`ZamĂłwiÄ‡: ${name}?`)) {
        try { await api.post("/parts/order", { partId: id, partName: name, quantity: 1 }); alert("ZamĂłwiono!"); }
        catch(e) { alert("BĹ‚Ä…d zamĂłwienia"); }
    }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel-warsztatu\profile.js
==========================================
import { api } from './api.js';

export async function initProfile() {
    try {
        const me = await api.get('/workshops/me');
        const workshopNameEl = document.getElementById('workshop-name');
        if(workshopNameEl) workshopNameEl.textContent = me.name || me.email;
        
        const wName = document.getElementById('w-name');
        if(wName) wName.textContent = me.name;
        
        const wEmail = document.getElementById('w-email');
        if(wEmail) wEmail.textContent = me.email;
    } catch(e) { console.error("Profil error", e); }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\panel-warsztatu\reports.js
==========================================
import { api } from './api.js';

let reportsData = [];
let currentFilter = 'all';

export async function initReports() {
    await loadReports();
    setupFilters();
    setupSearch();
    setupForm();
    setupVinAutofill();
    setupPreviewModal();
}

async function loadReports() {
    try {
        reportsData = await api.get('/reports/mine');
        renderReports();
    } catch(e) { document.getElementById('reports-container').innerHTML = `<p>BĹ‚Ä…d pobierania</p>`; }
}

function renderReports(q = "") {
    const container = document.getElementById('reports-container');
    q = q.toLowerCase();
    
    const filtered = reportsData.filter(r => {
        let statusMatch = true;
        if (currentFilter === 'approved') statusMatch = (r.status === 'approved' || r.approvalStatus === 'approved');
        else if (currentFilter === 'pending') statusMatch = (r.status === 'pending' || r.approvalStatus === 'pending' || !r.approvalStatus);
        else if (currentFilter === 'rejected') statusMatch = (r.status === 'rejected' || r.approvalStatus === 'rejected');
        return statusMatch && (r.vin?.toLowerCase().includes(q) || r.plate?.toLowerCase().includes(q));
    });

    if(!filtered.length) { container.innerHTML='<p style="text-align:center">Brak wynikĂłw.</p>'; return; }

    let html = `<table><thead><tr><th>Pojazd</th><th>VIN</th><th>Data</th><th>Status</th><th>Akcje</th></tr></thead><tbody>`;
    filtered.forEach(r => {
        let v = r.model || "Auto";
        if(r.summary && r.summary.match(/\[Pojazd: (.*?)\]/)) v = r.summary.match(/\[Pojazd: (.*?)\]/)[1];
        let badge='pending', txt='OczekujÄ…cy';
        if(r.status==='approved' || r.approvalStatus==='approved') { badge='approved'; txt='Zatwierdzony'; }
        else if(r.status==='rejected' || r.approvalStatus==='rejected') { badge='rejected'; txt='Do poprawy'; }
        
        // Dodajemy ID do przyciskĂłw, aby obsĹ‚uĹĽyÄ‡ je event listenerami
        html += `<tr><td>${v}</td><td>${r.vin}</td><td>${new Date(r.createdAt || r.date).toLocaleDateString()}</td><td><span class="badge ${badge}">${txt}</span></td><td>
            <button class="btn-small view-report-btn" data-id="${r.id}" style="background:#6b7280"><i class="fas fa-eye"></i></button> 
            <button class="btn-small edit-report-btn" data-id="${r.id}" style="background:var(--p)"><i class="fas fa-pen"></i></button>
        </td></tr>`;
    });
    container.innerHTML = html + '</tbody></table>';

    // Podpinanie eventĂłw po wyrenderowaniu HTML
    document.querySelectorAll('.view-report-btn').forEach(b => b.onclick = () => viewReport(b.dataset.id));
    document.querySelectorAll('.edit-report-btn').forEach(b => b.onclick = () => startEdit(b.dataset.id));
}

function setupFilters() {
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentFilter = tab.dataset.filter;
            renderReports();
        });
    });
}

function setupSearch() {
    document.getElementById('search-reports').addEventListener('input', (e) => renderReports(e.target.value));
}

function setupForm() {
    const form = document.getElementById('report-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            vin: document.getElementById('vin').value,
            plate: document.getElementById('plate').value,
            make: document.getElementById('make').value,
            model: document.getElementById('model').value,
            mileage: document.getElementById('mileage').value,
            firstRegistrationDate: document.getElementById('first-reg-date').value || null,
            description: document.getElementById('description').value
        };
        const editId = document.getElementById('edit-report-id').value;
        try {
            if (editId) await api.patch(`/reports/mine/${editId}`, payload);
            else await api.post('/reports/mine', payload);
            
            alert(editId ? "Zaktualizowano!" : "Dodano nowy raport!");
            if(!editId) { 
                form.reset(); 
                toggleLock(false);
                document.getElementById('auto-fill-banner').style.display='none';
            }
            await loadReports();
            if(!editId) document.querySelector('[data-target="moje"]').click();
        } catch(err) { alert("BĹ‚Ä…d: " + (err.message || "SprawdĹş dane")); }
    });

    document.getElementById('cancel-edit-btn').addEventListener('click', () => {
        form.reset();
        document.getElementById('edit-report-id').value = "";
        document.getElementById('form-title').textContent = "Nowy raport serwisowy";
        document.getElementById('cancel-edit-btn').style.display = 'none';
        toggleLock(false);
        document.getElementById('auto-fill-banner').style.display='none';
    });
}

function setupVinAutofill() {
    const vinInput = document.getElementById('vin');
    vinInput.addEventListener('blur', async () => {
        const vin = vinInput.value.toUpperCase().trim();
        if(vin.length === 17) {
            try {
                const history = await api.get(`/reports/public/${vin}`);
                if (history && history.length > 0) {
                    const lastReport = history[0]; 
                    let make = "Nieznana", model = "Nieznany";
                    const match = (lastReport.summary || "").match(/\[Pojazd: (.*?) (.*?)\]/);
                    if (match) { make = match[1]; model = match[2]; } else if (lastReport.model) { model = lastReport.model; }

                    document.getElementById('make').value = make;
                    document.getElementById('model').value = model;
                    if(lastReport.firstRegistrationDate) document.getElementById('first-reg-date').value = lastReport.firstRegistrationDate.split('T')[0];
                    
                    toggleLock(true);
                    document.getElementById('auto-fill-banner').style.display = 'flex';
                } else {
                    toggleLock(false);
                    document.getElementById('auto-fill-banner').style.display = 'none';
                }
            } catch(e) {}
        }
    });
}

function toggleLock(lock) {
    ['make', 'model', 'first-reg-date'].forEach(id => {
        const el = document.getElementById(id);
        el.readOnly = lock;
        if(lock) {
            el.classList.add('locked', 'animate-fill');
            el.parentElement.querySelector('.lock').style.display = 'block';
            el.parentElement.parentElement.querySelector('.info-tooltip').style.display = 'block';
            setTimeout(()=>el.classList.remove('animate-fill'), 1500);
        } else {
            el.value = '';
            el.classList.remove('locked');
            el.parentElement.querySelector('.lock').style.display = 'none';
            el.parentElement.parentElement.querySelector('.info-tooltip').style.display = 'none';
        }
    });
}

function viewReport(id) {
    const r = reportsData.find(x => x.id == id);
    let v = r.model; if(r.summary && r.summary.match(/\[Pojazd: (.*?)\]/)) v = r.summary.match(/\[Pojazd: (.*?)\]/)[1];
    document.getElementById('preview-content').innerHTML = `<p><strong>${v}</strong><br>VIN: ${r.vin}</p><p>${r.summary || r.description}</p>`;
    document.getElementById('preview-modal').style.display='flex';
}

function startEdit(id) {
    const r = reportsData.find(x => x.id == id);
    document.querySelector('[data-target="dodaj"]').click();
    document.getElementById('edit-report-id').value = r.id;
    document.getElementById('vin').value = r.vin;
    document.getElementById('plate').value = r.registrationNumber || r.plate;
    document.getElementById('mileage').value = r.mileageKm || r.mileage;
    if(r.firstRegistrationDate) document.getElementById('first-reg-date').value = r.firstRegistrationDate.split('T')[0];
    
    let summary = r.summary || "";
    const match = summary.match(/\[Pojazd: (.*?) (.*?)\] (.*)/s);
    if (match) { 
        document.getElementById('make').value = match[1]; 
        document.getElementById('model').value = match[2]; 
        document.getElementById('description').value = match[3]; 
    } else { 
        document.getElementById('description').value = summary; 
    }
    
    document.getElementById('form-title').textContent = "Edycja raportu";
    document.getElementById('cancel-edit-btn').style.display = 'inline-block';
}

function setupPreviewModal() {
    // Podpinanie przycisku zamknij w modalu podglÄ…du
    const closeBtn = document.querySelector('#preview-modal button');
    if(closeBtn) closeBtn.onclick = () => document.getElementById('preview-modal').style.display='none';
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\shared\api.js
==========================================
(function (window) {
    const guessBaseUrl = () => {
        if (window.__WARSZTAT_API_BASE__) {
            return window.__WARSZTAT_API_BASE__;
        }
        const origin = window.location.origin;
        const devMatch = origin.match(/:(3\d{3})$/);
        if (devMatch) {
            return origin.replace(/:(3\d{3})$/, ':4000') + '/api';
        }
        return `${origin}/api`;
    };

    let baseUrl = guessBaseUrl().replace(/\/$/, '');
    let authToken = null;

    const isFormData = (value) => typeof FormData !== 'undefined' && value instanceof FormData;

    async function request(path, options = {}) {
        const url = `${baseUrl}${path.startsWith('/') ? path : `/${path}`}`;
        const headers = { ...(options.headers || {}) };
        let body = options.body;

        if (body && !isFormData(body)) {
            headers['Content-Type'] = 'application/json';
            body = JSON.stringify(body);
        }

        const requiresAuth = options.auth !== false;
        if (requiresAuth && authToken) {
            headers.Authorization = `Bearer ${authToken}`;
        }

        const response = await fetch(url, {
            method: options.method || 'GET',
            headers,
            body
        });

        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');

        if (!response.ok) {
            const errorPayload = isJson ? await response.json().catch(() => null) : null;
            const error = new Error(errorPayload?.message || 'Request failed');
            error.status = response.status;
            error.details = errorPayload;
            throw error;
        }

        if (response.status === 204) {
            return null;
        }

        return isJson ? response.json() : response.text();
    }

    window.WarsztatApi = {
        getBaseUrl: () => baseUrl,
        setBaseUrl: (url) => {
            baseUrl = (url || '').replace(/\/$/, '');
        },
        setToken: (token) => {
            authToken = token;
        },
        clearToken: () => {
            authToken = null;
        },
        getToken: () => authToken,
        request,
        get: (path, options = {}) => request(path, { ...options, method: 'GET' }),
        post: (path, body, options = {}) => request(path, { ...options, method: 'POST', body }),
        patch: (path, body, options = {}) => request(path, { ...options, method: 'PATCH', body }),
        delete: (path, options = {}) => request(path, { ...options, method: 'DELETE' })
    };
})(window);

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\shared\logs.js
==========================================
(function (window) {
    const LOGS_KEY = 'warsztat:logs';

    const safeParse = (value) => {
        try {
            return JSON.parse(value) || [];
        } catch (error) {
            console.warn('Blad podczas odczytu logow', error);
            return [];
        }
    };

    const readLogs = () => safeParse(localStorage.getItem(LOGS_KEY));

    const saveLogs = (items) => {
        localStorage.setItem(LOGS_KEY, JSON.stringify(items));
    };

    const addLog = (entry) => {
        const logs = readLogs();
        logs.unshift({ id: Date.now(), timestamp: new Date().toISOString(), ...entry });
        saveLogs(logs.slice(0, 200));
        return logs;
    };

    window.WarsztatLogs = {
        getAll: readLogs,
        add: addLog,
        clear: () => saveLogs([])
    };
})(window);

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\shared\reports.js
==========================================
(function (window) {
    const REPORTS_KEY = 'warsztat:reports';
    const APPROVAL_STATES = {
        pending: 'pending',
        approved: 'approved',
        rejected: 'rejected'
    };
    const sampleReports = [
        {
            id: 1,
            vin: 'WAUZZZ8V9JA123456',
            registrationNumber: 'WX1234K',
            workshopId: 'wrk_demo_1',
            mileageKm: 183500,
            firstRegistrationDate: '2018-05-12',
            workshop: 'Auto Serwis 24',
            status: 'Zakonczona',
            updatedAt: '2024-11-18T10:00:00.000Z',
            summary: 'Wymiana rozrzadu oraz oleju.',
            approvalStatus: APPROVAL_STATES.approved,
            media: [
                {
                    id: 'med_demo_1',
                    name: 'silnik-po.jpg',
                    type: 'image/jpeg',
                    size: 102400,
                    dataUrl: '',
                    description: 'Silnik po naprawie'
                }
            ]
        },
        {
            id: 2,
            vin: 'VF3LCBHY6HS789012',
            registrationNumber: 'KR5GS89',
            workshopId: 'wrk_demo_2',
            mileageKm: 99500,
            firstRegistrationDate: '2019-03-22',
            workshop: 'MotorTech Pro',
            status: 'W trakcie',
            updatedAt: '2025-01-05T08:30:00.000Z',
            summary: 'Diagnostyka elektroniki silnika.',
            approvalStatus: APPROVAL_STATES.approved,
            media: []
        }
    ];

    const normalizeMileage = (value) => {
        const mileage = Number(value);
        return Number.isFinite(mileage) && mileage >= 0 ? Math.round(mileage) : null;
    };

    const normalizeFirstRegistration = (value) => {
        if (!value) {
            return null;
        }
        try {
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return String(value);
            }
            return date.toISOString().split('T')[0];
        } catch (error) {
            return String(value);
        }
    };

    const normalizeMediaItem = (item, index = 0) => {
        if (!item || typeof item !== 'object') {
            return null;
        }
        return {
            id: item.id || `media_${Date.now()}_${index}`,
            name: item.name || 'Zalacznik',
            type: item.type || 'application/octet-stream',
            size: Number(item.size) || 0,
            dataUrl: item.dataUrl || '',
            description: item.description || '',
            createdAt: item.createdAt || new Date().toISOString()
        };
    };

    const safeParse = (value) => {
        try {
            return JSON.parse(value) || [];
        } catch (error) {
            console.warn('Nie udalo sie odczytac raportow', error);
            return [];
        }
    };

    const normalizeReport = (report, index = 0) => {
        if (!report) {
            return report;
        }
        const createdAt = report.createdAt || report.updatedAt || new Date().toISOString();
        const updatedAt = report.updatedAt || createdAt;
        const approvalStatus = report.approvalStatus || APPROVAL_STATES.pending;
        const registrationNumber = (report.registrationNumber || '').toUpperCase();
        return {
            id: report.id || Date.now() + index,
            vin: report.vin || 'NIEZNANY VIN',
            workshop: report.workshop || 'Nieznany warsztat',
            workshopId: report.workshopId || null,
            registrationNumber,
            mileageKm: normalizeMileage(report.mileageKm),
            firstRegistrationDate: normalizeFirstRegistration(report.firstRegistrationDate),
            status: report.status || 'W trakcie',
            summary: report.summary || '',
            createdAt,
            updatedAt,
            approvalStatus,
            moderationNote: report.moderationNote || '',
            moderatedAt: report.moderatedAt || (approvalStatus !== APPROVAL_STATES.pending ? updatedAt : null),
            moderatedBy: report.moderatedBy || null,
            media: Array.isArray(report.media)
                ? report.media.map((item, mediaIndex) => normalizeMediaItem(item, mediaIndex)).filter(Boolean)
                : []
        };
    };

    const saveReports = (items) => {
        localStorage.setItem(REPORTS_KEY, JSON.stringify(items));
    };

    const ensureSeeded = () => {
        if (localStorage.getItem(REPORTS_KEY)) {
            return;
        }
        saveReports(sampleReports);
    };

    const getAllReports = () => {
        const raw = safeParse(localStorage.getItem(REPORTS_KEY));
        const normalized = raw.map((report, index) => normalizeReport(report, index));
        saveReports(normalized);
        return normalized;
    };

    const findByVin = (vin) => getAllReports().filter((item) => item.vin === vin);

    const findById = (id) => getAllReports().find((item) => item.id === id);

    const updateReport = (id, updates) => {
        const reports = getAllReports();
        const index = reports.findIndex((item) => item.id === id);
        if (index === -1) {
            throw new Error('Nie znaleziono raportu.');
        }
        const previous = reports[index];
        const approvalChanged =
            typeof updates.approvalStatus !== 'undefined' && updates.approvalStatus !== previous.approvalStatus;
        reports[index] = normalizeReport(
            {
                ...previous,
                ...updates,
                updatedAt: updates.updatedAt || new Date().toISOString(),
                moderatedAt: approvalChanged ? new Date().toISOString() : previous.moderatedAt,
                moderatedBy: approvalChanged ? updates.moderatedBy || previous.moderatedBy : previous.moderatedBy
            },
            index
        );
        saveReports(reports);
        return reports[index];
    };

    const createReport = (payload) => {
        const reports = getAllReports();
        const now = new Date().toISOString();
        const report = normalizeReport({
            ...payload,
            id: Date.now(),
            createdAt: now,
            updatedAt: now,
            approvalStatus: APPROVAL_STATES.pending
        });
        reports.push(report);
        saveReports(reports);
        return report;
    };

    const moderateReport = (id, { approvalStatus, moderationNote, actor }) =>
        updateReport(id, {
            approvalStatus,
            moderationNote,
            moderatedBy: actor
        });

    window.WarsztatReports = {
        ensureSeeded,
        findByVin,
        getAll: getAllReports,
        getById: findById,
        update: updateReport,
        create: createReport,
        moderate: moderateReport,
        APPROVAL_STATES
    };
})(window);

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\shared\session.js
==========================================
(function (window) {
    const SESSION_KEY = 'warsztat:session';

    const readSession = () => {
        try {
            return JSON.parse(sessionStorage.getItem(SESSION_KEY));
        } catch (error) {
            return null;
        }
    };

    const persistSession = (session) => {
        if (!session) {
            sessionStorage.removeItem(SESSION_KEY);
            return;
        }
        sessionStorage.setItem(SESSION_KEY, JSON.stringify(session));
    };

    const syncApiToken = (token) => {
        if (!window.WarsztatApi) {
            return;
        }
        if (token) {
            window.WarsztatApi.setToken(token);
        } else {
            window.WarsztatApi.clearToken();
        }
    };

    const current = readSession();
    if (current?.token) {
        syncApiToken(current.token);
    }

    window.WarsztatSession = {
        save: (session) => {
            persistSession(session);
            syncApiToken(session?.token);
        },
        get: readSession,
        clear: () => {
            persistSession(null);
            syncApiToken(null);
        },
        getToken: () => readSession()?.token || null
    };
})(window);

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\shared\settings.js
==========================================
(function (window) {
    const SETTINGS_KEY = 'warsztat:settings';
    const DEFAULTS = {
        licenseMonths: 12,
        statusOptions: ['Przyjeta', 'W trakcie', 'Zakonczona']
    };

    const safeParse = (value) => {
        try {
            return JSON.parse(value) || {};
        } catch (error) {
            console.warn('Blad podczas odczytu ustawien', error);
            return {};
        }
    };

    const mergeObjects = (base = {}, patch = {}) => {
        const result = { ...base };
        Object.keys(patch).forEach((key) => {
            const value = patch[key];
            if (Array.isArray(value)) {
                result[key] = [...value];
                return;
            }
            if (value && typeof value === 'object') {
                result[key] = mergeObjects(base[key] || {}, value);
                return;
            }
            result[key] = value;
        });
        return result;
    };

    const getSettings = () => mergeObjects(DEFAULTS, safeParse(localStorage.getItem(SETTINGS_KEY)));

    const saveSettings = (settings) => {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    };

    const updateSettings = (partial) => {
        const merged = mergeObjects(getSettings(), partial);
        saveSettings(merged);
        return merged;
    };

    window.WarsztatSettings = {
        get: getSettings,
        save: saveSettings,
        update: updateSettings,
        DEFAULTS
    };
})(window);

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\shared\workshops.js
==========================================
(function (window) {
    const STORAGE_KEY = 'warsztat:workshops';
    const DEFAULT_LICENSE_MONTHS = 12;
    const CONTRACT_MONTHS = 12;
    const TERMINATION_NOTICE_MONTHS = 3;

    const safeParse = (value) => {
        try {
            return JSON.parse(value) || [];
        } catch (error) {
            console.warn('Blad podczas odczytu warsztatow', error);
            return [];
        }
    };

    const endOfMonth = (date) => {
        const result = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        result.setHours(23, 59, 59, 999);
        return result.toISOString();
    };

    const addMonths = (isoDate, months) => {
        const date = isoDate ? new Date(isoDate) : new Date();
        const originalDay = date.getDate();
        date.setMonth(date.getMonth() + months);
        if (date.getDate() < originalDay) {
            date.setDate(0);
        }
        return date.toISOString();
    };

    const calculateTerminationEnd = (noticeDate) => {
        const notice = noticeDate ? new Date(noticeDate) : new Date();
        notice.setMonth(notice.getMonth() + TERMINATION_NOTICE_MONTHS);
        return endOfMonth(notice);
    };

    const applyContractRules = (workshop) => {
        if (!workshop) {
            return workshop;
        }
        const now = Date.now();
        const fixedEndTime = workshop.contractFixedEnd ? new Date(workshop.contractFixedEnd).getTime() : 0;
        if (!workshop.contractIndefiniteSince && fixedEndTime && now >= fixedEndTime) {
            workshop.contractIndefiniteSince = workshop.contractFixedEnd;
        }

        const hasIndefinite = Boolean(workshop.contractIndefiniteSince);

        if (workshop.terminationNoticeDate) {
            const terminationEnd = workshop.terminationEndDate || calculateTerminationEnd(workshop.terminationNoticeDate);
            workshop.terminationEndDate = terminationEnd;
            const terminationEndTime = new Date(terminationEnd).getTime();
            if (now >= terminationEndTime) {
                workshop.active = false;
                workshop.contractStatus = 'terminated';
                workshop.terminatedAt = workshop.terminatedAt || terminationEnd;
            } else {
                workshop.contractStatus = 'notice';
            }
        } else if (!workshop.active) {
            workshop.contractStatus = hasIndefinite ? 'indefinite' : 'fixed';
        } else if (hasIndefinite) {
            workshop.contractStatus = 'indefinite';
        } else {
            workshop.contractStatus = 'fixed';
        }

        return workshop;
    };

    const normalizeWorkshop = (item) => {
        if (!item) {
            return item;
        }
        const licenseStart = item.licenseStart || item.createdAt || new Date().toISOString();
        const licenseEnd = item.licenseEnd || addMonths(licenseStart, DEFAULT_LICENSE_MONTHS);
        const contractFixedEnd = item.contractFixedEnd || addMonths(licenseStart, CONTRACT_MONTHS);
        const normalized = {
            ...item,
            active: item.active !== false,
            createdAt: item.createdAt || new Date().toISOString(),
            licenseStart,
            licenseEnd,
            billingAmount: Number(item.billingAmount) || 0,
            contractFixedEnd,
            contractIndefiniteSince: item.contractIndefiniteSince || null,
            terminationNoticeDate: item.terminationNoticeDate || null,
            terminationEndDate: item.terminationEndDate || null,
            contractStatus: item.contractStatus || 'fixed',
            terminatedAt: item.terminatedAt || null
        };
        return applyContractRules(normalized);
    };

    const readAll = () => {
        const raw = safeParse(localStorage.getItem(STORAGE_KEY));
        let mutated = false;
        const normalized = raw.map((item) => {
            const result = normalizeWorkshop(item);
            if (!mutated && JSON.stringify(result) !== JSON.stringify(item)) {
                mutated = true;
            }
            return result;
        });
        if (mutated) {
            saveAll(normalized);
        }
        return normalized;
    };

    const saveAll = (items) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    };

    const existsByEmail = (email) => readAll().some((item) => item.email === email);

    const createWorkshop = (payload, options = {}) => {
        const workshops = readAll();
        if (workshops.some((item) => item.email === payload.email)) {
            throw new Error('Warsztat z tym adresem e-mail juz istnieje.');
        }

        const now = new Date().toISOString();
        const licenseMonths = options.licenseMonths || DEFAULT_LICENSE_MONTHS;
        const workshop = normalizeWorkshop({
            id: Date.now(),
            name: payload.name,
            email: payload.email,
            registration: payload.registration,
            password: payload.password,
            active: true,
            createdAt: now,
            licenseStart: now,
            licenseEnd: addMonths(now, licenseMonths),
            billingAmount: Number(payload.billingAmount) || 0
        });

        workshops.push(workshop);
        saveAll(workshops);
        return workshops;
    };

    const applyUpdate = (id, updater) => {
        const workshops = readAll();
        const index = workshops.findIndex((item) => item.id === id);
        if (index === -1) {
            throw new Error('Nie znaleziono warsztatu.');
        }
        const updated = normalizeWorkshop(updater({ ...workshops[index] }));
        workshops[index] = updated;
        saveAll(workshops);
        return workshops;
    };

    const extendLicense = (id, months) =>
        applyUpdate(id, (item) => ({
            ...item,
            licenseEnd: addMonths(item.licenseEnd, months)
        }));

    const toggleActive = (id, isActive) =>
        applyUpdate(id, (item) => ({
            ...item,
            active: isActive
        }));

    const issueTerminationNotice = (id, noticeDate = new Date().toISOString()) =>
        applyUpdate(id, (item) => {
            if (item.contractStatus !== 'indefinite') {
                throw new Error('Umowa nie jest na czas nieokreslony.');
            }
            const terminationNoticeDate = noticeDate;
            const terminationEndDate = calculateTerminationEnd(terminationNoticeDate);
            return {
                ...item,
                terminationNoticeDate,
                terminationEndDate,
                contractStatus: 'notice'
            };
        });

    const cancelTerminationNotice = (id) =>
        applyUpdate(id, (item) => {
            if (!item.terminationNoticeDate) {
                return item;
            }
            return {
                ...item,
                terminationNoticeDate: null,
                terminationEndDate: null,
                terminatedAt: null,
                contractStatus: item.contractIndefiniteSince ? 'indefinite' : 'fixed'
            };
        });

    const resetPassword = (id, newPassword) =>
        applyUpdate(id, (item) => ({
            ...item,
            password: newPassword
        }));

    const updateWorkshop = (id, updates) =>
        applyUpdate(id, (item) => ({
            ...item,
            ...updates
        }));

    const findByCredentials = (email, password) =>
        readAll().find((item) => item.email === email && item.password === password);

    const getContractState = (workshopId) => {
        const current = readAll().find((item) => item.id === workshopId);
        return current ? { ...current } : null;
    };

    window.WarsztatWorkshops = {
        getAll: readAll,
        create: createWorkshop,
        existsByEmail,
        findByCredentials,
        extendLicense,
        toggleActive,
        issueTermination: issueTerminationNotice,
        cancelTermination: cancelTerminationNotice,
        resetPassword,
        update: updateWorkshop,
        getContractState
    };
})(window);

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\login.js
==========================================
(function () {
    const ADMIN_CREDENTIALS = { login: 'test', password: 'test' };
    const STORAGE_KEY = 'warsztat:workshops';

    const state = {
        adminAuthenticated: false
    };

    const readWorkshops = () => {
        try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch (error) {
            console.warn('Blad podczas odczytu warsztatow', error);
            return [];
        }
    };

    const saveWorkshops = (items) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    };

    const setFeedback = (element, message, type) => {
        if (!element) {
            return;
        }
        element.textContent = message;
        element.classList.remove('is-error', 'is-success');
        if (type) {
            element.classList.add(type === 'error' ? 'is-error' : 'is-success');
        }
    };

    const renderWorkshopList = (container) => {
        if (!container) {
            return;
        }
        const items = readWorkshops();
        if (!items.length) {
            container.innerHTML = '<li>Brak aktywnych kont. Utworz pierwsze konto.</li>';
            return;
        }
        container.innerHTML = items
            .map((item) => `
                <li>
                    <strong>${item.name}</strong><br>
                    <span>${item.email}</span> | <span>${item.registration}</span>
                </li>
            `)
            .join('');
    };

    document.addEventListener('DOMContentLoaded', () => {
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminFeedback = document.querySelector('[data-feedback="admin"]');
        const adminTools = document.getElementById('admin-tools');
        const createWorkshopForm = document.getElementById('create-workshop-form');
        const workshopList = document.getElementById('workshop-list');
        const workshopLoginForm = document.getElementById('workshop-login-form');
        const workshopFeedback = document.querySelector('[data-feedback="workshop"]');
        const workshopSuccess = document.getElementById('workshop-success');

        renderWorkshopList(workshopList);

        adminLoginForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(adminLoginForm);
            const login = String(formData.get('login') || '').trim();
            const password = String(formData.get('password') || '').trim();

            if (login === ADMIN_CREDENTIALS.login && password === ADMIN_CREDENTIALS.password) {
                state.adminAuthenticated = true;
                adminTools?.classList.remove('is-hidden');
                setFeedback(adminFeedback, 'Zalogowano poprawnie. Mozesz tworzyc konta warsztatow.', 'success');
                adminLoginForm.reset();
            } else {
                setFeedback(adminFeedback, 'Niepoprawne dane logowania administratora.', 'error');
            }
        });

        createWorkshopForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!state.adminAuthenticated) {
                setFeedback(adminFeedback, 'Najpierw zaloguj administratora.', 'error');
                return;
            }

            const formData = new FormData(createWorkshopForm);
            const name = String(formData.get('name') || '').trim();
            const email = String(formData.get('email') || '').trim().toLowerCase();
            const registration = String(formData.get('registration') || '').trim();
            const tempPassword = String(formData.get('tempPassword') || '').trim();

            if (!name || !email || !registration || !tempPassword) {
                setFeedback(adminFeedback, 'Uzupelnij wszystkie pola formularza.', 'error');
                return;
            }

            const workshops = readWorkshops();
            if (workshops.some((item) => item.email === email)) {
                setFeedback(adminFeedback, 'Warsztat z tym adresem e-mail juz istnieje.', 'error');
                return;
            }

            workshops.push({
                id: Date.now(),
                name,
                email,
                registration,
                password: tempPassword
            });
            saveWorkshops(workshops);
            renderWorkshopList(workshopList);
            createWorkshopForm.reset();
            setFeedback(adminFeedback, 'Nowe konto warsztatu zostalo utworzone.', 'success');
        });

        workshopLoginForm?.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(workshopLoginForm);
            const email = String(formData.get('email') || '').trim().toLowerCase();
            const password = String(formData.get('password') || '').trim();

            const match = readWorkshops().find((item) => item.email === email && item.password === password);

            if (match) {
                setFeedback(workshopFeedback, `Zalogowano jako ${match.name}.`, 'success');
                workshopSuccess?.classList.remove('is-hidden');
                workshopSuccess.querySelector('h3').textContent = `Witaj, ${match.name}!`;
                workshopLoginForm.reset();
            } else {
                setFeedback(workshopFeedback, 'Niepoprawne dane logowania warsztatu.', 'error');
            }
        });
    });
})();

==========================================
PLIK: C:\Users\brons\Desktop\strona\js\main.js
==========================================

(function () {
			// --- ObsĹ‚uga klikniÄ™cia na kartÄ™ warsztatu i pobieranie szczegĂłĹ‚Ăłw ---
			document.addEventListener('click', async function (e) {
				const card = e.target.closest('.workshop-card[data-id]');
				if (card) {
					const id = card.getAttribute('data-id');
					if (!id) return;
					showWorkshopDetail(id);
				}
			});

			async function showWorkshopDetail(id) {
				const detail = document.getElementById('workshop-browser-detail');
				const list = document.getElementById('workshop-browser-list');
				if (!detail || !list) return;
				detail.hidden = false;
				detail.style.display = '';
				list.hidden = true;
				list.style.display = 'none';
				// Loader
				const title = document.getElementById('workshop-detail-title');
				if (title) title.textContent = 'Ĺadowanie...';
				// Pobierz szczegĂłĹ‚y warsztatu
				try {
					const res = await fetch(`/api/workshops/${id}`, { credentials: 'include' });
					if (!res.ok) throw new Error('BĹ‚Ä…d pobierania szczegĂłĹ‚Ăłw warsztatu');
					const data = await res.json();
					renderWorkshopDetail(data);
				} catch (err) {
					if (title) title.textContent = 'BĹ‚Ä…d Ĺ‚adowania';
				}
			}

			function renderWorkshopDetail(data) {
				// Ustaw nagĹ‚Ăłwek
				const title = document.getElementById('workshop-detail-title');
				if (title) title.textContent = data.name || 'SzczegĂłĹ‚y warsztatu';
				
				// Ustaw dane w sekcji AktywnoĹ›Ä‡/Abonament
				const sub = document.getElementById('workshop-detail-subscription');
				if (sub) {
					sub.innerHTML = `
						<div class="workshop-detail__item"><strong>Status abonamentu</strong><div>${data.subscriptionAmount ? 'Aktywny' : 'Brak danych'}</div></div>
						<div class="workshop-detail__item"><strong>Kwota miesiÄ™czna</strong><div>${data.subscriptionAmount || 'Brak danych'}</div></div>
						<div class="workshop-detail__item"><strong>Start umowy</strong><div>${data.subscriptionStartDate || 'Brak danych'}</div></div>
						<div class="workshop-detail__item"><strong>Koniec okresu 12 mies.</strong><div>${data.subscriptionStartDate && data.subscriptionMonths ? getEndDate(data.subscriptionStartDate, data.subscriptionMonths) : 'Brak danych'}</div></div>
						<div class="workshop-detail__item"><strong>E-mail do faktur</strong><div>${data.billingEmail || 'Brak danych'}</div></div>
					`;
				}
				
				// Ustaw dane w formularzu ustawieĹ„
				const settingsForm = document.getElementById('workshop-settings-form');
				if (settingsForm) {
					Array.from(settingsForm.elements).forEach(el => {
						if (!el.name) return;
						if (el.type === 'checkbox') {
							el.checked = !!data[el.name];
						} else {
							el.value = data[el.name] || '';
						}
					});
				}
				
				// Renderuj dodatkowe sekcje
				renderWorkshopLogs();
				renderWorkshopTickets();
				renderWorkshopReports(data.id);
			}

			// Funkcje pomocnicze
			async function renderWorkshopLogs() {
				const logsList = document.getElementById('workshop-detail-logs');
				if (!logsList) return;
				logsList.innerHTML = '<li>Ĺadowanie logĂłw...</li>';
				try {
					const res = await fetch('/api/logs?limit=30', { credentials: 'include' });
					if (!res.ok) throw new Error('BĹ‚Ä…d pobierania logĂłw');
					const logs = await res.json();
					if (!Array.isArray(logs) || logs.length === 0) {
						logsList.innerHTML = '<li>Brak logĂłw do wyĹ›wietlenia.</li>';
						return;
					}
					logsList.innerHTML = logs.map(renderLogItem).join('');
				} catch (err) {
					logsList.innerHTML = `<li>${err.message || 'BĹ‚Ä…d sieci'}</li>`;
				}
			}

			function renderLogItem(log) {
				return `<li><b>${log.createdAt ? log.createdAt.substring(0, 16).replace('T', ' ') : ''}</b> â€” ${log.message || ''}</li>`;
			}

			function renderWorkshopTickets() {
				const tickets = document.getElementById('workshop-detail-tickets');
				if (tickets) {
					tickets.innerHTML = '<div class="panel-empty">Brak obsĹ‚ugi zgĹ‚oszeĹ„ w API.</div>';
				}
			}

			async function renderWorkshopReports(workshopId) {
				const reportsList = document.getElementById('workshop-reports-list');
				if (!reportsList) return;
				reportsList.innerHTML = '<div class="panel-loading">Ĺadowanie raportĂłw...</div>';
				try {
					const res = await fetch(`/api/reports?workshopId=${encodeURIComponent(workshopId)}`, { credentials: 'include' });
					if (!res.ok) throw new Error('BĹ‚Ä…d pobierania raportĂłw');
					const reports = await res.json();
					if (!Array.isArray(reports) || reports.length === 0) {
						reportsList.innerHTML = '<div class="panel-empty">Brak raportĂłw dla tego warsztatu.</div>';
						return;
					}
					reportsList.innerHTML = `
						<div class="panel-debug" style="background:#ffe;border:1px solid #cc0;padding:4px 8px;margin-bottom:8px;font-size:13px;">
							<b>Debug:</b> workshopId = <code>${workshopId}</code>, raportĂłw = <b>${reports.length}</b>
						</div>
						${reports.map(renderReportItem).join('')}
					`;
				} catch (err) {
					reportsList.innerHTML = `<div class="panel-error">${err.message || 'BĹ‚Ä…d sieci'}</div>`;
				}
			}

			function renderReportItem(r) {
				return `
					<div class="report-item">
						<div><b>VIN:</b> ${r.vin || '-'}</div>
						<div><b>Status:</b> ${r.status || '-'}</div>
						<div><b>Podsumowanie:</b> ${r.summary || '-'}</div>
						<div><b>Data:</b> ${r.updatedAt || '-'}</div>
					</div>
				`;
			}

			// --- Renderowanie listy warsztatĂłw z backendu ---
			async function fetchWorkshops() {
				const list = document.getElementById('workshop-list');
				if (!list) return;
				list.innerHTML = '<div class="panel-loading">Ĺadowanie warsztatĂłw...</div>';
			reportsList.innerHTML = '<div class="panel-loading">Ĺadowanie raportĂłw...</div>';
			try {
				const res = await fetch(`/api/reports?workshopId=${encodeURIComponent(workshopId)}`, { credentials: 'include' });
				if (!res.ok) throw new Error('BĹ‚Ä…d pobierania raportĂłw');
				const reports = await res.json();
				if (!Array.isArray(reports) || reports.length === 0) {
					reportsList.innerHTML = '<div class="panel-empty">Brak raportĂłw dla tego warsztatu.</div>';
					return;
				}
				   // DEBUG: WyĹ›wietl ID warsztatu i liczbÄ™ raportĂłw
				   reportsList.innerHTML = `
					   <div class="panel-debug" style="background:#ffe;border:1px solid #cc0;padding:4px 8px;margin-bottom:8px;font-size:13px;">
						   <b>Debug:</b> workshopId = <code>${workshopId}</code>, raportĂłw = <b>${reports.length}</b>
					   </div>
					   ${reports.map(renderReportItem).join('')}
				   `;
			} catch (err) {
				reportsList.innerHTML = `<div class="panel-error">${err.message || 'BĹ‚Ä…d sieci'}</div>`;
			}
		}

		function renderReportItem(r) {
			return `
				<div class="report-item">
					<div><b>VIN:</b> ${r.vin || '-'}</div>
					<div><b>Status:</b> ${r.status || '-'}</div>
					<div><b>Podsumowanie:</b> ${r.summary || '-'}</div>
					<div><b>Data:</b> ${r.updatedAt || '-'}</div>
				</div>
			`;
		}
			}
		}

		// Automatyczne Ĺ‚adowanie listy warsztatĂłw po wejĹ›ciu na panel
		document.addEventListener('DOMContentLoaded', fetchWorkshops);
	// --- Warsztat Panel Tabs ---
	document.addEventListener('DOMContentLoaded', function () {
		// --- ObsĹ‚uga przycisku PowrĂłt do listy (delegacja, bo moĹĽe byÄ‡ renderowany dynamicznie) ---
		document.body.addEventListener('click', function (e) {
			if (e.target && e.target.id === 'workshop-list-back') {
				// Ukryj szczegĂłĹ‚y warsztatu
				var detail = document.getElementById('workshop-browser-detail');
				if (detail) {
					detail.hidden = true;
					detail.style.display = 'none';
				}
				// PokaĹĽ listÄ™ warsztatĂłw
				var list = document.getElementById('workshop-browser-list');
				if (list) {
					list.hidden = false;
					list.style.display = '';
				}
				// PrzewiĹ„ do nagĹ‚Ăłwka listy
				var header = document.querySelector('.panel-section__eyebrow');
				if (header) header.scrollIntoView({behavior: 'smooth', block: 'start'});
			}
		});

		// --- ObsĹ‚uga formularza ustawieĹ„ warsztatu ---
		let currentWorkshopId = null;
		const settingsForm = document.getElementById('workshop-settings-form');
		if (settingsForm) {
			settingsForm.addEventListener('submit', async function (e) {
				e.preventDefault();
				if (!currentWorkshopId) {
					alert('Brak wybranego warsztatu!');
					return;
				}
				const data = {};
				Array.from(settingsForm.elements).forEach(el => {
					if (!el.name) return;
					if (el.type === 'checkbox') {
						data[el.name] = el.checked;
					} else {
						data[el.name] = el.value;
					}
				});
				try {
					const res = await fetch(`/api/workshops/${currentWorkshopId}`, {
						method: 'PATCH',
						headers: { 'Content-Type': 'application/json' },
						credentials: 'include',
						body: JSON.stringify(data)
					});
					if (!res.ok) throw new Error('BĹ‚Ä…d zapisu danych warsztatu');
					alert('Dane warsztatu zapisane!');
				} catch (err) {
					alert(err.message || 'BĹ‚Ä…d sieci');
				}
			});
		}
	// ObsĹ‚uga przycisku "Dezaktywuj konto"
	document.addEventListener('click', async function (e) {
		if (e.target && e.target.id === 'workshop-deactivate-btn') {
			if (!currentWorkshopId) {
				alert('Brak wybranego warsztatu!');
				return;
			}
			if (!confirm('Czy na pewno chcesz dezaktywowaÄ‡ ten warsztat?')) return;
			try {
				const res = await fetch(`/api/workshops/${currentWorkshopId}`, {
					method: 'PATCH',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify({ status: 'deactivated' })
				});
				if (!res.ok) throw new Error('BĹ‚Ä…d dezaktywacji warsztatu');
				alert('Warsztat zostaĹ‚ dezaktywowany.');
				// OdĹ›wieĹĽ szczegĂłĹ‚y
				showWorkshopDetail(currentWorkshopId);
			} catch (err) {
				alert(err.message || 'BĹ‚Ä…d sieci');
			}
		}
	});

		// --- Renderuj sekcjÄ™ AktywnoĹ›Ä‡/Stan umowy na podstawie danych z localStorage ---
		function renderWorkshopSubscription(data) {
			const sub = document.getElementById('workshop-detail-subscription');
			if (!sub) return;
			data = data || JSON.parse(localStorage.getItem('workshop:settings') || '{}');
			sub.innerHTML = `
				<div class="workshop-detail__item"><strong>Status abonamentu</strong><div>${data.subscriptionAmount ? 'Aktywny' : 'Brak danych'}</div></div>
				<div class="workshop-detail__item"><strong>Kwota miesiÄ™czna</strong><div>${data.subscriptionAmount || 'Brak danych'}</div></div>
				<div class="workshop-detail__item"><strong>Start umowy</strong><div>${data.subscriptionStartDate || 'Brak danych'}</div></div>
				<div class="workshop-detail__item"><strong>Koniec okresu 12 mies.</strong><div>${data.subscriptionStartDate && data.subscriptionMonths ? getEndDate(data.subscriptionStartDate, data.subscriptionMonths) : 'Brak danych'}</div></div>
				<div class="workshop-detail__item"><strong>E-mail do faktur</strong><div>${data.billingEmail || 'Brak danych'}</div></div>
			`;
		}
		function getEndDate(start, months) {
			try {
				const d = new Date(start);
				d.setMonth(d.getMonth() + parseInt(months, 10));
				return d.toLocaleDateString('pl-PL');
			} catch { return 'Brak danych'; }
		}
		// Renderuj sekcjÄ™ przy starcie
		renderWorkshopSubscription();

		// --- Synchronizacja: po przeĹ‚Ä…czeniu na zakĹ‚adkÄ™ AktywnoĹ›Ä‡ lub Ustawienia ---
		document.body.addEventListener('click', function (e) {
			if (e.target && e.target.classList.contains('workshop-tab')) {
				setTimeout(() => {
					renderWorkshopSubscription();
					if (settingsForm) {
						const tab = e.target.getAttribute('data-tab');
						if (tab === 'settings') {
							const data = JSON.parse(localStorage.getItem('workshop:settings') || '{}');
							Array.from(settingsForm.elements).forEach(el => {
								if (!el.name) return;
								if (el.type === 'checkbox') {
									el.checked = !!data[el.name];
								} else {
									el.value = data[el.name] || '';
								}
							});
						}
					}
				}, 100);
			}
		});
		const tabButtons = document.querySelectorAll('.tabs .tab');
		const tabContents = document.querySelectorAll('.tab-content');
		if (tabButtons.length) {
			tabButtons.forEach(btn => {
				btn.addEventListener('click', function () {
					// Deactivate all tabs
					tabButtons.forEach(b => b.classList.remove('active'));
					// Hide all contents
					tabContents.forEach(c => c.style.display = 'none');
					// Activate clicked tab
					this.classList.add('active');
					const tab = this.getAttribute('data-tab');
					const content = document.getElementById('tab-' + tab);
					if (content) content.style.display = '';
				});
			});
		}
	});
	const REPORTS_KEY = 'warsztat:reports';
	const VIN_FORM_ID = 'vin-form';
	const VIN_INPUT_ID = 'vin-input';
	const VIN_RESULT_ID = 'vin-result';

	const seedReports = () => {
		if (localStorage.getItem(REPORTS_KEY)) {
			return;
		}

		const demoReports = [
			{
				vin: 'WAUZZZ8V9JA123456',
				workshop: 'Auto Serwis 24',
				status: 'Zakonczona',
				updatedAt: '2024-11-18',
				summary: 'Wymiana rozrzadu oraz oleju.'
			},
			{
				vin: 'VF3LCBHY6HS789012',
				workshop: 'MotorTech Pro',
				status: 'W trakcie',
				updatedAt: '2025-01-05',
				summary: 'Diagnostyka elektroniki silnika.'
			}
		];

		localStorage.setItem(REPORTS_KEY, JSON.stringify(demoReports));
	};

	const loadReports = () => {
		try {
			return JSON.parse(localStorage.getItem(REPORTS_KEY)) || [];
		} catch (error) {
			console.warn('Nie udalo sie odczytac raportow', error);
			return [];
		}
	};

	const validateVin = (value) => /^[A-HJ-NPR-Z0-9]{11,17}$/.test(value);

	const renderResult = (container, vin, reports) => {
		if (!reports.length) {
			container.textContent = 'Brak raportow dla podanego VIN. Wkrotce dodamy wiecej danych.';
			return;
		}

		const items = reports
			.map((report) => `
				<article class="vin-card">
					<header>
						<strong>${report.workshop}</strong>
						<span>Status: ${report.status}</span>
					</header>
					<p>${report.summary}</p>
					<footer>Aktualizacja: ${report.updatedAt}</footer>
				</article>
			`)
			.join('');

		container.innerHTML = `
			<p>Znaleziono ${reports.length} raport(y) dla VIN <strong>${vin}</strong>:</p>
			<div class="vin-card-list">${items}</div>
		`;
	};

	document.addEventListener('DOMContentLoaded', () => {
		seedReports();

		const form = document.getElementById(VIN_FORM_ID);
		const input = document.getElementById(VIN_INPUT_ID);
		const result = document.getElementById(VIN_RESULT_ID);

		if (!form || !input || !result) {
			return;
		}

		form.addEventListener('submit', (event) => {
			event.preventDefault();
			const vin = input.value.trim().toUpperCase();

			if (!validateVin(vin)) {
				result.textContent = 'Podaj poprawny numer VIN (11-17 znakow, bez liter O oraz I).';
				return;
			}

			const reports = loadReports().filter((item) => item.vin === vin);
			renderResult(result, vin, reports);
		});
	});
})();

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\middleware\auth.js
==========================================
import { verifyToken } from '../services/authService.js';

const ensureAuth = (req, res, allowedRoles = []) => {
  const header = req.headers.authorization;
  if (!header) {
    res.status(401).json({ message: 'Missing Authorization header' });
    return null;
  }

  const [, token] = header.split(' ');
  const payload = verifyToken(token);
  if (!payload) {
    res.status(401).json({ message: 'Invalid token' });
    return null;
  }

  if (allowedRoles.length && !allowedRoles.includes(payload.role)) {
    res.status(403).json({ message: 'Insufficient permissions' });
    return null;
  }

  return payload;
};

export function requireAuth(req, res, next) {
  const payload = ensureAuth(req, res, ['admin']);
  if (!payload) {
    return;
  }
  req.user = payload;
  next();
}

export function requireWorkshop(req, res, next) {
  const payload = ensureAuth(req, res, ['workshop']);
  if (!payload) {
    return;
  }
  req.user = payload;
  next();
}

export function requireAnyUser(req, res, next) {
  const payload = ensureAuth(req, res, ['admin', 'workshop']);
  if (!payload) {
    return;
  }
  req.user = payload;
  next();
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\authRoutes.js
==========================================
import { Router } from 'express';
import { z } from 'zod';
import { login } from '../services/authService.js';

const router = Router();
const loginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(6)
});

router.post('/login', async (req, res) => {
  const parsed = loginSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ message: 'Invalid credentials payload' });
  }

  const result = await login(parsed.data.email, parsed.data.password);
  if (!result) {
    return res.status(401).json({ message: 'Invalid email or password' });
  }

  res.json(result);
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\gusRoutes.js
==========================================
// server/src/routes/gusRoutes.js
import { Router } from 'express';
import { requireAuth } from '../middleware/auth.js'; 
import { fetchCompanyData } from '../services/gusService.js';

const router = Router();

// GET /api/gus/5213214567
router.get('/:nip', requireAuth, async (req, res) => {
    const { nip } = req.params;

    // Prosta walidacja
    if (!/^\d{10}$/.test(nip)) {
        return res.status(400).json({ error: 'NIP musi mieÄ‡ 10 cyfr.' });
    }

    try {
        const data = await fetchCompanyData(nip);
        
        if (!data) {
            return res.status(404).json({ error: 'Nie znaleziono firmy.' });
        }

        res.json(data);
    } catch (err) {
        res.status(500).json({ error: 'BĹ‚Ä…d serwera GUS.' });
    }
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\invoicesRoutes.js
==========================================
import { Router } from 'express';
import { requireWorkshop } from '../middleware/auth.js';
import * as invoicesService from '../services/invoicesService.js';

const router = Router();

// Pobierz wszystkie faktury warsztatu
router.get('/', requireWorkshop, (req, res) => {
  try {
    const invoices = invoicesService.getInvoicesByWorkshop(req.user.workshopId || req.user.id);
    res.json(invoices);
  } catch (err) {
    res.status(500).json({ error: 'BĹ‚Ä…d pobierania faktur' });
  }
});

// Pobierz sugerowany numer kolejnej faktury
router.get('/next-number', requireWorkshop, (req, res) => {
  try {
    const number = invoicesService.getNextInvoiceNumber(req.user.workshopId || req.user.id);
    res.json({ number });
  } catch (err) {
    res.status(500).json({ error: 'BĹ‚Ä…d generowania numeru' });
  }
});

// UtwĂłrz nowÄ… fakturÄ™
router.post('/', requireWorkshop, (req, res) => {
  try {
    const workshopId = req.user.workshopId || req.user.id;
    const invoice = invoicesService.createInvoice(req.body, workshopId);
    res.status(201).json(invoice);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'BĹ‚Ä…d tworzenia faktury' });
  }
});

// Symulacja wysyĹ‚ki e-mail
router.post('/:id/send', requireWorkshop, (req, res) => {
    // Tutaj podpiÄ…Ĺ‚byĹ› bibliotekÄ™ 'nodemailer'
    console.log(`[EMAIL] WysĹ‚ano fakturÄ™ ${req.params.id} do klienta.`);
    res.json({ success: true, message: "Faktura wysĹ‚ana na e-mail klienta." });
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\logsRoutes.js
==========================================
import { Router } from 'express';
import { requireAuth } from '../middleware/auth.js';
import { listLogs } from '../services/auditService.js';

const router = Router();

router.get('/', requireAuth, (req, res) => {
  const limit = Math.min(Number(req.query.limit) || 100, 500);
  res.json(listLogs(limit));
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\mediaRoutes.js
==========================================
import fs from 'node:fs';
import path from 'node:path';
import { Router } from 'express';
import multer from 'multer';
import { requireAuth } from '../middleware/auth.js';
import { config } from '../config.js';
import { listMedia, saveMedia, deleteMedia, getMediaById, resolveMediaPath } from '../services/mediaService.js';

const router = Router();
const storage = multer.diskStorage({
  destination: (_, __, cb) => cb(null, config.uploadDir),
  filename: (_, file, cb) => {
    const timestamp = Date.now();
    const uniqueName = `${timestamp}-${file.originalname.replace(/\s+/g, '_')}`;
    cb(null, uniqueName);
  }
});

const upload = multer({
  storage,
  limits: {
    fileSize: config.media.maxFileSizeMb * 1024 * 1024,
    files: config.media.maxFiles
  }
});

router.get('/', (req, res) => {
  res.json(listMedia());
});

router.get('/:id/download', (req, res) => {
  const media = getMediaById(req.params.id);
  if (!media) return res.status(404).json({ message: 'File not found' });
  res.download(media.file_path, media.file_name);
});

router.post('/', requireAuth, upload.single('file'), (req, res) => {
  if (!req.file) return res.status(400).json({ message: 'File is required' });
  const metadata = {
    fileName: req.file.originalname,
    filePath: req.file.path,
    mimeType: req.file.mimetype,
    size: req.file.size
  };
  const saved = saveMedia(metadata);
  res.status(201).json(saved);
});

router.delete('/:id', requireAuth, (req, res) => {
  deleteMedia(req.params.id);
  res.status(204).send();
});

router.get('/file/:fileName', (req, res) => {
  const filePath = resolveMediaPath(req.params.fileName);
  if (!fs.existsSync(filePath)) return res.status(404).json({ message: 'File not found' });
  res.sendFile(filePath);
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\newsRoutes.js
==========================================
import { Router } from 'express';
import { z } from 'zod';
import { requireAuth } from '../middleware/auth.js';
import { listNews, createNews, deleteNews } from '../services/newsService.js';

const router = Router();
const newsSchema = z.object({
  title: z.string().min(3),
  body: z.string().min(10)
});

router.get('/', (req, res) => {
  res.json(listNews());
});

router.post('/', requireAuth, (req, res) => {
  const parsed = newsSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ message: 'Invalid payload' });
  const news = createNews(parsed.data);
  res.status(201).json(news);
});

router.delete('/:id', requireAuth, (req, res) => {
  deleteNews(req.params.id);
  res.status(204).send();
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\partsRoutes.js
==========================================
import { Router } from 'express';
// Upewnij siÄ™, ĹĽe importujesz middleware tak jak w innych plikach (np. auth.js)
import { requireWorkshop } from '../middleware/auth.js'; 
import * as partsService from '../services/partsService.js';

const router = Router();

// GET /api/parts/search?q=Audi
router.get('/search', requireWorkshop, (req, res) => {
  try {
    const query = req.query.q || '';
    const results = partsService.searchPartsInWholesaler(query);
    res.json(results);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'BĹ‚Ä…d poĹ‚Ä…czenia z katalogiem czÄ™Ĺ›ci.' });
  }
});

// POST /api/parts/order
router.post('/order', requireWorkshop, (req, res) => {
  try {
    const { partId, partName, quantity } = req.body;
    // Sprawdzamy czy user istnieje, jeĹ›li nie - bierzemy ID z tokenu
    const workshopId = req.user?.workshopId || req.user?.id;

    const order = partsService.createOrder(workshopId, { partId, partName, quantity });
    
    res.status(201).json({ 
      message: 'ZamĂłwienie wysĹ‚ane do hurtowni.', 
      order 
    });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'Nie udaĹ‚o siÄ™ zĹ‚oĹĽyÄ‡ zamĂłwienia.' });
  }
});

// KLUCZOWA ZMIANA - export default naprawia TwĂłj bĹ‚Ä…d:
export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\reportsRoutes.js
==========================================
import { Router } from 'express';
import { z } from 'zod';
import { requireAuth, requireWorkshop } from '../middleware/auth.js';
import {
  createReport,
  listReports, // <--- To jest kluczowe dla Admina
  updateReportStatus,
  findReportsByVin,
  updateReport,
  getReportById,
  listReportsByWorkshop
} from '../services/reportsService.js';
import { logAction } from '../services/auditService.js';
import { getWorkshopById } from '../services/workshopsService.js';

const router = Router();
const VIN_PATTERN = /^[A-HJ-NPR-Z0-9]{17}$/i;

// Schemat walidacji
const workshopReportSchema = z.object({
  vin: z.string().regex(VIN_PATTERN, 'VIN musi mieÄ‡ 17 znakĂłw (bez I, O, Q)'),
  registrationNumber: z.string().min(2).max(15, 'Nr rejestracyjny jest za krĂłtki lub za dĹ‚ugi'),
  mileageKm: z.coerce.number().int().nonnegative('Przebieg musi byÄ‡ liczbÄ… dodatniÄ…'),
  firstRegistrationDate: z.string().optional().nullable(),
  summary: z.string().min(5, 'Opis jest za krĂłtki').max(2000),
  status: z.string().optional()
});

// ==========================================
// 1. ENDPOINTY DLA ADMINISTRATORA (I OGĂ“LNE)
// ==========================================

// GET /api/reports - Lista wszystkich raportĂłw (Naprawia bĹ‚Ä…d w panelu Admina)
router.get('/', requireAuth, (req, res) => {
  // JeĹ›li to administrator, zwrĂłÄ‡ wszystko
  if (req.user.role === 'admin' || req.user.isAdmin === true || (req.user.email && req.user.email.includes('admin'))) {
      return res.json(listReports());
  }
  
  // JeĹ›li to warsztat, zwrĂłÄ‡ tylko jego (zabezpieczenie)
  if (req.user.workshopId) {
      return res.json(listReportsByWorkshop(req.user.workshopId));
  }

  // Inni uĹĽytkownicy
  return res.status(403).json({ message: "Brak uprawnieĹ„ do przeglÄ…dania raportĂłw." });
});

// GET /api/reports/public/:vin - Publiczne sprawdzanie
router.get('/public/:vin', (req, res) => {
  const vin = req.params.vin?.toUpperCase();
  if (!VIN_PATTERN.test(vin)) return res.status(400).json({ message: 'Niepoprawny VIN' });
  res.json(findReportsByVin(vin));
});

// ==========================================
// 2. ENDPOINTY DLA WARSZTATU (/mine)
// ==========================================

// GET /api/reports/mine - Pobierz moje raporty
router.get('/mine', requireWorkshop, (req, res) => {
  if (!req.user?.workshopId) {
    return res.status(400).json({ message: 'BĹ‚Ä…d konta warsztatu.' });
  }
  const reports = listReportsByWorkshop(req.user.workshopId);
  res.json(reports);
});

// POST /api/reports/mine - Dodaj raport
router.post('/mine', requireWorkshop, (req, res) => {
  if (!req.user?.workshopId) return res.status(400).json({ message: 'BĹ‚Ä…d konta.' });

  const rawData = {
    vin: req.body.vin?.toUpperCase(),
    registrationNumber: req.body.plate?.toUpperCase(),
    mileageKm: req.body.mileage,
    firstRegistrationDate: req.body.firstRegistrationDate || null,
    summary: `[Pojazd: ${req.body.make} ${req.body.model}] ${req.body.description}`,
    status: 'pending'
  };

  const parsed = workshopReportSchema.safeParse(rawData);
  if (!parsed.success) {
    return res.status(400).json({ message: 'BĹ‚Ä…d walidacji', issues: parsed.error.issues });
  }

  const workshop = getWorkshopById(req.user.workshopId);
  if (!workshop) return res.status(404).json({ message: 'Nie znaleziono warsztatu' });

  try {
    const report = createReport(parsed.data, { workshopId: workshop.id, workshopName: workshop.name });
    logAction({
      type: 'reports:create:workshop',
      message: `Warsztat ${workshop.name} dodaĹ‚ raport ${report.vin}`,
      payload: { id: report.id }
    });
    res.status(201).json(report);
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'BĹ‚Ä…d zapisu bazy danych' });
  }
});

// PATCH /api/reports/mine/:id - Edytuj raport
router.patch('/mine/:id', requireWorkshop, (req, res) => {
    const { id } = req.params;
    const existing = getReportById(id);
    
    if (!existing || existing.workshopId !== req.user.workshopId) {
        return res.status(404).json({ message: "Raport nie istnieje." });
    }
    
    if (existing.status === 'approved' || existing.approvalStatus === 'approved') {
        return res.status(403).json({ message: "Nie moĹĽna edytowaÄ‡ zatwierdzonego raportu." });
    }

    const updateData = {};
    if (req.body.vin) updateData.vin = req.body.vin.toUpperCase();
    if (req.body.plate) updateData.registrationNumber = req.body.plate.toUpperCase();
    if (req.body.mileage) updateData.mileageKm = Number(req.body.mileage);
    if (req.body.firstRegistrationDate !== undefined) updateData.firstRegistrationDate = req.body.firstRegistrationDate;
    if (req.body.description && req.body.make && req.body.model) {
        updateData.summary = `[Pojazd: ${req.body.make} ${req.body.model}] ${req.body.description}`;
    }
    
    updateData.approvalStatus = 'pending';
    updateData.status = 'W trakcie weryfikacji (edytowano)';

    try {
        const updated = updateReport(id, updateData);
        res.json(updated);
    } catch (e) {
        res.status(500).json({message: "BĹ‚Ä…d aktualizacji"});
    }
});

// ==========================================
// 3. ENDPOINTY ADMINA (ZARZÄ„DZANIE)
// ==========================================

// PATCH /api/reports/:id - Admin edytuje raport
router.patch('/:id', requireAuth, (req, res) => {
  // SprawdĹş czy to admin
  if (req.user.role !== 'admin' && !req.user.isAdmin) {
      return res.status(403).json({ message: "Brak uprawnieĹ„" });
  }

  // Uproszczona walidacja dla admina
  const report = updateReport(req.params.id, req.body);
  
  logAction({
    type: 'reports:update',
    message: `Administrator zaktualizowaĹ‚ raport ${report.vin}`,
    payload: { id: report.id, changes: req.body }
  });
  res.json(report);
});

// PATCH /api/reports/:id/status - Zmiana statusu (ZatwierdĹş/OdrzuÄ‡)
router.patch('/:id/status', requireAuth, (req, res) => {
  if (req.user.role !== 'admin' && !req.user.isAdmin) {
      return res.status(403).json({ message: "Brak uprawnieĹ„" });
  }

  const { status } = req.body;
  const updated = updateReportStatus(req.params.id, status);
  
  if (!updated) return res.status(404).json({ message: 'Raport nie istnieje' });

  logAction({
    type: 'reports:status',
    message: `Zmieniono status raportu ${updated.vin} na ${status}`,
    payload: { id: updated.id, status }
  });
  res.json(updated);
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\settingsRoutes.js
==========================================
import { Router } from 'express';
import { z } from 'zod';
import { requireAuth, requireAnyUser } from '../middleware/auth.js';
import { getSettings, updateSettings } from '../services/settingsService.js';
import { logAction } from '../services/auditService.js';

const router = Router();

const settingsSchema = z.object({
  licenseMonths: z.number().int().min(1).max(60).optional(),
  statusOptions: z
    .array(z.string().min(2).max(50))
    .min(1)
    .max(10)
    .optional()
});

router.get('/', requireAnyUser, (req, res) => {
  res.json(getSettings());
});

router.patch('/', requireAuth, (req, res) => {
  const parsed = settingsSchema.safeParse(req.body || {});
  if (!parsed.success) {
    return res.status(400).json({ message: 'Invalid payload', issues: parsed.error.issues });
  }

  const settings = updateSettings(parsed.data);
  logAction({
    type: 'settings:update',
    message: 'Zaktualizowano ustawienia systemowe',
    actorEmail: req.user?.email,
    payload: parsed.data
  });
  res.json(settings);
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\routes\workshopsRoutes.js
==========================================
import { Router } from 'express';
import { z } from 'zod';
import { requireAuth, requireWorkshop } from '../middleware/auth.js';
import {
  listWorkshops,
  listActiveWorkshops,
  createWorkshop,
  updateWorkshop,
  getWorkshopById,
  deleteWorkshop
} from '../services/workshopsService.js';
import {
  listWorkshopBilling,
  createWorkshopBillingEntry,
  updateWorkshopBillingEntry
} from '../services/workshopBillingService.js';
import { createWorkshopAccount, upsertWorkshopAccount } from '../services/workshopUsersService.js';
import { logAction } from '../services/auditService.js';
import { db } from '../db.js';

const router = Router();

const normalizeMoney = (value) => {
  if (value === '' || value === null || typeof value === 'undefined') {
    return undefined;
  }
  const numberValue = Number(value);
  return Number.isFinite(numberValue) ? numberValue : value;
};

const requiredMoneyField = z.preprocess(normalizeMoney, z.number().nonnegative());
const optionalMoneyField = z.preprocess(normalizeMoney, z.number().nonnegative()).optional();

const billingMonthField = z
  .string()
  .regex(/^(19|20)\d{2}-(0[1-9]|1[0-2])$/, 'Podaj miesiac w formacie RRRR-MM');

const baseWorkshopSchema = z.object({
  name: z.string().min(3).max(120),
  address: z.string().min(3).max(200).optional().or(z.literal('').transform(() => undefined)),
  city: z.string().min(2).max(120).optional().or(z.literal('').transform(() => undefined)),
  phone: z.string().min(5).max(32).optional().or(z.literal('').transform(() => undefined)),
  email: z.string().email().optional().or(z.literal('').transform(() => undefined)),
  billingEmail: z.string().email().optional().or(z.literal('').transform(() => undefined)),
  subscriptionAmount: optionalMoneyField,
  subscriptionStartDate: z
    .string()
    .min(4)
    .max(32)
    .optional()
    .or(z.literal('').transform(() => undefined)),
  subscriptionInitialAmount: optionalMoneyField,
  subscriptionInitialNote: z
    .string()
    .max(120)
    .optional()
    .or(z.literal('').transform(() => undefined)),
  status: z.enum(['active', 'inactive', 'notice', 'deactivated']).default('active'),
  notes: z.string().max(1000).optional().or(z.literal('').transform(() => undefined))
});

const billingBaseSchema = z.object({
  month: billingMonthField.optional(),
  amount: optionalMoneyField,
  invoiceNumber: z.string().max(60).optional().or(z.literal('').transform(() => undefined)),
  status: z.enum(['paid', 'unpaid']).optional(),
  note: z.string().max(200).optional().or(z.literal('').transform(() => undefined))
});

const billingCreateSchema = billingBaseSchema.extend({
  month: billingMonthField,
  amount: requiredMoneyField
});

const billingUpdateSchema = billingBaseSchema;

const parseWorkshopId = (value) => {
  const numericId = Number(value);
  return Number.isFinite(numericId) ? numericId : null;
};

const createWorkshopSchema = baseWorkshopSchema.extend({
  loginEmail: z.string().email(),
  loginPassword: z.string().min(8).max(64)
});

const updateWorkshopSchema = baseWorkshopSchema.partial().extend({
  loginEmail: z.string().email().optional(),
  loginPassword: z.string().min(8).max(64).optional()
});

const safeOptional = (value) => (value === '' ? undefined : value);

const normalizePayload = (payload) => ({
  ...payload,
  address: safeOptional(payload.address),
  city: safeOptional(payload.city),
  phone: safeOptional(payload.phone),
  email: safeOptional(payload.email),
  billingEmail: safeOptional(payload.billingEmail),
  subscriptionStartDate: safeOptional(payload.subscriptionStartDate),
  subscriptionInitialNote: safeOptional(payload.subscriptionInitialNote),
  notes: safeOptional(payload.notes),
  loginEmail: safeOptional(payload.loginEmail),
  loginPassword: safeOptional(payload.loginPassword)
});

router.get('/public', (req, res) => {
  res.json(listActiveWorkshops());
});

router.get('/', requireAuth, (req, res) => {
  res.json(listWorkshops());
});

router.get('/me', requireWorkshop, (req, res) => {
  if (!req.user?.workshopId) {
    return res.status(400).json({ message: 'Brakuje przypisanego warsztatu.' });
  }
  const workshop = getWorkshopById(req.user.workshopId);
  if (!workshop) {
    return res.status(404).json({ message: 'Workshop not found' });
  }
  res.json(workshop);
});

router.get('/:id', requireAuth, (req, res) => {
  const workshopId = parseWorkshopId(req.params.id);
  if (!workshopId) {
    return res.status(400).json({ message: 'Invalid workshop id' });
  }
  const workshop = getWorkshopById(workshopId);
  if (!workshop) {
    return res.status(404).json({ message: 'Workshop not found' });
  }
  const billingHistory = listWorkshopBilling(workshopId);
  res.json({ ...workshop, billingHistory });
});

router.post('/', requireAuth, async (req, res) => {
  const parsed = createWorkshopSchema.safeParse(normalizePayload(req.body || {}));
  if (!parsed.success) {
    return res.status(400).json({ message: 'Invalid payload', issues: parsed.error.issues });
  }

  const { loginEmail, loginPassword, ...workshopData } = parsed.data;

  let workshop;
  try {
    workshop = createWorkshop(workshopData);
    createWorkshopAccount({ workshopId: workshop.id, email: loginEmail, password: loginPassword });
    logAction({
      type: 'workshops:create',
      message: `Dodano warsztat ${workshop.name}`,
      actorEmail: req.user?.email,
      payload: { id: workshop.id, loginEmail }
    });
    res.status(201).json({ ...workshop, loginEmail });
  } catch (error) {
    if (workshop?.id) {
      deleteWorkshop(workshop.id);
    }
    if (error?.code === 'SQLITE_CONSTRAINT') {
      return res.status(409).json({ message: 'Adres e-mail logowania jest juz zajety.' });
    }
    console.error('Failed to create workshop', error);
    res.status(500).json({ message: 'Nie udalo sie utworzyc warsztatu.' });
  }
});

router.patch('/:id', requireAuth, async (req, res) => {
  const parsed = updateWorkshopSchema.safeParse(normalizePayload(req.body || {}));
  if (!parsed.success) {
    return res.status(400).json({ message: 'Invalid payload', issues: parsed.error.issues });
  }

  const workshopId = parseWorkshopId(req.params.id);
  if (!workshopId) {
    return res.status(400).json({ message: 'Invalid workshop id' });
  }
  const existing = getWorkshopById(workshopId);
  if (!existing) {
    return res.status(404).json({ message: 'Workshop not found' });
  }

  const { loginEmail, loginPassword, ...updates } = parsed.data;
  try {
    const workshop = updateWorkshop(workshopId, updates);
    if (loginEmail || loginPassword) {
      upsertWorkshopAccount({ workshopId: workshop.id, email: loginEmail, password: loginPassword });
    }
    logAction({
      type: 'workshops:update',
      message: `Zmieniono dane warsztatu ${workshop.name}`,
      actorEmail: req.user?.email,
      payload: { id: workshop.id, changes: { ...updates, loginEmail: loginEmail || undefined } }
    });
    res.json({ ...workshop, loginEmail: loginEmail ?? workshop.loginEmail });
  } catch (error) {
    if (error?.code === 'SQLITE_CONSTRAINT') {
      return res.status(409).json({ message: 'Adres e-mail logowania jest juz zajety.' });
    }
    console.error('Failed to update workshop account', error);
    res.status(500).json({ message: 'Nie udalo sie zaktualizowac warsztatu.' });
  }
});

router.get('/:id/billing', requireAuth, (req, res) => {
  const workshopId = parseWorkshopId(req.params.id);
  if (!workshopId) {
    return res.status(400).json({ message: 'Invalid workshop id' });
  }
  const workshop = getWorkshopById(workshopId);
  if (!workshop) {
    return res.status(404).json({ message: 'Workshop not found' });
  }
  res.json(listWorkshopBilling(workshopId));
});

router.post('/:id/billing', requireAuth, (req, res) => {
  const workshopId = parseWorkshopId(req.params.id);
  if (!workshopId) {
    return res.status(400).json({ message: 'Invalid workshop id' });
  }
  const workshop = getWorkshopById(workshopId);
  if (!workshop) {
    return res.status(404).json({ message: 'Workshop not found' });
  }
  const parsed = billingCreateSchema.safeParse(req.body || {});
  if (!parsed.success) {
    return res.status(400).json({ message: 'Invalid payload', issues: parsed.error.issues });
  }
  try {
    const entry = createWorkshopBillingEntry(workshopId, parsed.data);
    res.status(201).json(entry);
  } catch (error) {
    console.error('Failed to create billing entry', error);
    res.status(500).json({ message: 'Nie udalo sie zapisac rozliczenia.' });
  }
});

router.patch('/:id/billing/:billingId', requireAuth, (req, res) => {
  const workshopId = parseWorkshopId(req.params.id);
  const billingId = Number(req.params.billingId);
  if (!workshopId || !Number.isFinite(billingId)) {
    return res.status(400).json({ message: 'Invalid identifier' });
  }
  const workshop = getWorkshopById(workshopId);
  if (!workshop) {
    return res.status(404).json({ message: 'Workshop not found' });
  }
  const parsed = billingUpdateSchema.safeParse(req.body || {});
  if (!parsed.success) {
    return res.status(400).json({ message: 'Invalid payload', issues: parsed.error.issues });
  }
  if (!Object.keys(parsed.data).length) {
    return res.status(400).json({ message: 'Brak danych do aktualizacji.' });
  }
  try {
    const entry = updateWorkshopBillingEntry(workshopId, billingId, parsed.data);
    if (!entry) {
      return res.status(404).json({ message: 'Billing entry not found' });
    }
    res.json(entry);
  } catch (error) {
    console.error('Failed to update billing entry', error);
    res.status(500).json({ message: 'Nie udalo sie zaktualizowac rozliczenia.' });
  }
});

export default router;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\adminService.js
==========================================
import bcrypt from 'bcrypt';
import { db } from '../db.js';
import { config } from '../config.js';

const insertAdminStmt = db.prepare('INSERT INTO admins (email, password_hash) VALUES (?, ?)');
const findAdminStmt = db.prepare('SELECT * FROM admins WHERE email = ?');

export async function ensureDefaultAdmin() {
  const existing = findAdminStmt.get(config.adminEmail);
  if (existing) return;

  const hash = await bcrypt.hash(config.adminPassword, 10);
  insertAdminStmt.run(config.adminEmail, hash);
}

export function getAdminByEmail(email) {
  return findAdminStmt.get(email);
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\auditService.js
==========================================
import { db } from '../db.js';

const insertStmt = db.prepare(`
  INSERT INTO audit_logs (type, message, actor_email, payload, created_at)
  VALUES (@type, @message, @actorEmail, @payload, @createdAt)
`);

const listStmt = db.prepare('SELECT * FROM audit_logs ORDER BY created_at DESC LIMIT ?');

export function logAction({ type, message, actorEmail = null, payload = null }) {
  const createdAt = new Date().toISOString();
  insertStmt.run({
    type,
    message,
    actorEmail,
    payload: payload ? JSON.stringify(payload) : null,
    createdAt
  });
}

export function listLogs(limit = 100) {
  return listStmt.all(limit).map((row) => ({
    id: row.id,
    type: row.type,
    message: row.message,
    actorEmail: row.actor_email,
    payload: row.payload ? safeParse(row.payload) : null,
    createdAt: row.created_at
  }));
}

function safeParse(value) {
  try {
    return JSON.parse(value);
  } catch (error) {
    return value;
  }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\authService.js
==========================================
import jwt from 'jsonwebtoken';
import bcrypt from 'bcrypt';
import { config } from '../config.js';
import { getAdminByEmail } from './adminService.js';
import { getWorkshopUserByEmail } from './workshopUsersService.js';
import { logAction } from './auditService.js';

export async function login(email, password) {
  const admin = getAdminByEmail(email);
  if (admin) {
    const match = await bcrypt.compare(password, admin.password_hash);
    if (match) {
      const token = jwt.sign(
        { id: admin.id, email: admin.email, role: 'admin' },
        config.jwtSecret,
        { expiresIn: '12h' }
      );
      logAction({
        type: 'auth:login:admin',
        message: 'Administrator zalogowal sie do panelu',
        actorEmail: admin.email,
        payload: { adminId: admin.id }
      });
      return { token, email: admin.email, role: 'admin' };
    }
  }

  const workshopUser = getWorkshopUserByEmail(email);
  if (workshopUser) {
    const match = await bcrypt.compare(password, workshopUser.passwordHash);
    if (match) {
      const token = jwt.sign(
        { id: workshopUser.id, email: workshopUser.email, role: 'workshop', workshopId: workshopUser.workshopId },
        config.jwtSecret,
        { expiresIn: '12h' }
      );
      logAction({
        type: 'auth:login:workshop',
        message: 'Warsztat zalogowal sie do panelu',
        actorEmail: workshopUser.email,
        payload: { workshopId: workshopUser.workshopId }
      });
      return { token, email: workshopUser.email, role: 'workshop', workshopId: workshopUser.workshopId };
    }
  }

  return null;
}

export function verifyToken(token) {
  try {
    return jwt.verify(token, config.jwtSecret);
  } catch {
    return null;
  }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\gusService.js
==========================================
import fetch from 'node-fetch';

// ADRES TESTOWY
const GUS_URL = 'https://wyszukiwarkaregontest.stat.gov.pl/wsBIR/UslugaBIRzewnPubl.svc';
const API_KEY = 'abcde12345abcde12345'; 

// Funkcja wyciÄ…gajÄ…ca wartoĹ›Ä‡ z XML (ignoruje namespace i wielkoĹ›Ä‡ liter)
const extract = (tag, xml) => {
    // 1. PrĂłba znalezienia tagu bez namespace np. <Nazwa>...</Nazwa>
    let regex = new RegExp(`<${tag}[^>]*>(.*?)<\/${tag}>`, 'i');
    let match = xml.match(regex);
    if (match && match[1]) return match[1];

    // 2. PrĂłba znalezienia z namespace np. <d:Nazwa>...</d:Nazwa>
    regex = new RegExp(`<[a-z0-9]+:${tag}[^>]*>(.*?)<\/[a-z0-9]+:${tag}>`, 'i');
    match = xml.match(regex);
    if (match && match[1]) return match[1];

    return '';
};

export async function fetchCompanyData(nip) {
    // --- FALLBACK DLA ĹšRODOWISKA TESTOWEGO ---
    // JeĹ›li GUS API szwankuje (co na testowym jest normÄ…), zwracamy dane na sztywno dla tego konkretnego NIPu
    // Pozwala to testowaÄ‡ resztÄ™ aplikacji bez blokady.
    if (nip === '8992689516') {
        console.log("[GUS INFO] UĹĽywam danych testowych dla NIP 8992689516");
        return {
            name: "MÄ„DRA GĹOWA SPĂ“ĹKA Z OGRANICZONÄ„ ODPOWIEDZIALNOĹšCIÄ„",
            address: "ul. Miodowa 13/5",
            city: "Warszawa",
            zip: "00-246"
        };
    }
    if (nip === '1234567890') {
        return {
            name: "WARSZTAT TESTOWY JAN KOWALSKI",
            address: "ul. Sezamkowa 10",
            city: "KrakĂłw",
            zip: "30-001"
        };
    }
    // -----------------------------------------

    try {
        console.log(`[GUS] Szukam NIP: ${nip}`);

        // 1. LOGOWANIE
        const loginRes = await fetch(GUS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/soap+xml; charset=utf-8' },
            body: `
            <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" xmlns:ns="http://CIS/BIR/PUBL/2014/07">
                <soap:Header xmlns:wsa="http://www.w3.org/2005/08/addressing">
                    <wsa:Action>http://CIS/BIR/PUBL/2014/07/IUslugaBIRzewnPubl/Zaloguj</wsa:Action>
                    <wsa:To>${GUS_URL}</wsa:To>
                </soap:Header>
                <soap:Body><ns:Zaloguj><ns:pKluczUzytkownika>${API_KEY}</ns:pKluczUzytkownika></ns:Zaloguj></soap:Body>
            </soap:Envelope>`
        });

        const loginXml = await loginRes.text();
        const sidMatch = loginXml.match(/<([a-zA-Z0-9:]*)ZalogujResult>(.*?)<\/[a-zA-Z0-9:]*ZalogujResult>/);
        const sid = sidMatch ? sidMatch[2] : null;

        if (!sid) throw new Error('Brak sesji SID');

        // 2. SZUKANIE
        const searchRes = await fetch(GUS_URL, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/soap+xml; charset=utf-8',
                'sid': sid 
            },
            body: `
            <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" xmlns:ns="http://CIS/BIR/PUBL/2014/07">
                <soap:Header xmlns:wsa="http://www.w3.org/2005/08/addressing">
                    <wsa:Action>http://CIS/BIR/PUBL/2014/07/IUslugaBIRzewnPubl/DaneSzukajPodmioty</wsa:Action>
                    <wsa:To>${GUS_URL}</wsa:To>
                </soap:Header>
                <soap:Body>
                    <ns:DaneSzukajPodmioty>
                        <ns:pParametryWyszukiwania><ns:Nip>${nip}</ns:Nip></ns:pParametryWyszukiwania>
                    </ns:DaneSzukajPodmioty>
                </soap:Body>
            </soap:Envelope>`
        });

        let searchXml = await searchRes.text();

        // Dekodowanie encji HTML (to kluczowe w GUS)
        searchXml = searchXml
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&')
            .replace(/&#xD;/g, '')
            .replace(/&#xA;/g, '');

        if (searchXml.includes('<ErrorCode>')) return null;

        // 3. WYCIÄ„GANIE DANYCH
        const name = extract('Nazwa', searchXml);
        
        if (!name) {
            console.log("[GUS] Nie znaleziono danych w XML.");
            return null;
        }

        const street = extract('Ulica', searchXml);
        const propertyNr = extract('NrNieruchomosci', searchXml);
        const apartmentNr = extract('NrLokalu', searchXml);
        const city = extract('Miejscowosc', searchXml);
        const zip = extract('KodPocztowy', searchXml);

        let fullAddress = street ? `${street} ${propertyNr}` : `${city} ${propertyNr}`;
        if (apartmentNr) fullAddress += `/${apartmentNr}`;

        return {
            name: name,
            address: fullAddress,
            city: city,
            zip: zip
        };

    } catch (err) {
        console.error("[GUS Error]", err.message);
        throw err;
    }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\invoicesService.js
==========================================
import { db } from '../db.js';

// 1. Automatyczna migracja (Tworzenie tabeli jeĹ›li nie istnieje)
try {
  db.exec(`
    CREATE TABLE IF NOT EXISTS invoices (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      workshop_id INTEGER NOT NULL,
      number TEXT NOT NULL,
      client_name TEXT NOT NULL,
      client_nip TEXT,
      client_address TEXT,
      date_issued TEXT NOT NULL,
      date_due TEXT NOT NULL,
      items JSON NOT NULL,
      total_net REAL NOT NULL,
      total_vat REAL NOT NULL,
      total_gross REAL NOT NULL,
      status TEXT DEFAULT 'wystawiona',
      created_at TEXT DEFAULT CURRENT_TIMESTAMP
    )
  `);
} catch (err) {
  console.error("BĹ‚Ä…d inicjalizacji tabeli invoices:", err);
}

// 2. Logika biznesowa
export function createInvoice(data, workshopId) {
  const stmt = db.prepare(`
    INSERT INTO invoices (
      workshop_id, number, client_name, client_nip, client_address,
      date_issued, date_due, items, total_net, total_vat, total_gross, status
    ) VALUES (
      @workshopId, @number, @clientName, @clientNip, @clientAddress,
      @dateIssued, @dateDue, @items, @totalNet, @totalVat, @totalGross, 'wystawiona'
    )
  `);

  const info = stmt.run({
    workshopId,
    number: data.number,
    clientName: data.clientName,
    clientNip: data.clientNip || null,
    clientAddress: data.clientAddress,
    dateIssued: data.dateIssued,
    dateDue: data.dateDue,
    items: JSON.stringify(data.items), // Tablica przedmiotĂłw jako JSON
    totalNet: data.totalNet,
    totalVat: data.totalVat,
    totalGross: data.totalGross
  });

  return { id: info.lastInsertRowid, ...data, status: 'wystawiona' };
}

export function getInvoicesByWorkshop(workshopId) {
  const stmt = db.prepare(`SELECT * FROM invoices WHERE workshop_id = ? ORDER BY created_at DESC`);
  const rows = stmt.all(workshopId);
  
  // Parsujemy items z JSON z powrotem na obiekt
  return rows.map(row => ({
    ...row,
    items: JSON.parse(row.items)
  }));
}

export function getNextInvoiceNumber(workshopId) {
  // Prosta logika numeracji: FV/ROK/MIESIÄ„C/NR
  const countStmt = db.prepare(`SELECT COUNT(*) as count FROM invoices WHERE workshop_id = ?`);
  const count = countStmt.get(workshopId).count;
  const date = new Date();
  return `FV/${date.getFullYear()}/${date.getMonth() + 1}/${count + 1}`;
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\mediaService.js
==========================================
import fs from 'node:fs';
import path from 'node:path';
import { db } from '../db.js';
import { config } from '../config.js';

if (!fs.existsSync(config.uploadDir)) {
  fs.mkdirSync(config.uploadDir, { recursive: true });
}

const insertStmt = db.prepare('INSERT INTO media (file_name, file_path, mime_type, size) VALUES (?, ?, ?, ?)');
const listStmt = db.prepare('SELECT * FROM media ORDER BY uploaded_at DESC');
const deleteStmt = db.prepare('DELETE FROM media WHERE id = ?');
const findStmt = db.prepare('SELECT * FROM media WHERE id = ?');

export function saveMedia(meta) {
  const result = insertStmt.run(meta.fileName, meta.filePath, meta.mimeType, meta.size);
  return { id: result.lastInsertRowid, ...meta };
}

export function listMedia() {
  return listStmt.all();
}

export function getMediaById(id) {
  return findStmt.get(id);
}

export function deleteMedia(id) {
  const media = getMediaById(id);
  if (media && fs.existsSync(media.file_path)) {
    fs.unlinkSync(media.file_path);
  }
  deleteStmt.run(id);
}

export function resolveMediaPath(fileName) {
  return path.join(config.uploadDir, fileName);
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\newsService.js
==========================================
import { db } from '../db.js';

const listStmt = db.prepare('SELECT * FROM news ORDER BY published_at DESC');
const createStmt = db.prepare('INSERT INTO news (title, body) VALUES (?, ?)');
const deleteStmt = db.prepare('DELETE FROM news WHERE id = ?');

export function listNews() {
  return listStmt.all();
}

export function createNews({ title, body }) {
  const result = createStmt.run(title, body);
  return { id: result.lastInsertRowid, title, body };
}

export function deleteNews(id) {
  deleteStmt.run(id);
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\partsService.js
==========================================
import { db } from '../db.js';

export function searchPartsInWholesaler(query) {
  // Symulacja danych
  const mockDb = [
    { id: 'HAM-001', name: 'Klocki hamulcowe przĂłd (TRW)', index: 'GDB1307', price: 145.00, stock: 'DostÄ™pne' },
    { id: 'FIL-023', name: 'Filtr oleju (Mann)', index: 'W712/95', price: 35.50, stock: 'DuĹĽa iloĹ›Ä‡' },
    { id: 'AMO-999', name: 'Amortyzator tyĹ‚ (Sachs)', index: '313 000', price: 210.00, stock: '24h' },
    { id: 'WIC-500', name: 'Wycieraczki Bosch Aerotwin', index: '3 397 007', price: 95.00, stock: 'DostÄ™pne' },
    { id: 'ROZ-123', name: 'Zestaw paska rozrzÄ…du', index: 'CT1139K2', price: 450.00, stock: 'Na zamĂłwienie' }
  ];

  if (!query) return [];
  
  const lowerQuery = query.toLowerCase();
  return mockDb.filter(part => 
    part.name.toLowerCase().includes(lowerQuery) || 
    part.index.toLowerCase().includes(lowerQuery)
  );
}

export function createOrder(workshopId, partData) {
  const now = new Date().toISOString();
  
  const order = {
    id: `ORD-${Date.now()}`,
    workshopId,
    ...partData,
    status: 'PrzyjÄ™to do realizacji',
    createdAt: now
  };

  console.log(`[HURTOWNIA] Nowe zamĂłwienie od warsztatu ${workshopId}:`, partData);
  return order;
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\reportsService.js
==========================================
import { db } from '../db.js';

const FIELD_COLUMN_MAP = {
  vin: 'vin',
  registrationNumber: 'registration_number',
  workshopName: 'workshop_name',
  workshopId: 'workshop_id',
  mileageKm: 'mileage_km',
  firstRegistrationDate: 'first_registration_date',
  status: 'status',
  approvalStatus: 'approval_status',
  summary: 'summary',
  moderationNote: 'moderation_note',
  moderatedBy: 'moderated_by',
  moderatedAt: 'moderated_at'
};

const insertStmt = db.prepare(`
  INSERT INTO reports (
    vin,
    registration_number,
    workshop_name,
    workshop_id,
    mileage_km,
    first_registration_date,
    status,
    approval_status,
    summary,
    created_at,
    updated_at
  ) VALUES (@vin, @registrationNumber, @workshopName, @workshopId, @mileageKm, @firstRegistrationDate, @status, @approvalStatus, @summary, @createdAt, @updatedAt)
`);

const selectAllStmt = db.prepare('SELECT * FROM reports ORDER BY updated_at DESC');
const selectByIdStmt = db.prepare('SELECT * FROM reports WHERE id = ?');
const selectByVinStmt = db.prepare(
  "SELECT * FROM reports WHERE vin = ? AND approval_status = 'approved' ORDER BY updated_at DESC"
);
const selectByWorkshopStmt = db.prepare('SELECT * FROM reports WHERE workshop_id = ? ORDER BY updated_at DESC');

const buildUpdateStatement = (payloadKeys) => {
  const assignments = payloadKeys.map((key) => `${FIELD_COLUMN_MAP[key]} = @${key}`);
  return db.prepare(`UPDATE reports SET ${assignments.join(', ')}, updated_at = @updatedAt WHERE id = @id`);
};

const mapReport = (row) =>
  row
    ? {
        id: row.id,
        vin: row.vin,
        registrationNumber: row.registration_number,
        workshopName: row.workshop_name,
        workshopId: row.workshop_id,
        mileageKm: row.mileage_km,
        firstRegistrationDate: row.first_registration_date,
        status: row.status,
        approvalStatus: row.approval_status,
        summary: row.summary,
        moderationNote: row.moderation_note,
        moderatedBy: row.moderated_by,
        moderatedAt: row.moderated_at,
        createdAt: row.created_at,
        updatedAt: row.updated_at,
        media: []
      }
    : null;

export function createReport(payload, options = {}) {
  const now = new Date().toISOString();
  const defaults = {
    status: 'W trakcie',
    approvalStatus: 'pending',
    workshopName: options.workshopName || payload.workshopName || 'Nieznany warsztat'
  };

  const params = {
    vin: payload.vin?.toUpperCase(),
    registrationNumber: payload.registrationNumber?.toUpperCase() || null,
    workshopName: defaults.workshopName,
    workshopId: options.workshopId ?? payload.workshopId ?? null,
    mileageKm: Number.isFinite(payload.mileageKm) ? Number(payload.mileageKm) : null,
    firstRegistrationDate: payload.firstRegistrationDate || null,
    status: payload.status || defaults.status,
    approvalStatus: payload.approvalStatus || defaults.approvalStatus,
    summary: payload.summary || null,
    createdAt: now,
    updatedAt: now
  };

  const result = insertStmt.run(params);
  return mapReport(selectByIdStmt.get(result.lastInsertRowid));
}

export function listReports() {
  return selectAllStmt.all().map(mapReport);
}

export function listReportsByWorkshop(workshopId) {
  if (!workshopId) {
    return [];
  }
  return selectByWorkshopStmt.all(workshopId).map(mapReport);
}

export function getReportById(id) {
  return mapReport(selectByIdStmt.get(id));
}


export function updateReport(id, updates) {
  const entries = Object.entries(updates).filter(([key]) => FIELD_COLUMN_MAP[key]);
  if (!entries.length) {
    return getReportById(id);
  }

  const params = entries.reduce(
    (acc, [key, value]) => ({
      ...acc,
      [key]: key === 'mileageKm' && value !== null ? Number(value) : value
    }),
    { id, updatedAt: new Date().toISOString() }
  );

  if (typeof params.vin === 'string') {
    params.vin = params.vin.toUpperCase();
  }
  if (typeof params.registrationNumber === 'string') {
    params.registrationNumber = params.registrationNumber.toUpperCase();
  }

  const stmt = buildUpdateStatement(entries.map(([key]) => key));
  stmt.run(params);
  return getReportById(id);
}

export function updateReportStatus(id, status) {
  return updateReport(id, { status });
}

export function findReportsByVin(vin) {
  return selectByVinStmt.all(vin).map(mapReport);
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\settingsService.js
==========================================
import { db } from '../db.js';

const upsertStmt = db.prepare(`
  INSERT INTO settings (key, value, updated_at)
  VALUES (@key, @value, @updatedAt)
  ON CONFLICT(key) DO UPDATE SET value = excluded.value, updated_at = excluded.updated_at
`);

const selectAllStmt = db.prepare('SELECT key, value FROM settings');

const DEFAULT_SETTINGS = {
  licenseMonths: 12,
  statusOptions: ['Przyjeta', 'W trakcie', 'Zakonczona']
};

function mapSettings(rows) {
  const result = { ...DEFAULT_SETTINGS };
  for (const row of rows) {
    if (!row) continue;
    if (row.key === 'licenseMonths') {
      result.licenseMonths = Number(row.value) || DEFAULT_SETTINGS.licenseMonths;
    } else if (row.key === 'statusOptions') {
      try {
        const parsed = JSON.parse(row.value);
        if (Array.isArray(parsed) && parsed.every((item) => typeof item === 'string')) {
          result.statusOptions = parsed;
        }
      } catch (error) {
        // ignore
      }
    }
  }
  return result;
}

export function getSettings() {
  const rows = selectAllStmt.all();
  return mapSettings(rows);
}

export function updateSettings(partial) {
  const next = { ...getSettings(), ...partial };
  const updatedAt = new Date().toISOString();
  const entries = [
    { key: 'licenseMonths', value: String(next.licenseMonths) },
    { key: 'statusOptions', value: JSON.stringify(next.statusOptions) }
  ];
  const txn = db.transaction((records) => {
    records.forEach((record) => {
      upsertStmt.run({ ...record, updatedAt });
    });
  });
  txn(entries);
  return next;
}

export function ensureDefaultSettings() {
  const current = selectAllStmt.all();
  if (current.length === 0) {
    updateSettings(DEFAULT_SETTINGS);
  }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\workshopBillingService.js
==========================================
import { db } from '../db.js';

const selectByWorkshopStmt = db.prepare(`
  SELECT *
  FROM workshop_billing
  WHERE workshop_id = ?
  ORDER BY month DESC, updated_at DESC
`);

const selectByIdStmt = db.prepare(`
  SELECT *
  FROM workshop_billing
  WHERE id = ? AND workshop_id = ?
`);

const insertStmt = db.prepare(`
  INSERT INTO workshop_billing (workshop_id, month, amount, invoice_number, status, note, created_at, updated_at)
  VALUES (@workshopId, @month, @amount, @invoiceNumber, @status, @note, @createdAt, @updatedAt)
`);

const updateStmt = db.prepare(`
  UPDATE workshop_billing
  SET month = @month,
      amount = @amount,
      invoice_number = @invoiceNumber,
      status = @status,
      note = @note,
      updated_at = @updatedAt
  WHERE id = @id AND workshop_id = @workshopId
`);

const mapBillingEntry = (row) =>
  row
    ? {
        id: row.id,
        workshopId: row.workshop_id,
        month: row.month,
        amount: typeof row.amount === 'number' ? Number(row.amount) : null,
        invoiceNumber: row.invoice_number || null,
        status: row.status || 'unpaid',
        note: row.note || null,
        createdAt: row.created_at,
        updatedAt: row.updated_at
      }
    : null;

export function listWorkshopBilling(workshopId) {
  return selectByWorkshopStmt.all(workshopId).map(mapBillingEntry);
}

export function getWorkshopBillingEntry(workshopId, billingId) {
  return mapBillingEntry(selectByIdStmt.get(billingId, workshopId));
}

export function createWorkshopBillingEntry(workshopId, payload) {
  const now = new Date().toISOString();
  const params = {
    workshopId,
    month: payload.month,
    amount: typeof payload.amount === 'number' ? payload.amount : null,
    invoiceNumber: payload.invoiceNumber || null,
    status: payload.status || 'unpaid',
    note: payload.note || null,
    createdAt: now,
    updatedAt: now
  };
  const result = insertStmt.run(params);
  return getWorkshopBillingEntry(workshopId, result.lastInsertRowid);
}

export function updateWorkshopBillingEntry(workshopId, billingId, payload) {
  const existing = getWorkshopBillingEntry(workshopId, billingId);
  if (!existing) {
    return null;
  }
  const params = {
    id: billingId,
    workshopId,
    month: payload.month ?? existing.month,
    amount: typeof payload.amount === 'number' ? payload.amount : existing.amount,
    invoiceNumber: typeof payload.invoiceNumber === 'undefined' ? existing.invoiceNumber : payload.invoiceNumber,
    status: payload.status || existing.status,
    note: typeof payload.note === 'undefined' ? existing.note : payload.note,
    updatedAt: new Date().toISOString()
  };
  updateStmt.run(params);
  return getWorkshopBillingEntry(workshopId, billingId);
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\workshopsService.js
==========================================
import { db } from '../db.js';
import { createWorkshopAccount, getWorkshopUserByWorkshopId } from './workshopUsersService.js';

const FIELD_COLUMN_MAP = {
  name: 'name',
  address: 'address',
  city: 'city',
  phone: 'phone',
  email: 'email',
  status: 'status',
  notes: 'notes',
  subscriptionAmount: 'subscription_amount',
  subscriptionStartDate: 'subscription_start_date',
  subscriptionInitialAmount: 'subscription_initial_amount',
  subscriptionInitialNote: 'subscription_initial_note',
  billingEmail: 'billing_email'
};

const insertStmt = db.prepare(`
  INSERT INTO workshops (
    name,
    address,
    city,
    phone,
    email,
    status,
    notes,
    subscription_amount,
    subscription_start_date,
    subscription_initial_amount,
    subscription_initial_note,
    billing_email,
    created_at,
    updated_at
  )
  VALUES (
    @name,
    @address,
    @city,
    @phone,
    @email,
    @status,
    @notes,
    @subscriptionAmount,
    @subscriptionStartDate,
    @subscriptionInitialAmount,
    @subscriptionInitialNote,
    @billingEmail,
    @createdAt,
    @updatedAt
  )
`);

const baseSelect = `
  SELECT w.*, wu.email AS login_email
  FROM workshops w
  LEFT JOIN workshop_users wu ON wu.workshop_id = w.id
`;

const selectAllStmt = db.prepare(`${baseSelect} ORDER BY w.name ASC`);
const selectActiveStmt = db.prepare(`${baseSelect} WHERE w.status = 'active' ORDER BY w.name ASC`);
const selectByIdStmt = db.prepare(`${baseSelect} WHERE w.id = ?`);
const countStmt = db.prepare('SELECT COUNT(*) as count FROM workshops');
const deleteStmt = db.prepare('DELETE FROM workshops WHERE id = ?');

const buildUpdateStatement = (keys) => {
  const assignments = keys.map((key) => `${FIELD_COLUMN_MAP[key]} = @${key}`);
  return db.prepare(`UPDATE workshops SET ${assignments.join(', ')}, updated_at = @updatedAt WHERE id = @id`);
};

const mapWorkshop = (row) =>
  row
    ? {
        id: row.id,
        name: row.name,
        address: row.address,
        city: row.city,
        phone: row.phone,
        email: row.email,
        loginEmail: row.login_email || null,
        status: row.status,
        notes: row.notes,
        subscriptionAmount:
          typeof row.subscription_amount === 'number' ? Number(row.subscription_amount) : null,
        subscriptionStartDate: row.subscription_start_date || null,
        subscriptionInitialAmount:
          typeof row.subscription_initial_amount === 'number' ? Number(row.subscription_initial_amount) : null,
        subscriptionInitialNote: row.subscription_initial_note || null,
        billingEmail: row.billing_email || null,
        createdAt: row.created_at,
        updatedAt: row.updated_at
      }
    : null;

export function listWorkshops() {
  return selectAllStmt.all().map(mapWorkshop);
}

export function listActiveWorkshops() {
  return selectActiveStmt.all().map(mapWorkshop);
}

export function getWorkshopById(id) {
  return mapWorkshop(selectByIdStmt.get(id));
}

export function createWorkshop(payload) {
  const now = new Date().toISOString();
  const params = {
    name: payload.name.trim(),
    address: payload.address?.trim() || null,
    city: payload.city?.trim() || null,
    phone: payload.phone?.trim() || null,
    email: payload.email?.trim() || null,
    status: payload.status || 'active',
    notes: payload.notes?.trim() || null,
    subscriptionAmount: typeof payload.subscriptionAmount === 'number' ? payload.subscriptionAmount : null,
    subscriptionStartDate: payload.subscriptionStartDate || null,
    subscriptionInitialAmount:
      typeof payload.subscriptionInitialAmount === 'number' ? payload.subscriptionInitialAmount : null,
    subscriptionInitialNote: payload.subscriptionInitialNote || null,
    billingEmail: payload.billingEmail || null,
    createdAt: now,
    updatedAt: now
  };

  const result = insertStmt.run(params);
  return getWorkshopById(result.lastInsertRowid);
}

export function updateWorkshop(id, updates) {
  const entries = Object.entries(updates).filter(([key, value]) => FIELD_COLUMN_MAP[key] && typeof value !== 'undefined');
  if (!entries.length) {
    return getWorkshopById(id);
  }

  const params = entries.reduce(
    (acc, [key, value]) => ({
      ...acc,
      [key]: typeof value === 'string' ? value.trim() : value
    }),
    { id, updatedAt: new Date().toISOString() }
  );

  const stmt = buildUpdateStatement(entries.map(([key]) => key));
  stmt.run(params);
  return getWorkshopById(id);
}

export function ensureDefaultWorkshops() {
  const { count } = countStmt.get();
  if (count > 0) return;

  const now = new Date().toISOString();
  const defaults = [
    {
      name: 'Warsztat+ Centralny',
      address: 'ul. MechanikĂłw 12',
      city: 'KrakĂłw',
      phone: '+48 123 456 789',
      email: 'biuro@warsztatplus.pl',
      status: 'active',
      notes: 'Autoryzowany punkt kontroli jakoĹ›ci Warsztat+.'
    },
    {
      name: 'Auto Serwis PĂłĹ‚noc',
      address: 'ul. PrzemysĹ‚owa 8',
      city: 'GdaĹ„sk',
      phone: '+48 58 000 11 22',
      email: 'kontakt@autoserwispolnoc.pl',
      status: 'active',
      notes: 'Specjalizacja: silniki i diagnostyka komputerowa.'
    },
    {
      name: 'Garage 24/7',
      address: 'al. SolidarnoĹ›ci 21',
      city: 'Warszawa',
      phone: '+48 22 111 22 33',
      email: 'support@garage247.pl',
      status: 'inactive',
      notes: 'W trakcie modernizacji infrastruktury.'
    }
  ];

  const insertMany = db.prepare(`
    INSERT INTO workshops (name, address, city, phone, email, status, notes, created_at, updated_at)
    VALUES (@name, @address, @city, @phone, @email, @status, @notes, @createdAt, @updatedAt)
  `);

  const insertTxn = db.transaction((rows) => {
    for (const row of rows) {
      insertMany.run({ ...row, createdAt: now, updatedAt: now });
    }
  });

  insertTxn(defaults);

  const seeded = listWorkshops();
  seeded.forEach((workshop, index) => {
    const hasAccount = getWorkshopUserByWorkshopId(workshop.id);
    if (!hasAccount) {
      const email = workshop.email || `warsztat${index + 1}@warsztatplus.local`;
      createWorkshopAccount({ workshopId: workshop.id, email, password: 'warsztat123' });
    }
  });
}

export function deleteWorkshop(id) {
  if (!id) {
    return;
  }
  deleteStmt.run(id);
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\services\workshopUsersService.js
==========================================
import bcrypt from 'bcrypt';
import { db } from '../db.js';

const insertStmt = db.prepare(`
  INSERT INTO workshop_users (workshop_id, email, password_hash, role, created_at, updated_at)
  VALUES (@workshopId, @email, @passwordHash, 'workshop', @timestamp, @timestamp)
`);

const selectByEmailStmt = db.prepare(`
  SELECT id, workshop_id, email, password_hash, role, created_at, updated_at
  FROM workshop_users
  WHERE lower(email) = lower(?)
`);

const selectByWorkshopStmt = db.prepare(`
  SELECT id, workshop_id, email, password_hash, role, created_at, updated_at
  FROM workshop_users
  WHERE workshop_id = ?
`);

const updateEmailStmt = (fields) =>
  db.prepare(
    `UPDATE workshop_users SET ${fields.join(', ')}, updated_at = @timestamp WHERE workshop_id = @workshopId`
  );

const deleteByWorkshopStmt = db.prepare('DELETE FROM workshop_users WHERE workshop_id = ?');

const mapUser = (row) =>
  row
    ? {
        id: row.id,
        workshopId: row.workshop_id,
        email: row.email,
        passwordHash: row.password_hash,
        role: row.role || 'workshop',
        createdAt: row.created_at,
        updatedAt: row.updated_at
      }
    : null;

const hashPassword = (password) => bcrypt.hashSync(password, 10);

export function getWorkshopUserByEmail(email) {
  if (!email) {
    return null;
  }
  return mapUser(selectByEmailStmt.get(email));
}

export function getWorkshopUserByWorkshopId(workshopId) {
  if (!workshopId) {
    return null;
  }
  return mapUser(selectByWorkshopStmt.get(workshopId));
}

export function createWorkshopAccount({ workshopId, email, password }) {
  if (!workshopId || !email || !password) {
    throw new Error('Missing workshop account data');
  }
  const timestamp = new Date().toISOString();
  insertStmt.run({
    workshopId,
    email: email.toLowerCase(),
    passwordHash: hashPassword(password),
    timestamp
  });
  return getWorkshopUserByWorkshopId(workshopId);
}

export function upsertWorkshopAccount({ workshopId, email, password }) {
  const existing = getWorkshopUserByWorkshopId(workshopId);
  if (!existing) {
    if (!email || !password) {
      return null;
    }
    return createWorkshopAccount({ workshopId, email, password });
  }

  const fields = [];
  const params = { workshopId, timestamp: new Date().toISOString() };
  if (email) {
    fields.push('email = @email');
    params.email = email.toLowerCase();
  }
  if (password) {
    fields.push('password_hash = @passwordHash');
    params.passwordHash = hashPassword(password);
  }
  if (!fields.length) {
    return existing;
  }

  const stmt = updateEmailStmt(fields);
  stmt.run(params);
  return getWorkshopUserByWorkshopId(workshopId);
}

export function deleteWorkshopAccount(workshopId) {
  if (!workshopId) return;
  deleteByWorkshopStmt.run(workshopId);
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\app.js
==========================================
// server/src/app.js
import express from 'express';
import cors from 'cors';
import morgan from 'morgan';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { config } from './config.js';
import { ensureDefaultAdmin } from './services/adminService.js';
import { ensureDefaultWorkshops } from './services/workshopsService.js';
import { ensureDefaultSettings } from './services/settingsService.js';

// Importy tras
import authRoutes from './routes/authRoutes.js';
import newsRoutes from './routes/newsRoutes.js';
import reportsRoutes from './routes/reportsRoutes.js';
import mediaRoutes from './routes/mediaRoutes.js';
import workshopsRoutes from './routes/workshopsRoutes.js';
import settingsRoutes from './routes/settingsRoutes.js';
import logsRoutes from './routes/logsRoutes.js';
import partsRoutes from './routes/partsRoutes.js';
import invoicesRoutes from './routes/invoicesRoutes.js';
import gusRoutes from './routes/gusRoutes.js'; // <--- 1. IMPORT GUS

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(cors());
app.use(express.json());
app.use(morgan('dev'));
app.use('/uploads', express.static(config.uploadDir));

app.get('/health', (req, res) => res.json({ status: 'ok' }));

// --- REJESTRACJA API ---
app.use('/api/auth', authRoutes);
app.use('/api/news', newsRoutes);
app.use('/api/reports', reportsRoutes);
app.use('/api/media', mediaRoutes);
app.use('/api/workshops', workshopsRoutes);
app.use('/api/settings', settingsRoutes);
app.use('/api/logs', logsRoutes);
app.use('/api/parts', partsRoutes);
app.use('/api/invoices', invoicesRoutes);
app.use('/api/gus', gusRoutes); // <--- 2. REJESTRACJA ĹšCIEĹ»KI GUS

// --- LOGIKA STARTOWA ---
ensureDefaultAdmin().catch((err) => {
  console.error('Failed to ensure default admin', err);
});

try {
  ensureDefaultWorkshops();
} catch (err) {
  console.error('Failed to seed workshops', err);
}

try {
  ensureDefaultSettings();
} catch (err) {
  console.error('Failed to seed settings', err);
}

// Serve frontend if running in same host
app.use(express.static(path.resolve(__dirname, '..', '..')));

// --- OBSĹUGA BĹÄDĂ“W ---
app.use((err, req, res, next) => {
  if (err?.type === 'entity.parse.failed') {
    return res.status(err.statusCode || 400).json({ message: 'Invalid JSON payload' });
  }

  const status = err?.statusCode || err?.status || 500;
  if (status >= 500) {
    console.error(err);
    return res.status(500).json({ message: 'Unexpected server error' });
  }

  res.status(status).json({ message: err.message || 'Request failed' });
});

export default app;

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\config.js
==========================================
import dotenv from 'dotenv';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.resolve(__dirname, '..', '.env') });

dotenv.config();

export const config = {
  port: Number(process.env.PORT) || 4000,
  jwtSecret: process.env.JWT_SECRET || 'super-secret-key',
  dbPath: process.env.DB_PATH || path.resolve(__dirname, '..', 'data', 'warsztat.db'),
  uploadDir: process.env.UPLOAD_DIR || path.resolve(__dirname, '..', 'uploads'),
  adminEmail: process.env.ADMIN_EMAIL || 'admin@warsztat.local',
  adminPassword: process.env.ADMIN_PASSWORD || 'admin123',
  media: {
    maxFiles: Number(process.env.MEDIA_MAX_FILES) || 5,
    maxFileSizeMb: Number(process.env.MEDIA_MAX_SIZE_MB) || 5
  }
};

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\db.js
==========================================
import fs from 'node:fs';
import path from 'node:path';
import Database from 'better-sqlite3';
import { config } from './config.js';

const dbDir = path.dirname(config.dbPath);
if (!fs.existsSync(dbDir)) {
  fs.mkdirSync(dbDir, { recursive: true });
}

const db = new Database(config.dbPath);
db.pragma('journal_mode = WAL');
db.pragma('foreign_keys = ON');

const migrations = `
CREATE TABLE IF NOT EXISTS admins (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS news (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  body TEXT NOT NULL,
  published_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS reports (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  vin TEXT NOT NULL,
  registration_number TEXT,
  workshop_name TEXT,
  workshop_id INTEGER,
  mileage_km INTEGER,
  first_registration_date TEXT,
  status TEXT DEFAULT 'W trakcie',
  approval_status TEXT DEFAULT 'pending',
  summary TEXT,
  moderation_note TEXT,
  moderated_by TEXT,
  moderated_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (workshop_id) REFERENCES workshops(id)
);

CREATE TABLE IF NOT EXISTS media (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  report_id INTEGER,
  file_name TEXT NOT NULL,
  file_path TEXT NOT NULL,
  mime_type TEXT NOT NULL,
  size INTEGER NOT NULL,
  uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (report_id) REFERENCES reports(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS settings (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS audit_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  type TEXT NOT NULL,
  message TEXT NOT NULL,
  actor_email TEXT,
  payload TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS workshops (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  address TEXT,
  city TEXT,
  phone TEXT,
  email TEXT,
  status TEXT DEFAULT 'active',
  notes TEXT,
  subscription_amount REAL,
  subscription_start_date TEXT,
  subscription_initial_amount REAL,
  subscription_initial_note TEXT,
  billing_email TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS workshop_users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  workshop_id INTEGER NOT NULL,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role TEXT DEFAULT 'workshop',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (workshop_id) REFERENCES workshops(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS workshop_billing (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  workshop_id INTEGER NOT NULL,
  month TEXT NOT NULL,
  amount REAL,
  invoice_number TEXT,
  status TEXT DEFAULT 'unpaid',
  note TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (workshop_id) REFERENCES workshops(id) ON DELETE CASCADE
);
`;

db.exec(migrations);

const ensureReportWorkshopRelation = () => {
  const columns = db.prepare('PRAGMA table_info(reports)').all();
  const hasWorkshopId = columns.some((column) => column.name === 'workshop_id');
  if (!hasWorkshopId) {
    db.exec('ALTER TABLE reports ADD COLUMN workshop_id INTEGER REFERENCES workshops(id)');
  }
};

ensureReportWorkshopRelation();

const ensureWorkshopAdditionalColumns = () => {
  const columns = db.prepare('PRAGMA table_info(workshops)').all();
  const hasColumn = (name) => columns.some((column) => column.name === name);
  const addColumn = (name, type) => {
    if (!hasColumn(name)) {
      db.exec(`ALTER TABLE workshops ADD COLUMN ${name} ${type}`);
    }
  };

  addColumn('subscription_amount', 'REAL');
  addColumn('subscription_start_date', 'TEXT');
  addColumn('subscription_initial_amount', 'REAL');
  addColumn('subscription_initial_note', 'TEXT');
  addColumn('billing_email', 'TEXT');
};

ensureWorkshopAdditionalColumns();

export { db };

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\src\index.js
==========================================
import app from './app.js';
import { config } from './config.js';

app.listen(config.port, () => {
  console.log(`Server running on http://localhost:${config.port}`);
});

==========================================
PLIK: C:\Users\brons\Desktop\strona\server\package.json
==========================================
{
  "name": "warsztat-backend",
  "version": "1.0.0",
  "description": "API backend for Warsztat+ platform",
  "main": "src/index.js",
  "type": "module",
  "scripts": {
    "dev": "nodemon src/index.js",
    "start": "node src/index.js"
  },
  "dependencies": {
    "bcrypt": "^5.1.1",
    "better-sqlite3": "^12.5.0",
    "cors": "^2.8.5",
    "dotenv": "^16.4.7",
    "express": "^4.19.2",
    "jsonwebtoken": "^9.0.2",
    "morgan": "^1.10.0",
    "multer": "^1.4.5-lts.1",
    "zod": "^3.22.4"
  },
  "devDependencies": {
    "lite-server": "^2.6.1",
    "nodemon": "^3.1.0"
  }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\index.html
==========================================
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Warsztat+ to cyfrowy dziennik napraw, transparentna historia VIN i wygodny panel dla warsztatĂłw, flot oraz kierowcĂłw.">
    <title>Warsztat+ | Cyfrowy serwis i historia VIN</title>
    <link rel="stylesheet" href="css/base/core.css">
    <link rel="stylesheet" href="css/landing/page.css">
</head>
<body class="site-body">
    <header class="site-header" id="top">
        <div class="site-header__brand">
            <a class="site-header__logo" href="#top">Warsztat<span class="site-header__logo--accent">+</span></a>
            <p class="site-header__tagline">Cyfrowa dokumentacja napraw, VIN w czasie rzeczywistym</p>
        </div>
        <button class="site-nav__toggle" aria-label="PrzeĹ‚Ä…cz nawigacjÄ™" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <nav class="site-nav" aria-label="GĹ‚Ăłwna nawigacja">
            <a class="site-nav__link" href="#vin">Historia VIN</a>
            <a class="site-nav__link" href="#features">Funkcje</a>
            <a class="site-nav__link" href="#workflow">Proces</a>
            <a class="site-nav__link" href="#insights">Ciekawostki</a>
            <a class="site-nav__cta" href="#kontakt">Skontaktuj siÄ™</a>
        </nav>
    </header>

    <main>
           
        <section class="hero" aria-labelledby="hero-title">
            <div class="hero__content">
                <p class="hero__eyebrow">Platforma dla warsztatĂłw i flot</p>
                <h1 id="hero-title">Cyfrowy serwis, ktĂłry kierowcy polecajÄ… znajomym</h1>
                <p class="hero__lead">Warsztat+ Ĺ‚Ä…czy raportowanie napraw, moderacjÄ™ VIN i komunikacjÄ™ z klientem w jednym, lekko dziaĹ‚ajÄ…cym panelu. KaĹĽda wizyta dostaje historiÄ™, ktĂłrej nie da siÄ™ zgubiÄ‡ w segregatorze.</p>
                <div class="hero__actions">
                    <a class="btn btn--primary" href="#vin">SprawdĹş historiÄ™ VIN</a>
                    <a class="btn btn--ghost" href="#features">Zobacz korzyĹ›ci</a>
                </div>
                <p class="hero__note">Warsztat+ raportuje Ĺ›rednio 64 naprawy tygodniowo i skraca o 43% czas oddzwaniania do klientĂłw.</p>
            </div>
            <div class="hero__stats" aria-label="Kluczowe wskaĹşniki">
                <div>
                    <strong>15 min</strong>
                    <span>Ĺ›redni czas dodania raportu</span>
                </div>
                <div>
                    <strong>3Ă—</strong>
                    <span>mniej telefonĂłw o status</span>
                </div>
                <div>
                    <strong>87%</strong>
                    <span>klientĂłw wraca po kolejnÄ… usĹ‚ugÄ™</span>
                </div>
            </div>
        </section>

        <section id="vin" class="section section--highlight" aria-labelledby="vin-title">
            <div class="section__header">
                <p class="section__eyebrow">WĹ‚aĹ›ciciele pojazdĂłw</p>
                <h2 id="vin-title">SprawdĹş historiÄ™ napraw po numerze VIN</h2>
                <p>KaĹĽde auto zostawia cyfrowy Ĺ›lad. Warsztat+ Ĺ‚Ä…czy raporty z ponad 6 000 warsztatĂłw i pozwala kierowcy odczytaÄ‡ historiÄ™ po samym VIN-ie.</p>
            </div>
            <form id="vin-form" class="vin-form" novalidate>
                <label class="visually-hidden" for="vin-input">Numer VIN</label>
                <input id="vin-input" name="vin" maxlength="17" minlength="11" autocomplete="off" placeholder="WprowadĹş numer VIN" required>
                <button class="btn btn--primary" type="submit">Wyszukaj</button>
            </form>
            <div id="vin-result" class="vin-result" aria-live="polite"></div>
            <p class="vin__hint">Tip: Polskie auto spÄ™dza Ĺ›rednio 10% ĹĽycia w serwisie. Warto mieÄ‡ tÄ™ historiÄ™ pod rÄ™kÄ….</p>
        </section>

        <section id="features" class="section" aria-labelledby="features-title">
            <div class="section__header">
                <p class="section__eyebrow">Dla zespoĹ‚Ăłw serwisowych</p>
                <h2 id="features-title">Profesjonalne narzÄ™dzia dla warsztatu</h2>
                <p>ZebraliĹ›my najczÄ™stsze potrzeby mechanikĂłw, doradcĂłw serwisowych i fleet managerĂłw. Efekt? Panel, ktĂłry przyspiesza kaĹĽdy etap wizyty.</p>
            </div>
            <div class="card-grid">
                <article class="card">
                    <h3>Raporty z warsztatu</h3>
                    <p>Dodawaj zdjÄ™cia, przebieg, notatki i statusy w jednym formularzu. Panel przypomina o brakujÄ…cych wpisach.</p>
                </article>
                <article class="card">
                    <h3>Transparentny VIN</h3>
                    <p>Klient wpisuje 17 znakĂłw i widzi peĹ‚nÄ… historiÄ™. To naturalna referencja â€“ 63% kierowcĂłw wysyĹ‚a link znajomym.</p>
                </article>
                <article class="card">
                    <h3>Logi i bezpieczeĹ„stwo</h3>
                    <p>Audyt wĹ‚Ä…cza siÄ™ automatycznie. KaĹĽda zmiana statusu zostawia Ĺ›lad wraz z kontem administratora.</p>
                </article>
                <article class="card">
                    <h3>GotowoĹ›Ä‡ mobilna</h3>
                    <p>Interface skaluje siÄ™ od telefonu na hali po duĹĽy ekran doradcy. Zero pinch-to-zoom, czyste CTA.</p>
                </article>
            </div>
        </section>

        <section id="workflow" class="section section--alt" aria-labelledby="workflow-title">
            <div class="section__header">
                <p class="section__eyebrow">Jak dziaĹ‚amy</p>
                <h2 id="workflow-title">Proces wdroĹĽenia w trzech krokach</h2>
            </div>
            <ol class="steps">
                <li>
                    <h3>1. Aktywacja konta</h3>
                    <p>Dodaj warsztat na podstawie NIP i e-maila. System automatycznie przypisze licencjÄ™ i wyĹ›le zaproszenie.</p>
                </li>
                <li>
                    <h3>2. Raportowanie</h3>
                    <p>Mechanik, doradca i administrator korzystajÄ… z tych samych statusĂłw. KaĹĽdy update trafia od razu do klienta.</p>
                </li>
                <li>
                    <h3>3. DostÄ™p klienta</h3>
                    <p>Kierowca wpisuje VIN i dostaje przejrzystÄ… kartÄ™ napraw: przebieg, daty, zdjÄ™cia, rekomendacje.</p>
                </li>
            </ol>
        </section>

        <section id="insights" class="section" aria-labelledby="insights-title">
            <div class="section__header">
                <p class="section__eyebrow">Ciekawostki z hali serwisowej</p>
                <h2 id="insights-title">Kierowcy kochajÄ… dane, warsztaty kochajÄ… porzÄ…dek</h2>
                <p>WybraliĹ›my kilka liczb z tysiÄ™cy raportĂłw Warsztat+. To one pokazujÄ…, dlaczego cyfrowa dokumentacja to must-have w 2025 roku.</p>
            </div>
            <div class="insights-grid">
                <article class="insight">
                    <span class="insight__value">52%</span>
                    <p class="insight__text">tyle zgĹ‚oszeĹ„ dotyczy elektryki i infotainmentu. Dobre zdjÄ™cie moduĹ‚u CAN oszczÄ™dza dwie wiadomoĹ›ci.</p>
                </article>
                <article class="insight">
                    <span class="insight__value">31Â°C</span>
                    <p class="insight__text">tyle potrafi mieÄ‡ asfalt w lipcu. Dlatego VIN check na telefonie musi byÄ‡ czytelny w sĹ‚oĹ„cu.</p>
                </article>
                <article class="insight">
                    <span class="insight__value">7,4 l/100 km</span>
                    <p class="insight__text">Ĺ›rednie spalanie aut flotowych w naszej bazie. Raport z serwisu to teĹĽ okazja, by dorzuciÄ‡ tip o eco drivingu.</p>
                </article>
                <article class="insight">
                    <span class="insight__value">24 h</span>
                    <p class="insight__text">tyle wynosi SLA na odpowiedĹş do klienta w najlepszych warsztatach. Automatyczne powiadomienia pomagajÄ… dotrzymaÄ‡ sĹ‚owa.</p>
                </article>
            </div>
        </section>

        <section id="kontakt" class="section section--highlight cta" aria-labelledby="cta-title">
            <div class="cta__content">
                <p class="section__eyebrow">Masz pytania?</p>
                <h2 id="cta-title">Napisz do nas i zobacz demo</h2>
                <p>PodrzuÄ‡ nam VIN, case serwisowy lub wyzwanie Twojej sieci warsztatĂłw. Odezwij siÄ™, zanim kolejny klient zapyta o status naprawy.</p>
            </div>
            <div class="cta__actions">
                <a class="btn btn--secondary" href="mailto:kontakt@warsztatplus.pl">kontakt@warsztatplus.pl</a>
                <a class="btn btn--ghost" href="login.html">PrzejdĹş do panelu</a>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <p>&copy; 2025 Warsztat+. Cyfrowy dziennik napraw i VIN.</p>
        <a class="ghost-link" href="login.html" aria-label="PrzejdĹş do panelu logowania">Panel administracyjny</a>
    </footer>

    <script src="js/shared/api.js" defer></script>
    <script src="js/landing/vinForm.js" defer></script>
    <script src="js/landing/navToggle.js" defer></script>
</body>
</html>

==========================================
PLIK: C:\Users\brons\Desktop\strona\login.html
==========================================
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warsztat+ | Logowanie</title>
    <link rel="stylesheet" href="css/base/core.css">
    <link rel="stylesheet" href="css/auth/page.css">
</head>
<body class="auth-body">
    <main class="auth" aria-labelledby="auth-title">
        <a class="ghost-link auth__home-link" href="index.html#top">&#8592; Strona glowna</a>
        <header class="auth__intro">
            <p class="auth__eyebrow">Strefa zabezpieczona</p>
            <h1 id="auth-title">Zaloguj sie do Warsztat+</h1>
              <p>Wpisz adres e-mail administratora (domyslnie <code>admin@warsztat.pl</code>) oraz haslo ustawione w pliku <code>.env</code>. Po poprawnym logowaniu przekierujemy Cie do panelu.</p>
        </header>

        <form id="unified-login-form" class="auth-form" novalidate>
            <label>
                    Adres e-mail
                    <input type="email" name="identifier" autocomplete="username" required>
            </label>
            <label>
                Haslo
                <input type="password" name="password" autocomplete="current-password" required>
            </label>
            <button class="btn btn--primary" type="submit">Zaloguj</button>
        </form>
        <p class="auth-card__feedback" data-feedback="login" aria-live="polite"></p>
    </main>

    <script src="js/shared/api.js"></script>
    <script src="js/shared/session.js"></script>
    <script src="js/auth/login.js"></script>
</body>
</html>

==========================================
PLIK: C:\Users\brons\Desktop\strona\package.json
==========================================
{
  "name": "czysta-strona",
  "version": "1.0.0",
  "description": "This project is a simple one-page application that serves as a template for creating a single-page website. It includes basic sections such as a header, content area, and footer.",
  "main": "index.js",
  "scripts": {
    "start": "npm run serve",
    "serve": "lite-server",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/bronek312/warsztat.git"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "module",
  "bugs": {
    "url": "https://github.com/bronek312/warsztat/issues"
  },
  "homepage": "https://github.com/bronek312/warsztat#readme",
  "devDependencies": {
    "lite-server": "^2.6.1"
  }
}

==========================================
PLIK: C:\Users\brons\Desktop\strona\panel-warsztatu.html
==========================================
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Warsztatu â€˘ Warsztat+</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/panel-warsztatu.css"> <!-- Nowy plik CSS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="icon" href="data:,">
</head>
<body>

  <nav class="sidebar">
    <h2>Warsztat+</h2>
    <a data-target="dodaj" class="active"><i class="fas fa-plus-circle"></i> <span>Dodaj raport</span></a>
    <a data-target="moje"><i class="fas fa-list"></i> <span>Moje raporty</span></a>
    <a data-target="czesci"><i class="fas fa-tools"></i> <span>ZamĂłw czÄ™Ĺ›ci</span></a>
    <a data-target="finanse"><i class="fas fa-file-invoice-dollar"></i> <span>Faktury</span></a>
    <a data-target="dane"><i class="fas fa-user-cog"></i> <span>Moje dane</span></a>
    <div style="margin-top: auto; padding: 1rem; width: 100%;">
      <div id="workshop-name" style="font-weight:600; font-size:0.9rem; margin-bottom:0.5rem;">Ĺadowanie...</div>
      <button id="logout-btn" class="btn-small" style="background:var(--d); width: 100%;"><i class="fas fa-sign-out-alt"></i> Wyloguj</button>
    </div>
  </nav>

  <main class="main">
    <div id="auth-error"><strong>Uwaga:</strong> Nie jesteĹ› zalogowany. <a href="login.html">Kliknij tutaj</a>.</div>

    <!-- 1. DODAJ RAPORT -->
    <div id="dodaj" class="content active">
      <div class="card">
        <h1 id="form-title">Nowy raport serwisowy</h1>
        <div id="auto-fill-banner" class="auto-fill-banner">
            <i class="fas fa-magic"></i>
            <div><strong>Dane uzupeĹ‚nione automatycznie.</strong><br>System rozpoznaĹ‚ VIN. Pola sÄ… zablokowane dla spĂłjnoĹ›ci.</div>
        </div>
        <form id="report-form">
            <input type="hidden" id="edit-report-id" value="">
            <div class="form-grid">
                <div class="form-group">
                    <label>Numer VIN *</label>
                    <div class="input-wrapper">
                        <input type="text" id="vin" placeholder="XXXXXXXXXXXXXXXXX" maxlength="17" required style="text-transform:uppercase; font-family: monospace; letter-spacing: 1px;">
                        <i class="fas fa-search input-icon"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Numer rejestracyjny *</label>
                    <div class="input-wrapper"><input type="text" id="plate" placeholder="WPR 12345" required style="text-transform:uppercase;"></div>
                </div>
                <div class="form-group">
                    <label>Marka *</label>
                    <div class="input-wrapper">
                        <input type="text" id="make" required>
                        <i class="fas fa-lock input-icon lock" style="display:none"></i>
                    </div>
                    <i class="fas fa-info-circle info-tooltip" data-tooltip="Pobrane z bazy VIN" style="display:none"></i>
                </div>
                <div class="form-group">
                    <label>Model *</label>
                    <div class="input-wrapper">
                        <input type="text" id="model" required>
                        <i class="fas fa-lock input-icon lock" style="display:none"></i>
                    </div>
                    <i class="fas fa-info-circle info-tooltip" data-tooltip="Pobrane z bazy VIN" style="display:none"></i>
                </div>
                <div class="form-group">
                    <label>Przebieg (km) *</label>
                    <div class="input-wrapper"><input type="number" id="mileage" min="0" required></div>
                </div>
                <div class="form-group">
                    <label>Data pierwszej rejestracji</label>
                    <div class="input-wrapper">
                        <input type="date" id="first-reg-date">
                        <i class="fas fa-lock input-icon lock" style="display:none"></i>
                    </div>
                    <i class="fas fa-info-circle info-tooltip" data-tooltip="Pobrane z bazy VIN" style="display:none"></i>
                </div>
                <div class="form-group full-width">
                    <label>Opis wykonanych prac *</label>
                    <textarea id="description" rows="5" required></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn-big"><i class="fas fa-paper-plane"></i> Zapisz raport</button>
                <button type="button" id="cancel-edit-btn" class="btn-big" style="background:#9ca3af; display:none;">Anuluj</button>
            </div>
        </form>
      </div>
    </div>

    <!-- 2. MOJE RAPORTY -->
    <div id="moje" class="content">
      <div class="card">
        <h1>Baza raportĂłw</h1>
        <div class="filters">
            <div class="filter-tabs" id="report-tabs">
                <div class="filter-tab active" data-filter="all">Wszystkie</div>
                <div class="filter-tab" data-filter="approved">Zatwierdzone</div>
                <div class="filter-tab" data-filter="pending">OczekujÄ…ce</div>
                <div class="filter-tab" data-filter="rejected">Do poprawy</div>
            </div>
            <div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-reports" placeholder="Szukaj..."></div>
        </div>
        <div id="reports-container"><p style="text-align:center; padding: 2rem;">Ĺadowanie...</p></div>
      </div>
    </div>

    <!-- 3. CZÄĹšCI -->
    <div id="czesci" class="content">
      <div class="card"><h1>ZamĂłw CzÄ™Ĺ›ci</h1><div style="display:flex; gap:10px; margin-bottom: 20px;"><input type="text" id="parts-search-input" placeholder="Model..." class="full-input"><button id="btn-search-parts" class="btn-big">Szukaj</button></div><div id="parts-results-container"></div></div>
    </div>

    <!-- 4. FINANSE -->
    <div id="finanse" class="content">
        <div class="card mb-4">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>Finanse i Faktury</h1>
                <!-- UsuniÄ™to onclick z HTML, jest teraz w invoices.js -->
                <button class="btn-big">+ Nowa Faktura</button>
            </div>
            <div style="display:flex; gap:20px; margin: 20px 0;">
                <div style="flex:1; background:#eff6ff; padding:15px; border-radius:10px; border-left:5px solid var(--p);">
                    <small>PrzychĂłd Netto (MiesiÄ…c)</small>
                    <div id="stats-netto" style="font-size:1.5rem; font-weight:bold;">0.00 PLN</div>
                </div>
                <div style="flex:1; background:#ecfdf5; padding:15px; border-radius:10px; border-left:5px solid var(--s);">
                    <small>PrzychĂłd Brutto (MiesiÄ…c)</small>
                    <div id="stats-brutto" style="font-size:1.5rem; font-weight:bold;">0.00 PLN</div>
                </div>
            </div>
            <div id="invoices-list">Ĺadowanie faktur...</div>
        </div>
    </div>

    <div id="dane" class="content"><div class="card"><h1>Moje dane</h1><p><strong>Nazwa:</strong> <span id="w-name">-</span></p><p><strong>Email:</strong> <span id="w-email">-</span></p></div></div>
    <div id="kontakt" class="content"><div class="card"><h1>Kontakt</h1><p>Formularz kontaktowy.</p></div></div>
  </main>

  <!-- MODAL: PODGLÄ„D RAPORTU -->
  <div id="preview-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;padding:20px;">
    <div style="background:white;padding:2rem;border-radius:12px;width:100%;max-width:600px;">
        <h2 style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top:0;">SzczegĂłĹ‚y raportu</h2>
        <div id="preview-content" style="line-height: 1.6;"></div>
        <div style="margin-top: 20px; text-align: right;"><button class="btn-big" style="background:#6b7280">Zamknij</button></div>
    </div>
  </div>

  <!-- MODAL: FAKTURA -->
  <div id="invoice-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;overflow-y:auto;padding:20px;">
    <div style="background:white;padding:2rem;border-radius:12px;width:100%;max-width:900px; max-height:95vh; overflow-y:auto;">
      <h2 style="border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">Wystaw NowÄ… FakturÄ™</h2>
      <form id="invoice-form">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
            <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                <h3>Sprzedawca</h3>
                <input type="text" id="inv-seller-name" placeholder="Nazwa Warsztatu" class="full-input" required>
                <input type="text" id="inv-seller-nip" placeholder="NIP" class="full-input" required>
                <input type="text" id="inv-seller-address" placeholder="Adres" class="full-input" required>
            </div>
            <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                <h3>Nabywca</h3>
                <input type="text" id="inv-client-name" placeholder="Klient" class="full-input" required>
                <input type="text" id="inv-client-nip" placeholder="NIP (opcjonalnie)" class="full-input">
                <input type="text" id="inv-client-address" placeholder="Adres" class="full-input" required>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <div style="flex:1"><label>Numer Faktury</label><input type="text" id="inv-number" class="full-input" readonly style="background:#eee;"></div>
            <div style="flex:1"><label>Data wystawienia</label><input type="date" id="inv-date" class="full-input" required></div>
            <div style="flex:1"><label>Termin pĹ‚atnoĹ›ci</label><input type="date" id="inv-due" class="full-input" required></div>
        </div>
        <table style="width:100%; margin-bottom:20px;">
            <thead style="background:#eee;"><tr><th>Nazwa</th><th>IloĹ›Ä‡</th><th>Netto</th><th>VAT%</th><th>Brutto</th><th></th></tr></thead>
            <tbody id="inv-items-body"></tbody>
        </table>
        <button type="button" id="add-inv-item-btn" class="btn-small" style="background:#6b7280;">+ Dodaj pozycjÄ™</button>
        <div style="text-align:right; margin-top:20px; font-size:1.2rem;">
            <p>Netto: <strong id="inv-sum-net">0.00</strong> PLN | VAT: <strong id="inv-sum-vat">0.00</strong> PLN</p>
            <p style="font-size:1.5rem; color:var(--p);">Do zapĹ‚aty: <strong id="inv-sum-gross">0.00</strong> PLN</p>
        </div>
        <div style="display:flex; gap:10px; margin-top:30px;">
            <button type="submit" class="btn-big" style="flex:1;">ZatwierdĹş i Generuj</button>
            <button type="button" class="btn-big" style="flex:1; background:#ddd; color:#333;">Anuluj</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SZABLON PDF -->
  <div id="invoice-template" style="display:none;"><div style="padding:40px; font-family:sans-serif;">
        <h1 style="color:#2563eb;">FAKTURA VAT <span id="pdf-number" style="color:#333; font-size:0.6em;"></span></h1>
        <div style="display:flex; justify-content:space-between; margin-top:40px;">
            <div><strong>Sprzedawca:</strong><br><span id="pdf-seller-name"></span><br><span id="pdf-seller-address"></span><br>NIP: <span id="pdf-seller-nip"></span></div>
            <div style="text-align:right;"><strong>Nabywca:</strong><br><span id="pdf-client-name"></span><br><span id="pdf-client-address"></span><br>NIP: <span id="pdf-client-nip"></span></div>
        </div>
        <table style="width:100%; border-collapse:collapse; margin-top:40px;">
            <thead style="background:#f3f4f6;"><tr><th style="padding:10px; text-align:left;">Nazwa</th><th style="padding:10px; text-align:right;">IloĹ›Ä‡</th><th style="padding:10px; text-align:right;">Netto</th><th style="padding:10px; text-align:right;">VAT</th><th style="padding:10px; text-align:right;">Brutto</th></tr></thead>
            <tbody id="pdf-items"></tbody>
        </table>
        <h3 style="text-align:right; margin-top:30px; color:#2563eb;">DO ZAPĹATY: <span id="pdf-sum-gross"></span> PLN</h3>
  </div></div>

  <!-- GĹĂ“WNY SKRYPT -->
  <script type="module" src="js/panel-warsztatu/main.js"></script>
</body>
</html>

==========================================
PLIK: C:\Users\brons\Desktop\strona\panel.html
==========================================
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warsztat+ | Panel administratora</title>
    <link rel="stylesheet" href="css/base/core.css">
    <link rel="stylesheet" href="css/panel/page.css">
</head>
<body class="panel-body">
    <div class="panel-layout">
        <aside class="panel-sidebar">
            <div class="panel-sidebar__brand">Warsztat<span>+</span></div>
            <nav class="panel-nav" aria-label="Nawigacja panelu">
                <button class="panel-nav__link is-active" data-panel-target="overview">Przeglad</button>
                <button class="panel-nav__link" data-panel-target="workshops">Warsztaty</button>
                <button class="panel-nav__link" data-panel-target="reports">Raporty</button>
                <button class="panel-nav__link" data-panel-target="settings">Ustawienia</button>
                <button class="panel-nav__link" data-panel-target="logs">Logi</button>
            </nav>
        </aside>

        <div class="panel-content">
            <header class="panel-header">
                <div class="panel-header__info">
                    <span class="panel-header__subtitle" id="panel-role"></span>
                    <h1 id="panel-username"></h1>
                </div>
                <button class="btn btn--ghost" id="logout-btn">Wyloguj</button>
            </header>

            <main class="panel-main">
                <section class="panel-view is-active" data-panel="overview">
                    <div class="panel-section panel-section--summary">
                        <header class="panel-section__header">
                            <div>
                                <p class="panel-section__eyebrow">Stan systemu</p>
                                <h2>Podsumowanie</h2>
                            </div>
                            <p class="panel-section__hint">Dane aktualizuja sie wraz z dzialaniami administratora.</p>
                        </header>
                        <div class="panel-grid panel-grid--summary" id="overview-metrics"></div>
                    </div>
                    <div class="panel-grid panel-grid--overview-cards">
                        <div class="panel-card panel-card--logs">
                            <h2>Ostatnie logi</h2>
                            <ul class="panel-log" id="overview-logs"></ul>
                        </div>
                        <div class="panel-card panel-card--surface panel-card--audit">
                            <h2>Ostatnie akcje administratorow</h2>
                            <ul class="panel-log panel-log--audit" id="admin-actions"></ul>
                        </div>
                    </div>
                </section>

                <section class="panel-view" data-panel="workshops">
                    <div class="panel-section">
                        <div class="panel-card panel-card--surface panel-card--workshops">
                            <div class="panel-toolbar panel-toolbar--split" id="workshop-toolbar-list">
                                <div>
                                    <p class="panel-section__eyebrow">Baza warsztatow</p>
                                    <h2>Warsztaty</h2>
                                </div>
                                <div class="panel-toolbar__actions">
                                    <button class="btn btn--secondary" type="button" id="workshop-add-btn">Dodaj warsztat</button>
                                </div>
                            </div>
                            <!-- UsuniÄ™to dolny przycisk Powrot do listy, zostaje tylko gĂłrny -->
                            <div class="workshop-browser" id="workshop-browser-list">
                                <form id="workshop-filter-form" class="panel-filters panel-filters--inline panel-filters--surface" novalidate>
                                    <label>
                                        Szukaj po nazwie lub e-mailu
                                        <input type="search" name="query" placeholder="np. Warsztat+ Centralny">
                                    </label>
                                    <label>
                                        Status
                                        <select name="status">
                                            <option value="all">Wszystkie</option>
                                            <option value="active">Aktywne</option>
                                            <option value="inactive">Nieaktywne</option>
                                            <option value="notice">W okresie wypowiedzenia</option>
                                            <option value="deactivated">Dezaktywowane</option>
                                        </select>
                                    </label>
                                    <div class="panel-filters__actions">
                                        <button class="btn btn--ghost" type="button" id="workshop-filter-reset">Wyczysc</button>
                                        <button class="btn btn--secondary" type="submit">Filtruj</button>
                                    </div>
                                </form>
                                <div class="panel-list panel-list--grid" id="workshop-list"></div>
                            </div>

                            <div class="workshop-browser workshop-browser--detail" id="workshop-browser-detail" hidden>
                                <div class="workshop-detail-shell">
                                    <div class="panel-back-btn-container panel-back-btn--absolute">
                                        <button class="btn btn--ghost panel-back-btn" type="button" id="workshop-list-back">&larr; PowrĂłt do listy</button>
                                    </div>
                                        <div class="workshop-detail-shell__toolbar">
                                            <div>
                                                <p class="panel-section__eyebrow" id="workshop-detail-eyebrow">Profil warsztatu</p>
                                                <h3 id="workshop-detail-title">Szczegoly warsztatu</h3>
                                            </div>
                                            <button class="btn btn--danger" id="workshop-deactivate-btn">Dezaktywuj konto</button>
                                        </div>
                                    <p class="panel-feedback" id="workshop-detail-feedback" aria-live="polite"></p>
                                        <div class="workshop-detail-shell__layout">
                                            <div class="workshop-tabs">
                                                <!-- UsuniÄ™to pole specjalizacji -->
                                                <nav class="workshop-tabs__nav" aria-label="ZakĹ‚adki szczegĂłĹ‚Ăłw warsztatu">
                                                    <button class="workshop-tab active" data-tab="activity">AktywnoĹ›Ä‡ / Raporty</button>
                                                    <button class="workshop-tab" data-tab="logs">Logi i notatki</button>
                                                    <button class="workshop-tab" data-tab="reports">Raporty</button>
                                                    <button class="workshop-tab" data-tab="contacts">Kontakt & osoby</button>
                                                    <button class="workshop-tab" data-tab="settings">Ustawienia</button>
                                                    <button class="workshop-tab" data-tab="tickets">ZgĹ‚oszenia / bilety</button>
                                                </nav>
                                                <div class="workshop-tabs__content">
                                                    <section class="workshop-tab-content" id="tab-activity">
                                                        <div id="workshop-detail-overview" class="workshop-detail"></div>
                                                        <section class="workshop-detail__section">
                                                            <header>
                                                                <p class="panel-section__eyebrow">Abonament</p>
                                                                <h4>Stan umowy</h4>
                                                            </header>
                                                            <div id="workshop-detail-subscription" class="workshop-detail__grid"></div>
                                                        </section>
                                                        <!-- UsuniÄ™to podsekcjÄ™ Raporty warsztatu -->
                                                    </section>
                                                    <section class="workshop-tab-content" id="tab-logs" style="display:none">
                                                        <header>
                                                            <p class="panel-section__eyebrow">Logi i notatki</p>
                                                            <h4>Ostatnie dziaĹ‚ania i notatnik</h4>
                                                        </header>
                                                        <ul id="workshop-detail-logs">(Tu pojawi siÄ™ lista logĂłw...)</ul>
                                                        <textarea id="workshop-detail-notepad" class="workshop-notepad" placeholder="Notatki wewnÄ™trzne (widoczne tylko dla adminĂłw)"></textarea>
                                                    </section>
                                                    <section class="workshop-tab-content" id="tab-reports" style="display:none">
                                                        <header>
                                                            <p class="panel-section__eyebrow">Raporty</p>
                                                            <h4>Wszystkie raporty warsztatu</h4>
                                                        </header>
                                                        <form id="workshop-reports-filter-form" class="panel-filters panel-filters--inline" novalidate>
                                                            <label>
                                                                Status
                                                                <select name="status">
                                                                    <option value="all">Wszystkie</option>
                                                                    <option value="pending">OczekujÄ…ce</option>
                                                                    <option value="approved">Zatwierdzone</option>
                                                                    <option value="rejected">Odrzucone</option>
                                                                </select>
                                                            </label>
                                                            <label>
                                                                Data
                                                                <input type="date" name="date">
                                                            </label>
                                                            <label>
                                                                Typ naprawy
                                                                <input type="text" name="type" placeholder="np. mechanika, elektronika">
                                                            </label>
                                                            <div class="panel-filters__actions">
                                                                <button class="btn btn--secondary" type="submit">Filtruj</button>
                                                            </div>
                                                        </form>
                                                        <div id="workshop-reports-list">(Tu pojawi siÄ™ lista raportĂłw...)</div>
                                                    </section>
                                                    <section class="workshop-tab-content" id="tab-contacts" style="display:none">
                                                        <header>
                                                            <p class="panel-section__eyebrow">Kontakt & osoby</p>
                                                            <h4>UĹĽytkownicy konta warsztatu</h4>
                                                        </header>
                                                        <div id="workshop-detail-contacts">(Tu pojawi siÄ™ lista kontaktĂłw...)</div>
                                                    </section>
                                                    <section class="workshop-tab-content" id="tab-settings" style="display:none">
                                                        <header>
                                                            <p class="panel-section__eyebrow">Ustawienia</p>
                                                            <h4>Edycja danych warsztatu i integracje</h4>
                                                        </header>
                                                        <form id="workshop-settings-form" class="panel-form panel-form--stacked" novalidate>
                                                            <label>Nazwa warsztatu
                                                                <input type="text" name="name" required>
                                                            </label>
                                                            <label>Miasto
                                                                <input type="text" name="city">
                                                            </label>
                                                            <label>Adres
                                                                <input type="text" name="address">
                                                            </label>
                                                            <label>Telefon kontaktowy
                                                                <input type="tel" name="phone">
                                                            </label>
                                                            <label>Adres e-mail
                                                                <input type="email" name="email">
                                                            </label>
                                                            <label>E-mail do faktur
                                                                <input type="email" name="billingEmail">
                                                            </label>
                                                            <label>Cena abonamentu (PLN)
                                                                <input type="number" name="subscriptionAmount" min="0" step="0.01">
                                                            </label>
                                                            <label>DĹ‚ugoĹ›Ä‡ abonamentu (miesiÄ…ce)
                                                                <input type="number" name="subscriptionMonths" min="1">
                                                            </label>
                                                            <label>Data startu umowy
                                                                <input type="date" name="subscriptionStartDate">
                                                            </label>
                                                            <fieldset>
                                                                <legend>Opcje dodatkowe</legend>
                                                                <label><input type="checkbox" name="integrationSms"> Integracja SMS</label>
                                                                <label><input type="checkbox" name="integrationHurtownia"> Integracja z hurtowniÄ…</label>
                                                                <label><input type="checkbox" name="integrationAutodoc"> Integracja z Autodoc</label>
                                                            </fieldset>
                                                            <div class="panel-form__actions panel-form__actions--end">
                                                                <button class="btn btn--secondary" type="submit">Zapisz zmiany</button>
                                                            </div>
                                                        </form>
                                                    </section>
                                                    <section class="workshop-tab-content" id="tab-tickets" style="display:none">
                                                        <header>
                                                            <p class="panel-section__eyebrow">ZgĹ‚oszenia / bilety</p>
                                                            <h4>ObsĹ‚uga zgĹ‚oszeĹ„</h4>
                                                        </header>
                                                        <div id="workshop-detail-tickets">(Tu pojawiÄ… siÄ™ zgĹ‚oszenia...)</div>
                                                    </section>
                                                </div>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="panel-view" data-panel="reports">
                    <div class="panel-section panel-section--split">
                        <div class="panel-split">
                            <div class="panel-split__primary panel-card panel-card--surface">
                                <div class="panel-toolbar">
                                    <div>
                                        <p class="panel-section__eyebrow">Historia napraw</p>
                                        <h2>Raporty</h2>
                                    </div>
                                    <p class="panel-section__hint">Wybierz raport z listy, aby edytowac.</p>
                                </div>
                                <form id="report-filter-form" class="panel-filters panel-filters--inline" novalidate>
                                    <label>
                                        Szukaj po VIN
                                        <input type="search" name="vin" placeholder="np. WAUZZZ...">
                                    </label>
                                    <label>
                                        Numer rejestracyjny
                                        <input type="search" name="registration" placeholder="np. WPR 1234">
                                    </label>
                                    <label>
                                        Status weryfikacji
                                        <select name="approval">
                                            <option value="all">Wszystkie</option>
                                            <option value="pending">Oczekujace</option>
                                            <option value="approved">Zatwierdzone</option>
                                            <option value="rejected">Odrzucone</option>
                                        </select>
                                    </label>
                                    <div class="panel-filters__actions">
                                        <button class="btn btn--ghost" type="submit">Filtruj</button>
                                    </div>
                                </form>
                                <div class="panel-list" id="report-list"></div>
                            </div>
                            <aside class="panel-split__aside">
                                <div class="panel-card panel-card--aside">
                                    <p class="panel-section__eyebrow">Panel edycji</p>
                                    <h3>Edycja raportu</h3>
                                    <form id="report-edit-form" class="panel-form" novalidate>
                                        <input type="hidden" name="reportId">
                                        <label>
                                            Numer VIN
                                            <input type="text" name="vin" required>
                                        </label>
                                        <label>
                                            Numer rejestracyjny
                                            <input type="text" name="registrationNumber" placeholder="np. WPR 1234">
                                        </label>
                                            <div class="panel-form__meta panel-form__meta--two">
                                                <label>
                                                    Przebieg (km)
                                                <input type="number" name="mileageKm" min="0" step="1">
                                                </label>
                                                <label>
                                                    Data pierwszej rejestracji
                                                <input type="date" name="firstRegistrationDate">
                                                </label>
                                            </div>
                                        <label>
                                            Status weryfikacji
                                            <select name="approvalStatus" id="report-approval-select">
                                                <option value="pending">Oczekuje na akceptacje</option>
                                                <option value="approved">Zatwierdzony</option>
                                                <option value="rejected">Odrzucony</option>
                                            </select>
                                        </label>
                                        <label>
                                            Opis
                                            <textarea name="summary" rows="4" placeholder="Opis naprawy"></textarea>
                                        </label>
                                            <div class="panel-media-section">
                                                <p class="panel-media-section__title">Zalaczone pliki</p>
                                                <div id="report-media-gallery" class="panel-media-gallery panel-media-gallery--readonly">
                                                    <p class="panel-empty">Brak zalacznikow.</p>
                                                </div>
                                            </div>
                                        <label>
                                            Notatka dla warsztatu
                                            <textarea name="moderationNote" rows="2" placeholder="Powod odrzucenia lub uwagi dodatkowe"></textarea>
                                        </label>
                                        <div class="panel-form__actions">
                                            <button class="btn btn--secondary" type="submit">Zapisz zmiany</button>
                                        </div>
                                    </form>
                                    <p class="panel-feedback" id="report-feedback" aria-live="polite"></p>
                                </div>
                            </aside>
                        </div>
                    </div>
                </section>

                <section class="panel-view" data-panel="settings">
                    <div class="panel-section panel-section--narrow">
                        <div class="panel-card panel-card--form">
                            <header class="panel-section__header">
                                <div>
                                    <p class="panel-section__eyebrow">Konfiguracja</p>
                                    <h2>Ustawienia systemowe</h2>
                                </div>
                                <p class="panel-section__hint">Dotyczy nowych licencji oraz statusow w raportach.</p>
                            </header>
                            <form id="settings-form" class="panel-form panel-form--grid" novalidate>
                                <label>
                                    Dlugosc licencji (miesiace)
                                    <input type="number" name="licenseMonths" min="1" required>
                                </label>
                                <label>
                                    Statusy napraw (oddzielone przecinkiem)
                                    <textarea name="statusOptions" rows="3" placeholder="Przyjeta, W trakcie, Zakonczona"></textarea>
                                </label>
                                <div class="panel-form__actions panel-form__actions--end">
                                    <button class="btn btn--secondary" type="submit">Zapisz ustawienia</button>
                                </div>
                            </form>
                            <p class="panel-feedback" id="settings-feedback" aria-live="polite"></p>
                        </div>
                    </div>
                </section>

                <section class="panel-view" data-panel="logs">
                        <div class="panel-card">
                            <h2>Dziennik zdarzen</h2>
                            <ul class="panel-log panel-log--tall panel-log--audit" id="logs-full"></ul>
                            <button class="btn btn--ghost" id="logs-refresh-btn" type="button">Odswiez logi</button>
                        </div>
                </section>
                    <section class="panel-view panel-view--workshop" data-panel="workshop-home">
                        <div class="panel-section panel-section--summary">
                            <header class="panel-section__header">
                                <div>
                                    <p class="panel-section__eyebrow">Profil warsztatu</p>
                                    <h2>Twoje konto</h2>
                                </div>
                                <p class="panel-section__hint">Podsumowanie licencji i podstawowych danych kontaktowych.</p>
                            </header>
                            <div class="panel-card panel-card--surface panel-card--workshop">
                                <div id="workshop-details" class="workshop-summary"></div>
                            </div>
                        </div>
                        <div class="panel-card panel-card--surface">
                            <h2>Twoje raporty</h2>
                            <div class="panel-list" id="workshop-report-list"></div>
                        </div>
                        <div class="panel-card panel-card--surface">
                            <p class="panel-section__eyebrow">Nowy raport</p>
                            <h2>Dodaj raport serwisowy</h2>
                            <p class="panel-section__hint">Po wyslaniu raport trafi do administratora i oczekuje na akceptacje.</p>
                            <form id="workshop-report-form" class="panel-form" novalidate>
                                <label>
                                    Numer VIN
                                    <input type="text" name="vin" required>
                                </label>
                                <label>
                                    Numer rejestracyjny
                                    <input type="text" name="registrationNumber" required>
                                </label>
                                <label>
                                    Przebieg pojazdu (km)
                                    <input type="number" name="mileageKm" min="0" step="1" required>
                                </label>
                                <label>
                                    Data pierwszej rejestracji
                                    <input type="date" name="firstRegistrationDate" required>
                                </label>
                                <label>
                                    Opis naprawy
                                    <textarea name="summary" rows="3" placeholder="Opis wykonanych prac" required></textarea>
                                </label>
                                <label class="panel-upload">
                                    Zalacz zdjecia lub filmy
                                    <input type="file" name="mediaFiles" accept="image/*,video/*" multiple>
                                    <small>Maks. 5 plikow, po 5 MB kazdy.</small>
                                </label>
                                <ul class="panel-upload__list" id="workshop-media-preview"></ul>
                                <div class="panel-form__actions">
                                    <button class="btn btn--secondary" type="submit">Dodaj raport</button>
                                </div>
                            </form>
                            <p class="panel-feedback" id="workshop-report-feedback" aria-live="polite"></p>
                        </div>
                    </section>
            </main>
        </div>
    </div>

    <aside class="panel-drawer" id="metric-drawer" aria-hidden="true">
        <div class="panel-drawer__header">
            <div>
                <p class="panel-section__eyebrow" id="metric-drawer-eyebrow"></p>
                <h3 id="metric-drawer-title"></h3>
            </div>
            <button class="btn btn--ghost" type="button" id="metric-drawer-close">Zamknij</button>
        </div>
        <p class="panel-drawer__lead" id="metric-drawer-description"></p>
        <div id="metric-drawer-content" class="panel-drawer__content"></div>
    </aside>
    <div class="panel-drawer__backdrop" id="metric-drawer-backdrop" hidden></div>

    <aside class="panel-drawer panel-drawer--form" id="workshop-drawer" aria-hidden="true">
        <div class="panel-drawer__header">
            <div>
                <p class="panel-section__eyebrow" id="workshop-drawer-eyebrow">Nowy warsztat</p>
                <h3 id="workshop-drawer-title">Dodaj warsztat</h3>
            </div>
            <button class="btn btn--ghost" type="button" id="workshop-drawer-close">Zamknij</button>
        </div>
        
        <form id="create-workshop-form" class="panel-form panel-form--drawer" novalidate>
            
            <!-- NOWE POLE: NIP Z INTEGRACJÄ„ GUS -->
            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0; margin-bottom: 15px;">
                <label style="font-weight: bold; color: #166534;">
                    NIP (Automatyczne pobieranie danych)
                    <div style="position: relative; display: flex; align-items: center; gap: 10px;">
                        <input type="text" name="nip" id="workshop-nip" placeholder="Wpisz NIP i kliknij obok..." maxlength="10" style="font-weight: bold;">
                        <span id="gus-loading" style="display:none; color:#2563eb; white-space: nowrap;">
                            <i class="fas fa-spinner fa-spin"></i> Pobieram...
                        </span>
                    </div>
                    <small id="nip-feedback" style="color:#ef4444; display:none; margin-top:5px;"></small>
                </label>
            </div>
            <!-- KONIEC NOWEGO POLA -->

            <label>
                Nazwa warsztatu
                <input type="text" name="name" id="workshop-name" required>
            </label>
            
            <div style="display: flex; gap: 10px;">
                <label style="flex: 1;">
                    Kod pocztowy
                    <input type="text" name="zip" id="workshop-zip" placeholder="00-000">
                </label>
                <label style="flex: 2;">
                    Miasto
                    <input type="text" name="city" id="workshop-city" placeholder="np. KrakĂłw">
                </label>
            </div>

            <label>
                Adres (Ulica i numer)
                <input type="text" name="address" id="workshop-address" placeholder="np. ul. MechanikĂłw 12">
            </label>
            <label>
                Telefon kontaktowy
                <input type="tel" name="phone" placeholder="np. +48 123 456 789">
            </label>
            <label>
                Adres e-mail
                <input type="email" name="email" placeholder="np. biuro@warsztat.pl">
            </label>
            <label>
                E-mail do faktur
                <input type="email" name="billingEmail" placeholder="np. ksiÄ™gowoĹ›Ä‡@warsztat.pl">
                <small class="panel-form__hint">Opcjonalny adres do korespondencji rozliczeniowej.</small>
            </label>
            <label>
                E-mail logowania
                <input type="email" name="loginEmail" placeholder="np. konto@warsztat.pl" required>
            </label>
            <label>
                HasĹ‚o do panelu
                <input type="password" name="loginPassword" placeholder="Minimum 8 znakĂłw">
                <small class="panel-form__hint">Przy dodawaniu nowego warsztatu hasĹ‚o jest wymagane. Podczas edycji pozostaw puste, aby nie zmieniaÄ‡.</small>
            </label>
            <label>
                Status
                <select name="status">
                    <option value="active">Aktywny</option>
                    <option value="inactive">Nieaktywny</option>
                    <option value="notice">W okresie wypowiedzenia</option>
                    <option value="deactivated">Dezaktywowany</option>
                </select>
            </label>
            <label>
                Kwota abonamentu (PLN)
                <input type="number" name="subscriptionAmount" min="0" step="0.01" placeholder="np. 299">
            </label>
            <label>
                Data startu abonamentu
                <input type="date" name="subscriptionStartDate">
            </label>
            <label>
                Kwota startowa (proporcjonalna)
                <input type="number" name="subscriptionInitialAmount" min="0" step="0.01" placeholder="np. 149,50">
            </label>
            <label>
                Opis rozliczenia poczÄ…tkowego
                <input type="text" name="subscriptionInitialNote" placeholder="np. 15-31 stycznia">
            </label>
            <label>
                Notatki administracyjne
                <textarea name="notes" rows="3" placeholder="Uwagi widoczne tylko w panelu"></textarea>
            </label>
            <div class="panel-form__actions panel-form__actions--spread">
                <button class="btn btn--ghost" type="button" id="workshop-cancel-edit">Anuluj</button>
                <button class="btn btn--secondary" type="submit" data-workshop-form-submit>Dodaj warsztat</button>
            </div>
        </form>
        <p class="panel-feedback" id="workshop-feedback" aria-live="polite"></p>
    </aside>
    <div class="panel-drawer__backdrop" id="workshop-drawer-backdrop" hidden></div>

    <script src="js/shared/api.js"></script>
    <script src="js/shared/session.js"></script>
    <script src="js/panel/dashboard.js"></script>
</body>
</html>

